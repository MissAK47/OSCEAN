cmake_minimum_required(VERSION 3.17)

# ğŸš€ ç°ä»£åŒ–CMakeé…ç½® - æ— åå‘å…¼å®¹è´Ÿæ‹…
project(CrsService VERSION 1.0.0 LANGUAGES CXX)

message(STATUS "[CRS Service] ğŸš€ Configuring Modern CRS Service Module v1.0")

# ğŸ¯ C++17æ ‡å‡† + ç°ä»£åŒ–ä¼˜åŒ–ï¼ˆä¸ä¸»é¡¹ç›®ä¿æŒä¸€è‡´ï¼‰
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# === ğŸš€ é«˜æ€§èƒ½ç¼–è¯‘ä¼˜åŒ– ===
if(CMAKE_BUILD_TYPE STREQUAL "Release")
    set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG -march=native -mtune=native")
    # SIMDä¼˜åŒ–æ ‡å¿—
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -mavx2 -mfma")
    if(MSVC)
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /arch:AVX2")
    endif()
endif()

# è®¾ç½®CMakeç­–ç•¥
if(POLICY CMP0167)
    cmake_policy(SET CMP0167 NEW)
endif()

# === ğŸ”§ ä¿®å¤ä¾èµ–ä¼ é€’ - ä½¿ç”¨é¡¶å±‚é…ç½®çš„ä¾èµ– ===

# ğŸ¯ ä»é¡¶å±‚ç»§æ‰¿ä¾èµ–ï¼Œä¸é‡å¤æŸ¥æ‰¾
# PROJ, GDAL, Boost, spdlog ç­‰ä¾èµ–ç”±é¡¶å±‚CMakeLists.txtç®¡ç†

# éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦å·²åœ¨é¡¶å±‚æ‰¾åˆ°
if(NOT TARGET PROJ::proj)
    message(FATAL_ERROR "[CRS Service] âŒ PROJ::proj target not found. Please ensure PROJ is found in top-level CMakeLists.txt")
endif()

if(NOT TARGET GDAL::GDAL)
    message(FATAL_ERROR "[CRS Service] âŒ GDAL::GDAL target not found. Please ensure GDAL is found in top-level CMakeLists.txt")
endif()

if(NOT TARGET spdlog::spdlog)
    message(FATAL_ERROR "[CRS Service] âŒ spdlog::spdlog target not found. Please ensure spdlog is found in top-level CMakeLists.txt")
endif()

message(STATUS "[CRS Service] âœ… Using dependencies from top-level configuration")
message(STATUS "[CRS Service] âœ… PROJ target: PROJ::proj")
message(STATUS "[CRS Service] âœ… GDAL target: GDAL::GDAL")
message(STATUS "[CRS Service] âœ… spdlog target: spdlog::spdlog")

set(TARGET_NAME crs_service)

# === ç°ä»£åŒ–æºæ–‡ä»¶é…ç½® ===

set(CRS_SERVICE_SOURCES
    # æ ¸å¿ƒå®ç° - åªä¿ç•™ä¼˜åŒ–ç‰ˆæœ¬
    src/impl/optimized_crs_service_impl.cpp
    src/impl/transformation_cache_adapter.h
    src/impl/transformation_cache_impl.cpp
    
    # ğŸ”§ æ¶æ„ä¿®å¤ï¼šæ™ºèƒ½GDALç®¡ç†å™¨
    src/impl/gdal_manager.cpp
    
    # æœåŠ¡ç»„ä»¶
    src/crs_service_factory.cpp
    src/crs_transformer.cpp
    src/crs_inspector.cpp
    src/crs_parser.cpp
)

set(CRS_SERVICE_HEADERS
    # å…¬å…±æ¥å£
    include/core_services/crs/crs_service_factory.h
    include/core_services/crs/internal/crs_service_extended.h
    
    # ä¼˜åŒ–å®ç°
    src/impl/optimized_crs_service_impl.h
    src/impl/transformation_cache_adapter.h
    src/impl/transformation_cache.h
    src/impl/transformation_cache_pimpl.h
    
    # ğŸ”§ æ¶æ„ä¿®å¤ï¼šæ™ºèƒ½GDALç®¡ç†å™¨
    src/impl/gdal_manager.h
    
    # å†…éƒ¨ç»„ä»¶
    src/crs_transformer.h
    src/crs_inspector.h
    src/crs_parser.h
)

# åˆ›å»ºç°ä»£åŒ–é™æ€åº“
add_library(${TARGET_NAME} STATIC ${CRS_SERVICE_SOURCES} ${CRS_SERVICE_HEADERS})

# MSVC: å¯ç”¨UTF-8æ”¯æŒå¹¶ç¦ç”¨ç‰¹å®šè­¦å‘Š
if(MSVC)
    # ç§»é™¤ /utf-8 ä»¥éµå¾ªé¡¶å±‚é…ç½®
    # add_compile_options(/utf-8) 
    add_compile_options(/W4 /WX- /Zc:preprocessor /permissive- /Zc:__cplusplus /Zc:throwingNew)
    add_compile_options(/wd4251 /wd4275 /wd4996)
endif()

# === ç°ä»£åŒ–ç¼–è¯‘å®šä¹‰ ===

target_compile_definitions(${TARGET_NAME} PUBLIC 
    OSCEAN_CRS_VERSION_MAJOR=1
    OSCEAN_CRS_VERSION_MINOR=0
    OSCEAN_CRS_VERSION_PATCH=0
    
    # ğŸš€ å¯ç”¨ç°ä»£åŒ–åŠŸèƒ½
    OSCEAN_CRS_MODERN_ARCH=1
    OSCEAN_CRS_SIMD_ENABLED=1
    OSCEAN_CRS_PERFORMANCE_MONITORING=1
    OSCEAN_CRS_STREAMING_ENABLED=1
    
    # å¤–éƒ¨åº“æ”¯æŒ
    OSCEAN_HAS_PROJ=1
)

# === ç°ä»£åŒ–ä¾èµ–é“¾æ¥ ===

target_link_libraries(${TARGET_NAME}
    PUBLIC 
        # ğŸ¯ æ ¸å¿ƒæ¥å£ä¾èµ–
        core_service_interfaces
        
        # ğŸš€ Commonæ¨¡å—ç°ä»£åŒ–é›†æˆ
        common_utilities
        
        # ğŸ“ åœ°ç†ç©ºé—´åº“ - åªä½¿ç”¨PROJè¿›è¡Œåæ ‡è½¬æ¢
        PROJ::proj 
        
        # ğŸš€ ç°ä»£åŒ–æ—¥å¿—ç³»ç»Ÿ
        spdlog::spdlog
        
        # Booståº“ï¼ˆå¼‚æ­¥æ¡†æ¶ï¼‰
        Boost::system
        Boost::thread
        Boost::chrono
        
    PRIVATE 
        # ğŸ”§ Boostç°ä»£åŒ–ç»„ä»¶
        Boost::system 
        Boost::thread 
        Boost::exception
)

# === ç°ä»£åŒ–åŒ…å«ç›®å½• ===

target_include_directories(${TARGET_NAME}
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include> 
        $<INSTALL_INTERFACE:include>
        
        # ğŸ¯ æ ¸å¿ƒæœåŠ¡æ¥å£
        $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/core_service_interfaces/include>
        
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${CMAKE_CURRENT_SOURCE_DIR}/src/impl
)

# === ç°ä»£åŒ–ç¼–è¯‘é€‰é¡¹ ===

if(MSVC)
    target_compile_options(${TARGET_NAME} PRIVATE 
        /EHsc           # C++å¼‚å¸¸å¤„ç†
        /permissive-    # ä¸¥æ ¼æ ‡å‡†ç¬¦åˆæ€§
        /Zc:__cplusplus # æ­£ç¡®çš„__cpluspluså®
        
        # ğŸš€ ç°ä»£åŒ–ä¼˜åŒ–é€‰é¡¹
        $<$<CONFIG:Release>:/O2>        # æœ€å¤§é€Ÿåº¦ä¼˜åŒ–
        $<$<CONFIG:Release>:/Ot>        # ä¼˜å…ˆé€Ÿåº¦
        $<$<CONFIG:Release>:/GL>        # å…¨ç¨‹åºä¼˜åŒ–
        $<$<CONFIG:Release>:/favor:AMD64> # x64ä¼˜åŒ–
        
        # ğŸ›¡ï¸ å®‰å…¨æ€§å¢å¼º
        /GS             # ç¼“å†²åŒºå®‰å…¨æ£€æŸ¥
        /sdl            # é¢å¤–å®‰å…¨æ£€æŸ¥
        /arch:AVX2       # SIMDä¼˜åŒ–
    )
    
    target_compile_definitions(${TARGET_NAME} PRIVATE
        _WIN32_WINNT=0x0A00     # Windows 10+
        NOMINMAX                # ç¦ç”¨min/maxå®
        WIN32_LEAN_AND_MEAN     # å‡å°‘åŒ…å«
        _CRT_SECURE_NO_WARNINGS # æŠ‘åˆ¶å®‰å…¨è­¦å‘Š
    )
endif()

if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" OR CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    target_compile_options(${TARGET_NAME} PRIVATE
        -Wall -Wextra -Wpedantic
        -Wno-unused-parameter
        
        # ğŸš€ ç°ä»£åŒ–ä¼˜åŒ–é€‰é¡¹
        $<$<CONFIG:Release>:-O3>        # æœ€å¤§ä¼˜åŒ–
        $<$<CONFIG:Release>:-march=native> # æœ¬æœºä¼˜åŒ–
        $<$<CONFIG:Release>:-flto>      # é“¾æ¥æ—¶ä¼˜åŒ–
        -mavx2 -mfma                    # SIMDä¼˜åŒ–
    )
endif()

# === ç°ä»£åŒ–ç›®æ ‡å±æ€§ ===

set_target_properties(${TARGET_NAME} PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
    CXX_EXTENSIONS OFF
    
    # è¾“å‡ºç›®å½•
    ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    
    # ç‰ˆæœ¬ä¿¡æ¯
    VERSION ${PROJECT_VERSION}
    SOVERSION ${PROJECT_VERSION_MAJOR}
    
    # ç°ä»£åŒ–è¾“å‡ºåç§°
    OUTPUT_NAME "crs_service"
    
    # ğŸš€ ç°ä»£åŒ–ç¬¦å·å¯è§æ€§
    CXX_VISIBILITY_PRESET hidden
    VISIBILITY_INLINES_HIDDEN YES
)

# === ğŸ§ª å¯ç”¨æµ‹è¯• ===
enable_testing()

# ğŸ§ª æ·»åŠ æµ‹è¯•å­ç›®å½•
if(BUILD_TESTING OR CMAKE_CURRENT_SOURCE_DIR STREQUAL CMAKE_SOURCE_DIR)
    add_subdirectory(tests)
endif()

# === ç°ä»£åŒ–å®‰è£…é…ç½® ===

include(GNUInstallDirs)

install(TARGETS ${TARGET_NAME}
    EXPORT CrsServiceTargets
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

install(DIRECTORY include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
    FILES_MATCHING PATTERN "*.h"
)

# ç°ä»£åŒ–é…ç½®æ–‡ä»¶
install(EXPORT CrsServiceTargets
    FILE CrsServiceTargets.cmake
    NAMESPACE Oscean::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/CrsService
)

message(STATUS "[CRS Service] âœ… Configuration complete - Modern high-performance CRS service ready!")

# === ç°ä»£åŒ–ç‰¹æ€§æŠ¥å‘Š ===

message(STATUS "[CRS Service] ğŸ¯ Modern CRS Service Configuration Complete")
message(STATUS "  ğŸ“Š Version: ${PROJECT_VERSION}")
message(STATUS "  ğŸš€ C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "  ğŸ”§ PROJ Support: ${PROJ_VERSION}")
message(STATUS "  ğŸ—ºï¸ ä¸“æ³¨åæ ‡è½¬æ¢ï¼Œæ— æ•°æ®è¯»å–åŠŸèƒ½")
message(STATUS "  âš¡ Boost Support: ${Boost_VERSION}")
message(STATUS "  ğŸ“ Logging: spdlog ${spdlog_VERSION}")
message(STATUS "  ğŸ§ª Testing: ${BUILD_TESTING}")
message(STATUS "  ğŸ­ Build Type: ${CMAKE_BUILD_TYPE}")

# åŠŸèƒ½ç‰¹æ€§æŠ¥å‘Š
message(STATUS "  ğŸ¯ Modern Features Enabled:")
message(STATUS "    âœ… SIMD Optimization")
message(STATUS "    âœ… Performance Monitoring")
message(STATUS "    âœ… Streaming Processing")
message(STATUS "    âœ… Smart Caching")
message(STATUS "    âœ… Async/Future Support")
message(STATUS "    âœ… boost::future Support") 