cmake_minimum_required(VERSION 3.20)
project(common_utilities_tests VERSION 2.0.0 LANGUAGES CXX)

# =============================================================================
# ğŸ“‹ Common Utilities æµ‹è¯•æ¶æ„
# =============================================================================

message(STATUS "[common_utilities/tests] ğŸ¯ æ„å»ºæµ‹è¯•æ¶æ„...")

# C++æ ‡å‡†è®¾ç½®
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# =============================================================================
# ğŸ”§ ä¾èµ–ç®¡ç†
# =============================================================================

find_package(GTest CONFIG REQUIRED)
find_package(Boost REQUIRED COMPONENTS thread system filesystem chrono)
find_package(GDAL CONFIG REQUIRED)
find_package(spdlog CONFIG REQUIRED)

if(NOT TARGET common_utilities)
    message(FATAL_ERROR "common_utilities target not found. Make sure this is called from parent CMakeLists.txt")
endif()

message(STATUS "[common_utilities/tests] âœ… ä¾èµ–éªŒè¯:")
message(STATUS "  ğŸ“¦ GTest: ${GTest_FOUND}")
message(STATUS "  ğŸ“¦ Boost: ${Boost_FOUND}")
message(STATUS "  ğŸ“¦ GDAL: ${GDAL_FOUND}")
message(STATUS "  ğŸ“¦ spdlog: ${spdlog_FOUND}")

# =============================================================================
# ğŸ”§ DLLè‡ªåŠ¨å¤åˆ¶åŠŸèƒ½
# =============================================================================

# ğŸ§¹ è‡ªåŠ¨æ¸…ç†æ—§DLLï¼Œé˜²æ­¢Debug/Releaseæ··ç”¨
file(GLOB OLD_DLLS "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/*.dll")
file(REMOVE ${OLD_DLLS})

function(setup_dll_copying target_name)
    if(WIN32)
        # æ£€æµ‹vcpkgå®‰è£…ç›®å½•
        if(DEFINED ENV{VCPKG_ROOT})
            set(VCPKG_ROOT $ENV{VCPKG_ROOT})
        elseif(EXISTS "C:/Users/Administrator/vcpkg")
            set(VCPKG_ROOT "C:/Users/Administrator/vcpkg")
        elseif(EXISTS "C:/vcpkg")
            set(VCPKG_ROOT "C:/vcpkg")
        else()
            message(WARNING "Could not find vcpkg installation")
            return()
        endif()
        set(VCPKG_TARGET_TRIPLET "x64-windows")
        set(NO_GDAL_TESTS "async_framework_tests" "unified_memory_manager_tests" "cache_strategies_tests")
        set(needs_gdal TRUE)
        if(target_name IN_LIST NO_GDAL_TESTS)
            set(needs_gdal FALSE)
        endif()

        # Debug é…ç½®çš„ DLL åˆ—è¡¨
        set(DEBUG_DLL_LIST
            "gtest.dll"
            "gtest_main.dll"
            "boost_thread-vc143-mt-gd-x64-1_87.dll"
            "boost_system-vc143-mt-gd-x64-1_87.dll"
            "boost_filesystem-vc143-mt-gd-x64-1_87.dll"
            "boost_chrono-vc143-mt-gd-x64-1_87.dll"
            "spdlogd.dll"
            "fmtd.dll"
        )

        # Release é…ç½®çš„ DLL åˆ—è¡¨
        set(RELEASE_DLL_LIST
            "gtest.dll"
            "gtest_main.dll"
            "boost_thread-vc143-mt-x64-1_87.dll"
            "boost_system-vc143-mt-x64-1_87.dll"
            "boost_filesystem-vc143-mt-x64-1_87.dll"
            "boost_chrono-vc143-mt-x64-1_87.dll"
            "spdlog.dll"
            "fmt.dll"
        )

        # å¦‚æœéœ€è¦ GDALï¼Œæ·»åŠ åˆ°ç›¸åº”çš„ DLL åˆ—è¡¨
        if(needs_gdal)
            list(APPEND DEBUG_DLL_LIST
                "gdald.dll"
                "proj_9_d.dll"
                "zlibd1.dll"
                "libexpatd.dll"
            )
            list(APPEND RELEASE_DLL_LIST
                "gdal.dll"
                "proj_9.dll"
                "zlib1.dll"
                "libexpat.dll"
            )
        endif()

        # ä¸º Debug é…ç½®è®¾ç½® DLL å¤åˆ¶
        foreach(DLL ${DEBUG_DLL_LIST})
            add_custom_command(TARGET ${target_name} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${VCPKG_ROOT}/installed/${VCPKG_TARGET_TRIPLET}/debug/bin/${DLL}"
                $<TARGET_FILE_DIR:${target_name}>
                COMMENT "Copying ${DLL} to debug directory for ${target_name}"
            )
        endforeach()

        # ä¸º Release é…ç½®è®¾ç½® DLL å¤åˆ¶
        foreach(DLL ${RELEASE_DLL_LIST})
            add_custom_command(TARGET ${target_name} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${VCPKG_ROOT}/installed/${VCPKG_TARGET_TRIPLET}/bin/${DLL}"
                $<TARGET_FILE_DIR:${target_name}>
                COMMENT "Copying ${DLL} to release directory for ${target_name}"
            )
        endforeach()
    endif()
endfunction()

# =============================================================================
# ğŸ”§ é€šç”¨æµ‹è¯•é…ç½®å‡½æ•°
# =============================================================================

function(create_test target_name source_file needs_gdal)
    # åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
    add_executable(${target_name} ${source_file})
    
    # è®¾ç½®C++æ ‡å‡†
    set_target_properties(${target_name} PROPERTIES 
        CXX_STANDARD 17 
        CXX_STANDARD_REQUIRED ON
        CXX_EXTENSIONS OFF
    )
    
    # åŒ…å«ç›®å½•
    target_include_directories(${target_name} PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/../include
    )
    
    # é“¾æ¥åŸºç¡€åº“
    target_link_libraries(${target_name} PRIVATE
        GTest::gtest_main
        GTest::gtest
        common_utilities
        Boost::thread
        Boost::system
        Boost::filesystem
        Boost::chrono
        spdlog::spdlog
    )
    
    # å¯é€‰é“¾æ¥GDAL
    if(needs_gdal AND GDAL_FOUND)
        target_link_libraries(${target_name} PRIVATE GDAL::GDAL)
    endif()
    
    # Windowsç‰¹å®šé…ç½®
    if(WIN32 AND MSVC)
        target_compile_definitions(${target_name} PRIVATE
            _WIN32_WINNT=0x0A00
            WIN32_LEAN_AND_MEAN
            NOMINMAX
        )
        target_compile_options(${target_name} PRIVATE /W4 /FS /Zc:__cplusplus /bigobj)
    endif()
    
    # è®¾ç½®DLLå¤åˆ¶
    setup_dll_copying(${target_name})
    
    message(STATUS "[æµ‹è¯•é…ç½®] âœ… ${target_name} é…ç½®å®Œæˆ")
endfunction()

# =============================================================================
# ğŸ¯ æ ¸å¿ƒæµ‹è¯•å®šä¹‰
# =============================================================================

# åŸºç¡€å•å…ƒæµ‹è¯• (ä¸éœ€è¦GDAL)
create_test(common_unit_tests common_unit_tests.cpp FALSE)

# é›†æˆéªŒè¯æµ‹è¯• (éœ€è¦GDAL)
create_test(integration_verification_test integration_verification_test.cpp TRUE)

# å¼‚æ­¥æ¡†æ¶æµ‹è¯• (ä¸éœ€è¦GDAL)
create_test(async_framework_tests async_framework_tests.cpp FALSE)

# SIMDç®¡ç†å™¨æµ‹è¯• (éœ€è¦GDAL)
create_test(simd_manager_tests simd_manager_tests.cpp TRUE)

# ç»Ÿä¸€å†…å­˜ç®¡ç†å™¨æµ‹è¯• (ä¸éœ€è¦GDAL)
create_test(unified_memory_manager_tests unified_memory_manager_tests.cpp FALSE)

# ç¼“å­˜ç³»ç»Ÿæµ‹è¯• (ä¸éœ€è¦GDAL)
create_test(cache_strategies_tests cache_strategies_tests.cpp FALSE)

# ç¼“å­˜ç³»ç»Ÿæ ¸å¿ƒæµ‹è¯• - æŒ‰ç…§æµ‹è¯•è®¡åˆ’1.2 (ä¸éœ€è¦GDAL) - [FIXME] æš‚æ—¶ç¦ç”¨ï¼Œæ­¤æµ‹è¯•ä½¿ç”¨çš„APIå·²è¿‡æ—¶
# create_test(cache_system_core_tests test_cache_system_core.cpp FALSE)

# å¤§æ–‡ä»¶å¤„ç†å™¨æµ‹è¯• (éœ€è¦GDAL)
create_test(large_file_processor_tests large_file_processor_tests.cpp TRUE)

# æ€§èƒ½åŸºå‡†æµ‹è¯• (éœ€è¦GDAL)
create_test(performance_benchmark_test performance_benchmark_test.cpp TRUE)

# å¤æ‚é›†æˆæµ‹è¯• (éœ€è¦GDAL)
create_test(complex_integration_test complex_integration_test.cpp TRUE)

# =============================================================================
# ğŸ§ª CTesté›†æˆ
# =============================================================================

enable_testing()

# æ³¨å†Œæµ‹è¯•
add_test(NAME CommonUnitTests COMMAND common_unit_tests)
add_test(NAME IntegrationVerification COMMAND integration_verification_test)
add_test(NAME AsyncFrameworkTests COMMAND async_framework_tests)
add_test(NAME SIMDManagerTests COMMAND simd_manager_tests)
add_test(NAME UnifiedMemoryManagerTests COMMAND unified_memory_manager_tests)
add_test(NAME CacheStrategiesTests COMMAND cache_strategies_tests)
add_test(NAME CacheSystemCoreTests COMMAND cache_system_core_tests)
add_test(NAME LargeFileProcessorTests COMMAND large_file_processor_tests)
add_test(NAME PerformanceBenchmark COMMAND performance_benchmark_test)
add_test(NAME ComplexIntegrationScenarios COMMAND complex_integration_test)

# è®¾ç½®æµ‹è¯•å±æ€§
set_tests_properties(
    CommonUnitTests IntegrationVerification
    PROPERTIES LABELS "unit;fast" TIMEOUT 120
)

set_tests_properties(
    AsyncFrameworkTests SIMDManagerTests UnifiedMemoryManagerTests CacheStrategiesTests CacheSystemCoreTests LargeFileProcessorTests
    PROPERTIES LABELS "unit;medium" TIMEOUT 180
)

set_tests_properties(
    PerformanceBenchmark ComplexIntegrationScenarios
    PROPERTIES LABELS "performance;slow" TIMEOUT 300
)

# =============================================================================
# ğŸš€ è‡ªå®šä¹‰ç›®æ ‡
# =============================================================================

# æ‰€æœ‰æµ‹è¯•ç›®æ ‡åˆ—è¡¨
set(ALL_TEST_TARGETS
    common_unit_tests
    integration_verification_test
    async_framework_tests
    simd_manager_tests
    unified_memory_manager_tests
    cache_strategies_tests
    cache_system_core_tests
    large_file_processor_tests
    performance_benchmark_test
    complex_integration_test
)

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
add_custom_target(run_all_tests
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure --parallel 4
    DEPENDS ${ALL_TEST_TARGETS}
    COMMENT "è¿è¡Œæ‰€æœ‰Common Utilitiesæµ‹è¯•"
)

# è¿è¡Œå¿«é€Ÿæµ‹è¯•
add_custom_target(run_fast_tests
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure --label-regex "fast|medium"
    DEPENDS common_unit_tests integration_verification_test async_framework_tests simd_manager_tests unified_memory_manager_tests cache_strategies_tests cache_system_core_tests large_file_processor_tests
    COMMENT "è¿è¡Œå¿«é€Ÿå’Œä¸­ç­‰é€Ÿåº¦çš„æµ‹è¯•"
)

# è¿è¡Œæ€§èƒ½æµ‹è¯•
add_custom_target(run_performance_tests
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure --label-regex "performance"
    DEPENDS performance_benchmark_test complex_integration_test
    COMMENT "è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
)

# è¿è¡Œæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
add_custom_target(run_core_tests
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure --label-regex "unit"
    DEPENDS async_framework_tests simd_manager_tests unified_memory_manager_tests cache_strategies_tests cache_system_core_tests large_file_processor_tests
    COMMENT "è¿è¡Œæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•"
)

# =============================================================================
# ğŸ“„ çŠ¶æ€æŠ¥å‘Š
# =============================================================================

list(LENGTH ALL_TEST_TARGETS test_count)
message(STATUS "[common_utilities/tests] âœ… æµ‹è¯•æ¶æ„é…ç½®å®Œæˆ:")
message(STATUS "  ğŸ¯ æ ¸å¿ƒæµ‹è¯•æ•°é‡: ${test_count}")
message(STATUS "  ğŸ“¦ DLLè‡ªåŠ¨å¤åˆ¶: å·²é…ç½® (vcpkgç®¡ç†)")
message(STATUS "  ğŸ› ï¸ è‡ªå®šä¹‰ç›®æ ‡: run_all_tests, run_fast_tests, run_performance_tests, run_core_tests")
message(STATUS "  ğŸ“Š æµ‹è¯•è¦†ç›–: å¼‚æ­¥|SIMD|å†…å­˜|ç¼“å­˜|é›†æˆ|æ€§èƒ½")
message(STATUS "  ğŸ†• æ–°å¢æµ‹è¯•: ç»Ÿä¸€å†…å­˜ç®¡ç†å™¨, ç¼“å­˜ç³»ç»Ÿç­–ç•¥, å¤§æ–‡ä»¶å¤„ç†å™¨")
message(STATUS "  â™»ï¸ æ¶æ„ä¼˜åŒ–: å¹¶è¡ŒåŠŸèƒ½å·²æ•´åˆåˆ°å¼‚æ­¥æ¡†æ¶ä¸­")

# =============================================================================
# ğŸ® GPUæµ‹è¯•
# =============================================================================

# æ·»åŠ GPUæµ‹è¯•å­ç›®å½•
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/gpu)
    add_subdirectory(gpu)
    message(STATUS "  ğŸ® GPUæµ‹è¯•: å·²å¯ç”¨")
endif()