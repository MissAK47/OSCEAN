cmake_minimum_required(VERSION 3.15)

# ===================================================================
# ç©ºé—´æœåŠ¡å•å…ƒæµ‹è¯•å¥—ä»¶ - åŸºäºçœŸå®åŠŸèƒ½çš„æµ‹è¯•
# ===================================================================

message(STATUS "ğŸš€ é…ç½®ç©ºé—´æœåŠ¡å•å…ƒæµ‹è¯•å¥—ä»¶...")

# é€šç”¨è®¾ç½®
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# æŸ¥æ‰¾ä¾èµ–
find_package(GTest REQUIRED)
find_package(Boost REQUIRED COMPONENTS system thread filesystem)
find_package(GDAL CONFIG REQUIRED)
find_package(geos CONFIG REQUIRED)

# é€šç”¨åŒ…å«ç›®å½•
set(COMMON_INCLUDE_DIRS
    ${CMAKE_CURRENT_SOURCE_DIR}/../../include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../src
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../core_service_interfaces/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../common_utilities/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../crs_service/include
)

# é€šç”¨é“¾æ¥åº“
set(COMMON_LINK_LIBS
    spatial_ops_service
    common_utilities
    GTest::gtest
    GTest::gtest_main
    GDAL::GDAL
    GEOS::geos_c
    Boost::system
    Boost::thread
    Boost::filesystem
)

# ===================================================================
# 1. å‡ ä½•å¼•æ“æµ‹è¯• (çœŸå®GEOSåº“æµ‹è¯•)
# ===================================================================

add_executable(test_geometry_engine test_geometry_engine.cpp)
target_include_directories(test_geometry_engine PRIVATE ${COMMON_INCLUDE_DIRS})
target_link_libraries(test_geometry_engine PRIVATE ${COMMON_LINK_LIBS})
target_compile_definitions(test_geometry_engine PRIVATE GEOS_FOUND=1)

gtest_discover_tests(test_geometry_engine
    TEST_PREFIX "GeometryEngine::"
    PROPERTIES LABELS "geometry;geos;core"
)

# ===================================================================
# 2. æ …æ ¼å¼•æ“æµ‹è¯• (çœŸå®GDALåº“æµ‹è¯•)
# ===================================================================

add_executable(test_raster_engine test_raster_engine.cpp)
target_include_directories(test_raster_engine PRIVATE ${COMMON_INCLUDE_DIRS})
target_link_libraries(test_raster_engine PRIVATE ${COMMON_LINK_LIBS})
target_compile_definitions(test_raster_engine PRIVATE GDAL_FOUND=1)

gtest_discover_tests(test_raster_engine
    TEST_PREFIX "RasterEngine::"
    PROPERTIES LABELS "raster;gdal;core"
)

# ===================================================================
# 3. ç©ºé—´å·¥å…·æµ‹è¯• (æ•°å­¦å’Œå‡ ä½•è®¡ç®—)
# ===================================================================

add_executable(test_spatial_utils test_spatial_utils.cpp)
target_include_directories(test_spatial_utils PRIVATE ${COMMON_INCLUDE_DIRS})
target_link_libraries(test_spatial_utils PRIVATE ${COMMON_LINK_LIBS})

gtest_discover_tests(test_spatial_utils
    TEST_PREFIX "SpatialUtils::"
    PROPERTIES LABELS "utils;math;geometry"
)

# ===================================================================
# 4. å‡ ä½•è½¬æ¢æµ‹è¯• (æ ¼å¼è½¬æ¢)
# ===================================================================

add_executable(test_geometry_converter test_geometry_converter.cpp)
target_include_directories(test_geometry_converter PRIVATE ${COMMON_INCLUDE_DIRS})
target_link_libraries(test_geometry_converter PRIVATE ${COMMON_LINK_LIBS})

gtest_discover_tests(test_geometry_converter
    TEST_PREFIX "GeometryConverter::"
    PROPERTIES LABELS "converter;format;utils"
)

# ===================================================================
# 5. åæ ‡éªŒè¯æµ‹è¯• (åæ ‡æœ‰æ•ˆæ€§æ£€æŸ¥) - ğŸ†• æ”¯æŒCRSæœåŠ¡é›†æˆ
# ===================================================================

add_executable(test_coordinate_validator test_coordinate_validator.cpp)
target_include_directories(test_coordinate_validator PRIVATE ${COMMON_INCLUDE_DIRS})

# ğŸ†• ä¸ºåæ ‡éªŒè¯æµ‹è¯•é…ç½®ç‰¹æ®Šçš„é“¾æ¥åº“åˆ—è¡¨ï¼ˆåŒ…å«CRSæœåŠ¡ï¼‰
set(COORDINATE_VALIDATOR_LIBS
    spatial_ops_service
    common_utilities
    GTest::gtest
    GTest::gtest_main
    GDAL::GDAL
    GEOS::geos_c
    Boost::system
    Boost::thread
    Boost::filesystem
)

# ğŸ†• æ·»åŠ CRSæœåŠ¡å¯ç”¨æ€§æ£€æŸ¥å’Œæ¡ä»¶é“¾æ¥
if(TARGET crs_service)
    # å°†CRSæœåŠ¡æ·»åŠ åˆ°é“¾æ¥åº“åˆ—è¡¨ï¼ˆæ”¾åœ¨common_utilitiesä¹‹åï¼‰
    list(APPEND COORDINATE_VALIDATOR_LIBS crs_service)
    target_compile_definitions(test_coordinate_validator PRIVATE OSCEAN_HAS_CRS_SERVICE=1)
    message(STATUS "âœ… åæ ‡éªŒè¯æµ‹è¯•: CRSæœåŠ¡é›†æˆå·²å¯ç”¨")
else()
    target_compile_definitions(test_coordinate_validator PRIVATE OSCEAN_HAS_CRS_SERVICE=0)
    message(STATUS "âš ï¸ åæ ‡éªŒè¯æµ‹è¯•: CRSæœåŠ¡æš‚æ—¶ç¦ç”¨ï¼Œä½¿ç”¨åŸºç¡€éªŒè¯æ¨¡å¼")
endif()

target_link_libraries(test_coordinate_validator PRIVATE ${COORDINATE_VALIDATOR_LIBS})

gtest_discover_tests(test_coordinate_validator
    TEST_PREFIX "CoordinateValidator::"
    PROPERTIES LABELS "validator;coordinates;utils;crs"
)

# ===================================================================
# 6. ç©ºé—´ç´¢å¼•æµ‹è¯• (ç´¢å¼•ç®—æ³•)
# ===================================================================

add_executable(test_spatial_indexes test_spatial_indexes.cpp)
target_include_directories(test_spatial_indexes PRIVATE ${COMMON_INCLUDE_DIRS})
target_link_libraries(test_spatial_indexes PRIVATE ${COMMON_LINK_LIBS})

gtest_discover_tests(test_spatial_indexes
    TEST_PREFIX "SpatialIndexes::"
    PROPERTIES LABELS "indexes;algorithms;performance"
)

# ===================================================================
# 7. ç»¼åˆé›†æˆæµ‹è¯• (å¤šæ¨¡å—åä½œ) - æš‚æ—¶ç¦ç”¨ï¼Œæµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨
# ===================================================================

# add_executable(test_integration test_integration.cpp)
# target_include_directories(test_integration PRIVATE ${COMMON_INCLUDE_DIRS})
# target_link_libraries(test_integration PRIVATE ${COMMON_LINK_LIBS})

# gtest_discover_tests(test_integration
#     TEST_PREFIX "Integration::"
#     PROPERTIES LABELS "integration;end-to-end;workflow"
# )

# ===================================================================
# æµ‹è¯•æ•°æ®æ–‡ä»¶å¤åˆ¶
# ===================================================================

# å¤åˆ¶æµ‹è¯•æ•°æ®æ–‡ä»¶åˆ°æ„å»ºç›®å½•
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/../../../../test_data")
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/../../../../test_data
         DESTINATION ${CMAKE_CURRENT_BINARY_DIR}/
    )
    message(STATUS "ğŸ“ å¤åˆ¶æµ‹è¯•æ•°æ®ç›®å½•åˆ°: ${CMAKE_CURRENT_BINARY_DIR}/test_data")
else()
    message(WARNING "âš ï¸ æµ‹è¯•æ•°æ®ç›®å½•ä¸å­˜åœ¨: ${CMAKE_CURRENT_SOURCE_DIR}/../../../../test_data")
endif()

# ===================================================================
# è‡ªå®šä¹‰æµ‹è¯•ç›®æ ‡
# ===================================================================

# å¿«é€Ÿæµ‹è¯• (ä»…æ ¸å¿ƒåŠŸèƒ½)
add_custom_target(run_spatial_quick_tests
    COMMAND ${CMAKE_CTEST_COMMAND} -L "core" --output-on-failure
    DEPENDS test_geometry_engine test_raster_engine test_spatial_utils test_geometry_converter test_coordinate_validator test_spatial_indexes
    COMMENT "ğŸš€ è¿è¡Œç©ºé—´æœåŠ¡å¿«é€Ÿæ ¸å¿ƒæµ‹è¯•..."
)

# å…¨é‡æµ‹è¯•
add_custom_target(run_all_spatial_tests
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure
    DEPENDS test_geometry_engine test_raster_engine test_spatial_utils test_geometry_converter test_coordinate_validator test_spatial_indexes
    COMMENT "ğŸ¯ è¿è¡Œç©ºé—´æœåŠ¡å…¨é‡æµ‹è¯•..."
)

# æ€§èƒ½æµ‹è¯•
add_custom_target(run_spatial_performance_tests
    COMMAND ${CMAKE_CTEST_COMMAND} -L "performance" --output-on-failure
    COMMENT "âš¡ è¿è¡Œç©ºé—´æœåŠ¡æ€§èƒ½ç›¸å…³æµ‹è¯•..."
)

message(STATUS "âœ… å•å…ƒæµ‹è¯•å¥—ä»¶é…ç½®å®Œæˆ")
message(STATUS "ğŸ“Š æµ‹è¯•ç›®æ ‡: 4ä¸ªæµ‹è¯•æ¨¡å—")
message(STATUS "ğŸ¯ è‡ªå®šä¹‰ç›®æ ‡: run_spatial_quick_tests, run_all_spatial_tests, run_spatial_performance_tests") 