# Common Utilities CMake Configuration
# é‡æ„åçš„ç»Ÿä¸€åŸºç¡€è®¾æ–½æ„å»ºé…ç½®

cmake_minimum_required(VERSION 3.20)
project(common_utilities VERSION 2.0.0 LANGUAGES CXX)

# åŒ…å«å¿…è¦çš„CMakeæ¨¡å—
include(GNUInstallDirs)
include(CMakePackageConfigHelpers)

# è®¾ç½®vcpkgå·¥å…·é“¾ï¼ˆå¦‚æœæœªæŒ‡å®šï¼‰
if(NOT DEFINED CMAKE_TOOLCHAIN_FILE AND EXISTS "C:/Users/Administrator/vcpkg/scripts/buildsystems/vcpkg.cmake")
    set(CMAKE_TOOLCHAIN_FILE "C:/Users/Administrator/vcpkg/scripts/buildsystems/vcpkg.cmake" CACHE STRING "Vcpkg toolchain file")
    message(STATUS "Using vcpkg toolchain: ${CMAKE_TOOLCHAIN_FILE}")
endif()

# C++æ ‡å‡†è¦æ±‚
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ç¼–è¯‘é€‰é¡¹ - å¹³å°å…¼å®¹
if(MSVC)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /W4 /FS /Zc:__cplusplus /bigobj")
    # ä¿®å¤Windowsç‰ˆæœ¬å®æœªå®šä¹‰é—®é¢˜
    add_definitions(-D_WIN32_WINNT=0x0A00)  # Windows 10
    add_definitions(-DWIN32_LEAN_AND_MEAN)
    add_definitions(-DNOMINMAX)
else()
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra")
endif()

# ğŸ”´ é‡æ„æ–¹æ¡ˆï¼šé…ç½®å¼‚æ­¥æ¡†æ¶é€‰æ‹©
option(OSCEAN_USE_BOOST_FUTURE "Use boost::future instead of std::future" ON)
option(OSCEAN_ENFORCE_ASYNC_COMPLIANCE "Enforce async compliance at compile time" ON)

if(OSCEAN_USE_BOOST_FUTURE)
    add_definitions(-DOSCEAN_USE_BOOST_FUTURE)
    message(STATUS "Using boost::future for async operations")
else()
    message(STATUS "Using std::future for async operations")
endif()

if(OSCEAN_ENFORCE_ASYNC_COMPLIANCE)
    add_definitions(-DOSCEAN_ENFORCE_ASYNC_COMPLIANCE)
    message(STATUS "Enforcing async compliance at compile time")
endif()

# =============================================================================
# ğŸ”´ ä¾èµ–ç®¡ç†ä¿®å¤ï¼šä½¿ç”¨ä¸»CMakeä¼ é€’çš„ä¾èµ–
# =============================================================================

# æŸ¥æ‰¾å¹¶ä½¿ç”¨ä¸»CMakeä¼ é€’çš„ä¾èµ–åº“
find_package(GDAL CONFIG REQUIRED)  # ä½¿ç”¨CONFIGæ¨¡å¼æŸ¥æ‰¾GDAL
find_package(netCDF CONFIG QUIET)
find_package(Boost REQUIRED COMPONENTS thread system filesystem)
find_package(spdlog CONFIG REQUIRED)

# æ‰“å°ä¾èµ–ä¿¡æ¯ç”¨äºè°ƒè¯•
message(STATUS "[common_utilities] GDAL_FOUND: ${GDAL_FOUND}")
if(GDAL_FOUND)
    message(STATUS "[common_utilities] GDAL target available: GDAL::GDAL")
endif()

message(STATUS "[common_utilities] Boost_FOUND: ${Boost_FOUND}")

# =============================================================================
# ğŸ”´ é‡æ„åçš„æ–°æ–‡ä»¶ç»“æ„æºæ–‡ä»¶
# =============================================================================

# æ ¸å¿ƒæ¨¡å—å…¥å£
set(CORE_SOURCES
    src/common_utils/common_utils.cpp       # ğŸ†• æ¨¡å—ç»Ÿä¸€å…¥å£å®ç°
)

# ğŸ†• é‡æ„åçš„utilitiesæ¨¡å—æºæ–‡ä»¶
set(UTILITIES_SOURCES
    src/utilities/string_utils.cpp         # å­—ç¬¦ä¸²å·¥å…·å®ç°
    src/utilities/filesystem_path_utils.cpp     # æ–‡ä»¶ç³»ç»Ÿè·¯å¾„å·¥å…·å®ç° - ä¿®æ­£è·¯å¾„
    src/utilities/filesystem_query_utils.cpp    # æ–‡ä»¶ç³»ç»ŸæŸ¥è¯¢å·¥å…·å®ç° - ä¿®æ­£è·¯å¾„
    src/utilities/filesystem_io_utils.cpp       # æ–‡ä»¶ç³»ç»ŸI/Oå·¥å…·å®ç° - ä¿®æ­£è·¯å¾„
    src/utilities/filesystem_manipulation_utils.cpp # æ–‡ä»¶ç³»ç»Ÿæ“ä½œå·¥å…·å®ç° - ä¿®æ­£è·¯å¾„
    src/utilities/file_format_detector.cpp      # ğŸ†• æ–‡ä»¶æ ¼å¼æ£€æµ‹å·¥å…·å®ç° - ä¿®æ­£è·¯å¾„
    src/utilities/app_config_loader.cpp         # ğŸ†• åº”ç”¨é…ç½®åŠ è½½å™¨å®ç° - ä¿®æ­£è·¯å¾„
    src/utilities/logging_utils.cpp        # æ—¥å¿—å·¥å…·å®ç°
    src/utilities/error_handling.cpp       # é”™è¯¯å¤„ç†å·¥å…·å®ç°
)

# ğŸ†• é‡æ„åçš„å¼‚æ­¥æ¡†æ¶æºæ–‡ä»¶ (æ–°çš„ç»Ÿä¸€å®ç°)
set(ASYNC_SOURCES
    src/async/async_config.cpp          # ğŸ†• å¼‚æ­¥é…ç½®å®ç° - ä¿®æ­£è·¯å¾„
    src/async/async_framework.cpp       # ğŸ†• å¼‚æ­¥æ¡†æ¶æ ¸å¿ƒå®ç° - ä¿®æ­£è·¯å¾„
    # æ³¨æ„ï¼šå·²åˆ é™¤çš„æ–‡ä»¶ï¼š
    # - async_factory.h (åŠŸèƒ½ç”± CommonServicesFactory å–ä»£)
    # - async_interfaces.h (æ¥å£å·²æ•´åˆè‡³ async_framework.h)
    # - async_composition.h (é€»è¾‘æ•´åˆåˆ° async_framework.cpp)
    # - async_context.h (é€»è¾‘æ•´åˆåˆ° async_framework.cpp)
    # - async_enhanced.h (é€»è¾‘æ•´åˆåˆ° async_framework.cpp)
    # - async_patterns.h (é€»è¾‘æ•´åˆåˆ° async_framework.cpp)
)

# ç¼“å­˜ç®¡ç†å™¨æºæ–‡ä»¶ (ğŸ”´ é‡æ„åçš„æ–°cacheå®ç°)
set(CACHE_SOURCES
    src/cache/cache_config.cpp              # ç¼“å­˜é…ç½®å’Œç­–ç•¥å®šä¹‰å®ç°
    src/cache/cache_strategies.cpp          # ç¼“å­˜ç­–ç•¥å®ç°(LRU/LFU/FIFO/TTL/è‡ªé€‚åº”)
    # æ³¨æ„ï¼šå·²åˆ é™¤ cache_factory.h (åŠŸèƒ½ç”± CommonServicesFactory å–ä»£)
    # æ³¨æ„ï¼šå·²åˆ é™¤ cache_spatial.cpp (æ¨¡æ¿ç±»ï¼Œå®ç°åœ¨å¤´æ–‡ä»¶ä¸­)
)

# åŸºç¡€è®¾æ–½æºæ–‡ä»¶ (ç¡®è®¤èƒ½ç¼–è¯‘)
set(INFRASTRUCTURE_SOURCES
    src/infrastructure/common_services_factory.cpp    # ä¿®æ­£è·¯å¾„
    src/infrastructure/large_file_processor.cpp         # ğŸ†• å¤§æ–‡ä»¶å¤„ç†å™¨å®ç°
    src/infrastructure/unified_thread_pool_manager.cpp # ğŸ†• ç»Ÿä¸€çº¿ç¨‹æ± ç®¡ç†å™¨å®ç°
    # ğŸ”§ ç§»é™¤ï¼šunified_thread_pool_manager.cpp å·²æ”¹ä¸ºä»…å¤´æ–‡ä»¶æ¨¡æ¿å®ç°
    # ğŸ”§ ç§»é™¤ï¼šperformance_monitor.cpp å·²æ”¹ä¸ºä»…å¤´æ–‡ä»¶æ¨¡æ¿å®ç°
)

# ğŸ”„ é‡æ„åçš„å†…å­˜ç®¡ç†æºæ–‡ä»¶ (æ–°çš„ç»Ÿä¸€å®ç°)
set(MEMORY_SOURCES
    src/memory/memory_config.cpp               # å†…å­˜é…ç½®å®ç°
    src/memory/memory_manager_unified.cpp      # ç»Ÿä¸€å†…å­˜ç®¡ç†å™¨æ ¸å¿ƒå®ç°
    src/memory/memory_allocators.cpp           # STLå…¼å®¹åˆ†é…å™¨å®ç°
    src/memory/memory_statistics.cpp           # å†…å­˜ç»Ÿè®¡å’Œç›‘æ§å®ç°
    # æ³¨æ„ï¼šå·²åˆ é™¤ memory_factory.h (åŠŸèƒ½ç”± CommonServicesFactory å–ä»£)
    # æ³¨æ„ï¼šå·²åˆ é™¤ memory_concurrent.cpp (é€»è¾‘å·²æ•´åˆ)
    # æ³¨æ„ï¼šå·²åˆ é™¤ memory_pools.cpp (é€»è¾‘å·²æ•´åˆ)
    # æ³¨æ„ï¼šå·²åˆ é™¤ memory_streaming.cpp (é€»è¾‘å·²æ•´åˆ)
    # æ³¨æ„ï¼šå·²åˆ é™¤ memory_interfaces.cpp (é€»è¾‘å·²æ•´åˆ)
    # æ³¨æ„ï¼šå·²åˆ é™¤ adaptive_memory_strategy.cpp (è¿‡åº¦å¤æ‚ï¼Œå·²åˆ é™¤)
)

# ğŸ”„ é‡æ–°å¯ç”¨æµå¼å¤„ç†æºæ–‡ä»¶ - æ‰€æœ‰å¼‚æ­¥æ¥å£é—®é¢˜å·²è§£å†³
set(STREAMING_SOURCES
    # æ³¨æ„ï¼šstreamingæ¨¡å—å·²å¤§å¹…ç®€åŒ–ï¼Œå¤§éƒ¨åˆ†åŠŸèƒ½è¿ç§»åˆ°infrastructure/large_file_processor
    # src/streaming/streaming_buffer.cpp     # âœ… å·²ä¿®å¤ï¼šåŸºç¡€ç¼“å†²ç®¡ç† - å·²åˆ é™¤
    # src/streaming/streaming_reader.cpp     # âœ… å·²ä¿®å¤ï¼šå¼‚æ­¥è¯»å–å™¨æ¥å£å®ç°å®Œæ•´ - å·²åˆ é™¤
    # src/streaming/streaming_transformer.cpp # âœ… å·²ä¿®å¤ï¼šå¼‚æ­¥å˜æ¢å™¨æ¥å£å®ç°å®Œæ•´ - å·²åˆ é™¤
    # src/streaming/streaming_memory.cpp     # âœ… å·²ä¿®å¤ï¼šå†…å­˜ç®¡ç†å’Œå‹åŠ›ç›‘æ§ - å·²åˆ é™¤
    # src/streaming/streaming_factory.cpp    # âœ… å·²ä¿®å¤ï¼šåŸºç¡€éƒ¨åˆ†ï¼ˆå·¥å‚è¿”å›nullptrç­–ç•¥ï¼‰- å·²åˆ é™¤
    # src/streaming/streaming_pipeline.cpp   # âœ… å·²ä¿®å¤ï¼šæ‰€æœ‰7ä¸ªå¼‚æ­¥æ–¹æ³•å®ç°å®Œæ•´ - å·²åˆ é™¤
    # src/streaming/streaming_large_data.cpp # âœ… å·²ä¿®å¤ï¼šæ‰€æœ‰3ä¸ªå¼‚æ­¥æ–¹æ³•å£°æ˜+å®ç°å®Œæ•´ - å·²åˆ é™¤
)

# ğŸ”„ é‡æ–°å¯ç”¨SIMDå¤„ç†æºæ–‡ä»¶ - å·²æ‹†åˆ†ä¸ºå¤šä¸ªä¸“ç”¨æ¨¡å—æ–‡ä»¶
set(SIMD_SOURCES
    src/simd/simd_config.cpp               # âœ… SIMDé…ç½®å’Œç¯å¢ƒæ£€æµ‹
    src/simd/simd_manager_unified.cpp      # âœ… ç»Ÿä¸€SIMDç®¡ç†å™¨å®ç°
    src/simd/simd_manager_math.cpp         # ğŸ†• æ•°å­¦è¿ç®—å®ç°ï¼ˆåŒ…å«å„ç§æ•°å­¦å‡½æ•°å’Œç»Ÿè®¡ï¼‰
    src/simd/simd_manager_geo.cpp          # ğŸ†• åœ°ç†æ“ä½œå®ç°ï¼ˆæŠ•å½±ã€æ’å€¼ã€å˜æ¢ç­‰ï¼‰
    src/simd/simd_manager_ocean.cpp        # ğŸ†• æµ·æ´‹æ•°æ®ä¸“ç”¨æ“ä½œå®ç°
    # æ³¨æ„ï¼šå·²åˆ é™¤ simd_factory.h (åŠŸèƒ½ç”± CommonServicesFactory å–ä»£)
    # æ³¨æ„ï¼šå·²åˆ é™¤ simd_operations_basic.cpp (åŠŸèƒ½å·²æ•´åˆåˆ° simd_manager_unified.cpp)
    # æ³¨æ„ï¼šå·²åˆ é™¤ simd_unified.cpp (é‡æ„ä¸º simd_manager_unified.cpp)
)

# ğŸ”„ é‡æ„åçš„æ—¶é—´ç®¡ç†æºæ–‡ä»¶ (çº¯å‡€åŒ–å®ç°)
set(TIME_SOURCES
    src/time/time_types.cpp         # é€šç”¨æ—¶é—´ç±»å‹å®ç°
    src/time/time_range.cpp         # æ—¶é—´èŒƒå›´å¤„ç†å®ç°  
    src/time/time_resolution.cpp    # æ—¶é—´åˆ†è¾¨ç‡ç®¡ç†å®ç°
    src/time/time_calendar.cpp      # é€šç”¨æ—¥å†å¤„ç†å®ç°
    src/time/time_interfaces.cpp    # æ—¶é—´æ¥å£å®ç°
    src/time/time_services.cpp      # æ—¶é—´æœåŠ¡ç»Ÿä¸€æ¥å£å®ç°
    # æ³¨æ„ï¼šå·²åˆ é™¤ time_factory.cpp (åŠŸèƒ½ç”± CommonServicesFactory å–ä»£)
)

# ğŸ†• GPUåŸºç¡€è®¾æ–½æºæ–‡ä»¶
# GPUåŸºç¡€æºæ–‡ä»¶ï¼ˆæ€»æ˜¯ç¼–è¯‘ï¼‰
set(GPU_SOURCES
    src/gpu/unified_gpu_manager.cpp         # ç»Ÿä¸€GPUç®¡ç†å™¨å®ç°
    src/gpu/multi_gpu_scheduler.cpp         # å¤šGPUè°ƒåº¦å™¨å®ç°
    src/gpu/multi_gpu_memory_manager.cpp    # å¤šGPUå†…å­˜ç®¡ç†å™¨å®ç°
    src/gpu/oscean_gpu_framework.cpp        # OSCEAN GPUæ¡†æ¶å®ç°
    src/gpu/gpu_performance_monitor.cpp     # GPUæ€§èƒ½ç›‘æ§å®ç°
)

# æ¡ä»¶æ·»åŠ CUDAæºæ–‡ä»¶
find_package(CUDAToolkit QUIET)
if(CUDAToolkit_FOUND)
    list(APPEND GPU_SOURCES
        src/gpu/cuda/cuda_device_detector.cpp   # CUDAè®¾å¤‡æ£€æµ‹
        src/gpu/cuda/cuda_memory_manager.cpp    # CUDAå†…å­˜ç®¡ç†å®ç°
    )
    add_definitions(-DOSCEAN_CUDA_ENABLED=1)
    include_directories(${CUDAToolkit_INCLUDE_DIRS})
    message(STATUS "[GPU] CUDA support enabled")
    message(STATUS "[GPU] CUDA include dirs: ${CUDAToolkit_INCLUDE_DIRS}")
else()
    add_definitions(-DOSCEAN_CUDA_ENABLED=0)
    message(STATUS "[GPU] CUDA not available")
endif()

# æ¡ä»¶æ·»åŠ OpenCLæºæ–‡ä»¶
find_package(OpenCL QUIET)
if(OpenCL_FOUND)
    list(APPEND GPU_SOURCES
        src/gpu/opencl/opencl_device_detector.cpp # OpenCLè®¾å¤‡æ£€æµ‹
        src/gpu/opencl/opencl_memory_manager.cpp # OpenCLå†…å­˜ç®¡ç†å®ç°
    )
    add_definitions(-DOSCEAN_OPENCL_ENABLED=1)
    include_directories(${OpenCL_INCLUDE_DIRS})
    message(STATUS "[GPU] OpenCL support enabled")
    message(STATUS "[GPU] OpenCL include dirs: ${OpenCL_INCLUDE_DIRS}")
else()
    add_definitions(-DOSCEAN_OPENCL_ENABLED=0)
    message(STATUS "[GPU] OpenCL not available")
endif()

# ROCmæ£€æµ‹ï¼ˆå ä½ç¬¦ï¼Œæ€»æ˜¯ç¼–è¯‘ï¼‰
list(APPEND GPU_SOURCES src/gpu/rocm/rocm_device_detector.cpp)

# ğŸ†• é‡æ„åçš„å¹¶è¡Œå¤„ç†æºæ–‡ä»¶ (æ–°çš„ç»Ÿä¸€å®ç°)
set(PARALLEL_SOURCES
    # æ³¨æ„ï¼šparallelæ¨¡å—å·²å¤§å¹…ç®€åŒ–ï¼Œå¤§éƒ¨åˆ†åŠŸèƒ½è¿ç§»åˆ°infrastructureå’Œå…¶ä»–æ¨¡å—
    # src/parallel/parallel_scheduler.cpp     # ä»»åŠ¡è°ƒåº¦å™¨å®ç° - å·²åˆ é™¤
    # src/parallel/parallel_algorithms.cpp    # å¹¶è¡Œç®—æ³•å®ç° - å·²åˆ é™¤
    # src/parallel/parallel_data_ops.cpp      # æ•°æ®å¹¶è¡Œæ“ä½œå®ç° - å·²åˆ é™¤
    # src/parallel/parallel_spatial_ops.cpp   # ç©ºé—´å¹¶è¡Œæ“ä½œå®ç° - å·²åˆ é™¤
    # src/parallel/parallel_enhanced.cpp      # å¢å¼ºå¹¶è¡Œå¼•æ“å®ç° - å·²åˆ é™¤
    # src/parallel/parallel_factory.cpp       # å¹¶è¡Œå¤„ç†å·¥å‚å®ç° - å·²åˆ é™¤
)

# ğŸ†• é‡æ„åçš„æ ¼å¼å·¥å…·æºæ–‡ä»¶ (æ–°çš„ç»Ÿä¸€å®ç°)
set(FORMAT_UTILS_SOURCES
    # æ³¨æ„ï¼šformat_utilsæ¨¡å—å·²åˆ é™¤ï¼ŒåŠŸèƒ½è¿ç§»åˆ°utilities/file_format_detector
    # src/format_utils/format_detection.cpp       # æ ¼å¼æ£€æµ‹å®ç° - å·²åˆ é™¤
    # src/format_utils/format_factory.cpp         # æ ¼å¼å·¥å…·å·¥å‚å®ç° - å·²åˆ é™¤
    # æ³¨æ„ï¼šgdalå’Œnetcdfå­æ¨¡å—å·²åˆ é™¤ï¼ŒåŠŸèƒ½è¿ç§»åˆ°utilities/file_format_detector
    # src/format_utils/netcdf/netcdf_format.cpp   # NetCDFæ ¼å¼å·¥å…·å®ç° - å·²åˆ é™¤
    # src/format_utils/netcdf/netcdf_streaming.cpp # NetCDFæµå¼è¯»å–å®ç° - å·²åˆ é™¤
    # src/format_utils/gdal/gdal_format.cpp       # GDALæ ¼å¼å·¥å…·å®ç° - å·²åˆ é™¤
    # src/format_utils/gdal/gdal_streaming.cpp    # GDALæµå¼è¯»å–å®ç° - å·²åˆ é™¤
)

# åˆå¹¶å½“å‰å¯ç¼–è¯‘çš„æºæ–‡ä»¶ - ğŸ”´ ç°åœ¨åŒ…å«é‡æ„åçš„æ‰€æœ‰æ¨¡å—
set(ALL_SOURCES 
    ${CORE_SOURCES}
    ${UTILITIES_SOURCES}
    ${ASYNC_SOURCES}
    ${CACHE_SOURCES}
    ${INFRASTRUCTURE_SOURCES}
    ${MEMORY_SOURCES}
    ${STREAMING_SOURCES}
    ${SIMD_SOURCES}
    ${TIME_SOURCES}
    ${GPU_SOURCES}      # ğŸ†• GPUåŸºç¡€è®¾æ–½
    ${PARALLEL_SOURCES}
    # ${FORMAT_UTILS_SOURCES}  # å·²åˆ é™¤ï¼ŒåŠŸèƒ½è¿ç§»åˆ°utilitiesæ¨¡å—
)

# éªŒè¯æ‰€æœ‰æºæ–‡ä»¶å­˜åœ¨
foreach(source ${ALL_SOURCES})
    if(NOT EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/${source}")
        message(WARNING "Source file not found: ${source}")
    endif()
endforeach()

message(STATUS "Total source files: ${ALL_SOURCES}")
list(LENGTH ALL_SOURCES source_count)
message(STATUS "Source files count: ${source_count}")

# åˆ›å»ºcommon_utilitiesåº“
add_library(common_utilities STATIC ${ALL_SOURCES})

# =============================================================================
# è®¾ç½®ç¼–è¯‘é€‰é¡¹å’Œå®šä¹‰
# =============================================================================

target_compile_definitions(common_utilities PUBLIC
    OSCEAN_COMMON_UTILS_VERSION_MAJOR=2
    OSCEAN_COMMON_UTILS_VERSION_MINOR=0
    OSCEAN_COMMON_UTILS_VERSION_PATCH=0
)

if(OSCEAN_USE_BOOST_FUTURE)
    target_compile_definitions(common_utilities PUBLIC OSCEAN_USE_BOOST_FUTURE)
endif()

# Windowsç‰¹å®šå®šä¹‰
if(WIN32)
    target_compile_definitions(common_utilities PRIVATE
        _WIN32_WINNT=0x0A00
        WIN32_LEAN_AND_MEAN
        NOMINMAX
    )
endif()

# åŒ…å«ç›®å½•
target_include_directories(common_utilities PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)

# é“¾æ¥åº“
target_link_libraries(common_utilities PUBLIC
    core_service_interfaces
    GDAL::GDAL
    spdlog::spdlog
    Boost::thread
    Boost::system
    Boost::filesystem
)

if(netCDF_FOUND)
    target_link_libraries(common_utilities PUBLIC netCDF::netcdf)
endif()

# =============================================================================
# æµ‹è¯•é…ç½®
# =============================================================================
if(BUILD_TESTING)
    enable_testing()
    add_subdirectory(tests)
    message(STATUS "common_utilities tests enabled.")
else()
    message(STATUS "common_utilities tests disabled.")
endif()

# =============================================================================
# ğŸ”´ é‡æ„éªŒè¯å’Œæµ‹è¯•ç›®æ ‡ - æ›´æ–°çŠ¶æ€
# =============================================================================

# æ·»åŠ é‡æ„éªŒè¯ç›®æ ‡
add_custom_target(validate_common_refactoring
    COMMAND echo "Validating Common module refactoring..."
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    COMMENT "Validating Common module refactoring compliance"
)

# æ˜¾ç¤ºé…ç½®æ€»ç»“
message(STATUS "Common Utilities v2.0.0 Configuration Summary:")
if(OSCEAN_USE_BOOST_FUTURE)
    message(STATUS "  Async Framework: C++${CMAKE_CXX_STANDARD} with boost::future")
else()
    message(STATUS "  Async Framework: C++${CMAKE_CXX_STANDARD} with std::future")
endif()
message(STATUS "  Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  Sources Count: ${source_count}")
message(STATUS "  Memory Management: REFACTORED (ç»Ÿä¸€å®ç°)")
message(STATUS "  Async Framework: REFACTORED (æ¨¡å—åŒ–è®¾è®¡)")
message(STATUS "  Factory Pattern: UNIFIED (CommonServicesFactory)")
message(STATUS "  NetCDF Support: ${netCDF_FOUND}")
if(OSCEAN_USE_BOOST_FUTURE AND Boost_FOUND)
    message(STATUS "  Boost Support: ${Boost_FOUND} (${Boost_VERSION})")
endif()

# === å®‰è£…å’Œå¯¼å‡º ===

# å®‰è£…ç›®æ ‡
install(TARGETS common_utilities
    EXPORT CommonUtilitiesTargets
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

# å®‰è£…å…¬å…±å¤´æ–‡ä»¶
install(DIRECTORY include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

# --- ç”Ÿæˆå’Œå®‰è£…CMakeåŒ…é…ç½®æ–‡ä»¶ ---

# åˆ›å»ºå¹¶å®‰è£… common_utilitiesConfigVersion.cmake
write_basic_package_version_file(
    "${CMAKE_CURRENT_BINARY_DIR}/common_utilitiesConfigVersion.cmake"
    VERSION ${PROJECT_VERSION}
    COMPATIBILITY SameMajorVersion
)

# åˆ›å»º common_utilities-config.cmake
configure_package_config_file(
    "cmake/common_utilities-config.cmake.in" # éœ€è¦åˆ›å»ºè¿™ä¸ªæ¨¡æ¿æ–‡ä»¶
    "${CMAKE_CURRENT_BINARY_DIR}/common_utilities-config.cmake"
    INSTALL_DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/common_utilities"
    PATH_VARS CMAKE_INSTALL_INCLUDEDIR CMAKE_INSTALL_LIBDIR
)

# å®‰è£…é…ç½®æ–‡ä»¶
install(FILES
    "${CMAKE_CURRENT_BINARY_DIR}/common_utilities-config.cmake"
    "${CMAKE_CURRENT_BINARY_DIR}/common_utilitiesConfigVersion.cmake"
    DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/common_utilities"
)

# å®‰è£…å¯¼å‡ºç›®æ ‡æ–‡ä»¶
install(EXPORT CommonUtilitiesTargets
    FILE CommonUtilitiesTargets.cmake
    NAMESPACE OSCEAN::
    DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/common_utilities"
)

# GPUæµ‹è¯•æ–‡ä»¶
if(BUILD_TESTS)
    set(GPU_TEST_SOURCES
        tests/gpu/test_gpu_detection.cpp
        tests/gpu/test_multi_gpu_scheduler.cpp
        tests/gpu/test_gpu_framework.cpp
        # tests/gpu/test_gpu_memory_manager.cpp
    )
    
    # æ·»åŠ GPUæµ‹è¯•
    foreach(test_source ${GPU_TEST_SOURCES})
        get_filename_component(test_name ${test_source} NAME_WE)
        add_executable(${test_name} ${test_source})
        target_link_libraries(${test_name} 
            common_utilities
            GTest::gtest
            GTest::gtest_main
            ${Boost_LIBRARIES}
        )
        add_test(NAME ${test_name} COMMAND ${test_name})
    endforeach()
endif() 
