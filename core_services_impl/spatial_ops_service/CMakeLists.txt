# core_services_impl/spatial_ops_service/CMakeLists.txt
cmake_minimum_required(VERSION 3.15)

# è®¾ç½®CMakeç­–ç•¥ä»¥é¿å…BoostæŸ¥æ‰¾è­¦å‘Š
if(POLICY CMP0167)
    cmake_policy(SET CMP0167 NEW)  # ä½¿ç”¨æ–°çš„BoostæŸ¥æ‰¾æ¨¡å—
endif()

# è®¾ç½®é¡¹ç›®åç§°å’Œç‰ˆæœ¬
project(spatial_ops_service VERSION 1.0.0 LANGUAGES CXX)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# è®¾ç½®åº“åç§°
set(SPATIAL_OPS_SERVICE_LIB_NAME "spatial_ops_service")

# æŸ¥æ‰¾ä¾èµ–åŒ…
find_package(Boost REQUIRED COMPONENTS system thread filesystem)

# æŸ¥æ‰¾GDAL
find_package(GDAL CONFIG QUIET)
if(NOT GDAL_FOUND)
    find_package(GDAL MODULE REQUIRED)
endif()

# æŸ¥æ‰¾GEOS
find_package(geos CONFIG QUIET)
if(NOT geos_FOUND)
    # å¦‚æœCONFIGæ¨¡å¼å¤±è´¥ï¼Œå°è¯•MODULEæ¨¡å¼
    find_package(PkgConfig QUIET)
    if(PkgConfig_FOUND)
        pkg_check_modules(GEOS geos)
    endif()
    
    if(NOT GEOS_FOUND)
        # æ‰‹åŠ¨æŸ¥æ‰¾GEOS
        find_path(GEOS_INCLUDE_DIR geos_c.h
            PATHS 
                "${CMAKE_PREFIX_PATH}/include"
                "C:/Users/Administrator/vcpkg/installed/x64-windows/include"
                /usr/include /usr/local/include
            PATH_SUFFIXES geos)
        
        find_library(GEOS_C_LIBRARY NAMES geos_c
            PATHS 
                "${CMAKE_PREFIX_PATH}/lib"
                "C:/Users/Administrator/vcpkg/installed/x64-windows/lib"
                /usr/lib /usr/local/lib)
        
        find_library(GEOS_LIBRARY NAMES geos
            PATHS 
                "${CMAKE_PREFIX_PATH}/lib"
                "C:/Users/Administrator/vcpkg/installed/x64-windows/lib"
                /usr/lib /usr/local/lib)
        
        if(GEOS_INCLUDE_DIR AND GEOS_C_LIBRARY AND GEOS_LIBRARY)
            set(GEOS_FOUND TRUE)
            set(GEOS_INCLUDE_DIRS ${GEOS_INCLUDE_DIR})
            set(GEOS_LIBRARIES ${GEOS_C_LIBRARY} ${GEOS_LIBRARY})
            message(STATUS "Found GEOS manually:")
            message(STATUS "  GEOS_INCLUDE_DIRS: ${GEOS_INCLUDE_DIRS}")
            message(STATUS "  GEOS_LIBRARIES: ${GEOS_LIBRARIES}")
        endif()
    endif()
else()
    set(GEOS_FOUND TRUE)
    message(STATUS "Found GEOS via CONFIG mode")
endif()

if(NOT GEOS_FOUND)
    message(WARNING "GEOS not found. Some spatial operations may not be available.")
endif()

# å®šä¹‰æ ¸å¿ƒå¿…è¦çš„æºæ–‡ä»¶
set(CORE_SOURCES
    src/impl/spatial_ops_service_impl.cpp
    src/impl/spatial_ops_service_factory.cpp
    src/impl/spatial_config_manager.cpp
)

# å®šä¹‰æ …æ ¼å¤„ç†æºæ–‡ä»¶
set(RASTER_SOURCES
    src/engine/raster_engine.cpp
    src/raster/raster_clipping.cpp
    src/raster/raster_algebra.cpp
    src/raster/raster_statistics.cpp
    src/raster/raster_vectorization.cpp
)

# å®šä¹‰å‡ ä½•å¤„ç†æºæ–‡ä»¶
set(GEOMETRY_SOURCES
    src/engine/geometry_engine.cpp
)

# å®šä¹‰æŸ¥è¯¢æºæ–‡ä»¶
set(QUERY_SOURCES
    src/engine/query_engine.cpp
)

# å®šä¹‰å·¥å…·æºæ–‡ä»¶
set(UTILS_SOURCES
    src/utils/spatial_utils.cpp
    src/utils/geometry_converter.cpp
    src/utils/coordinate_validator.cpp
)

# å®šä¹‰ç®—æ³•æ”¯æŒæºæ–‡ä»¶
set(ALGORITHM_SOURCES
    # src/algorithms/interpolation_spatial_support_impl.cpp  # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæš‚æ—¶æ³¨é‡Š
    src/algorithms/tile_spatial_support_impl.cpp
    src/algorithms/modeling_spatial_support_impl.cpp
)

# å®šä¹‰å¼•æ“æºæ–‡ä»¶
set(ENGINE_SOURCES
    src/engine/spatial_index_manager.cpp
    src/engine/spatial_parallel_coordinator.cpp
)

# å®šä¹‰ç´¢å¼•æºæ–‡ä»¶
set(INDEX_SOURCES
    src/index/quad_tree_index.cpp
    src/index/grid_index.cpp
    src/index/r_tree_index.cpp
    src/index/index_builder.cpp
)

# å®šä¹‰åŸºç¡€è®¾æ–½æºæ–‡ä»¶ï¼ˆç§»é™¤ä¸å­˜åœ¨çš„performance_monitor.cppï¼‰
set(INFRASTRUCTURE_SOURCES
    # src/infrastructure/performance_monitor_ext.cpp
    # src/infrastructure/gdal_performance_manager.cpp
)

# åˆ›å»ºé™æ€åº“
add_library(${SPATIAL_OPS_SERVICE_LIB_NAME} STATIC 
    ${CORE_SOURCES}
    ${RASTER_SOURCES}
    ${GEOMETRY_SOURCES}
    ${QUERY_SOURCES}
    ${UTILS_SOURCES}
    ${ALGORITHM_SOURCES}
    ${ENGINE_SOURCES}
    ${INDEX_SOURCES}
    ${INFRASTRUCTURE_SOURCES}
)

# ğŸ¯ è§£å†³UTF-8ç¼–è¯‘é€‰é¡¹å†²çª
if(MSVC)
    get_target_property(SPS_COMPILE_OPTIONS ${SPATIAL_OPS_SERVICE_LIB_NAME} COMPILE_OPTIONS)
    if(SPS_COMPILE_OPTIONS)
        string(REPLACE "/utf-8" "" SPS_COMPILE_OPTIONS "${SPS_COMPILE_OPTIONS}")
        set_target_properties(${SPATIAL_OPS_SERVICE_LIB_NAME} PROPERTIES COMPILE_OPTIONS "${SPS_COMPILE_OPTIONS}")
        message(STATUS "[Spatial Ops Service] Removed conflicting /utf-8 option to defer to top-level setting.")
    endif()
endif()

# è®¾ç½®åº“çš„åˆ«å
add_library(OSCEAN::${SPATIAL_OPS_SERVICE_LIB_NAME} ALIAS ${SPATIAL_OPS_SERVICE_LIB_NAME})

# åŒ…å«ç›®å½•
target_include_directories(${SPATIAL_OPS_SERVICE_LIB_NAME}
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include>
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${CMAKE_CURRENT_SOURCE_DIR}/../../core_service_interfaces/include
        ${CMAKE_CURRENT_SOURCE_DIR}/../../common_utilities/include
)

# é“¾æ¥ä¾èµ–åº“
target_link_libraries(${SPATIAL_OPS_SERVICE_LIB_NAME}
    PUBLIC
        GDAL::GDAL
        Boost::system
        Boost::thread
        Boost::filesystem
    PRIVATE
        common_utilities
)

# å¦‚æœæ‰¾åˆ°GEOSï¼Œæ·»åŠ GEOSæ”¯æŒ
if(GEOS_FOUND)
    if(TARGET GEOS::geos_c)
        # ä½¿ç”¨vcpkgæä¾›çš„CMakeç›®æ ‡
        target_link_libraries(${SPATIAL_OPS_SERVICE_LIB_NAME} PRIVATE GEOS::geos_c)
        message(STATUS "Linking GEOS via CMake target: GEOS::geos_c")
    elseif(TARGET geos_c)
        # å¤‡é€‰ç›®æ ‡åç§°
        target_link_libraries(${SPATIAL_OPS_SERVICE_LIB_NAME} PRIVATE geos_c)
        message(STATUS "Linking GEOS via CMake target: geos_c")
    elseif(GEOS_LIBRARIES)
        # ä½¿ç”¨æ‰‹åŠ¨æŸ¥æ‰¾çš„åº“
        target_include_directories(${SPATIAL_OPS_SERVICE_LIB_NAME} PRIVATE ${GEOS_INCLUDE_DIRS})
        target_link_libraries(${SPATIAL_OPS_SERVICE_LIB_NAME} PRIVATE ${GEOS_LIBRARIES})
        message(STATUS "Linking GEOS via manual libraries: ${GEOS_LIBRARIES}")
    endif()
    
    # æ·»åŠ GEOSç¼–è¯‘å®šä¹‰
    target_compile_definitions(${SPATIAL_OPS_SERVICE_LIB_NAME} PRIVATE GEOS_FOUND=1)
endif()

# æ·»åŠ ç¼–è¯‘å®šä¹‰
target_compile_definitions(${SPATIAL_OPS_SERVICE_LIB_NAME}
    PRIVATE
        GDAL_FOUND=1
        BOOST_THREAD_PROVIDES_FUTURE=1
        BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION=1
        BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY=1
)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹
if(MSVC)
    target_compile_options(${SPATIAL_OPS_SERVICE_LIB_NAME} PRIVATE
        /W3
        /wd4996  # ç¦ç”¨å·²å¼ƒç”¨å‡½æ•°è­¦å‘Š
        /wd4251  # ç¦ç”¨DLLæ¥å£è­¦å‘Š
    )
else()
    target_compile_options(${SPATIAL_OPS_SERVICE_LIB_NAME} PRIVATE
        -Wall
        -Wextra
        -Wno-deprecated-declarations
    )
endif()

# å®‰è£…é…ç½®
install(TARGETS ${SPATIAL_OPS_SERVICE_LIB_NAME}
    EXPORT SpatialOpsServiceTargets
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    RUNTIME DESTINATION bin
    INCLUDES DESTINATION include
)

# ===================================================================
# æµ‹è¯•é…ç½®
# ===================================================================

# å¯ç”¨æµ‹è¯•å¹¶æ£€æŸ¥ä¾èµ–
if(BUILD_TESTING)
    message(STATUS "ğŸ§ª [ç©ºé—´æœåŠ¡] å¯ç”¨æµ‹è¯•å¥—ä»¶")
    
    # æŸ¥æ‰¾Google Test
    find_package(GTest REQUIRED)
    
    if(GTest_FOUND)
        message(STATUS "âœ… [ç©ºé—´æœåŠ¡] æ‰¾åˆ° Google Test")
        
        # æ£€æŸ¥æµ‹è¯•ç›®å½•æ˜¯å¦å­˜åœ¨
        if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/tests")
            message(STATUS "ğŸ“ [ç©ºé—´æœåŠ¡] æ·»åŠ æµ‹è¯•ç›®å½•")
            add_subdirectory(tests)
        else()
            message(WARNING "âš ï¸ [ç©ºé—´æœåŠ¡] æµ‹è¯•ç›®å½•ä¸å­˜åœ¨: ${CMAKE_CURRENT_SOURCE_DIR}/tests")
        endif()
    else()
        message(WARNING "âš ï¸ [ç©ºé—´æœåŠ¡] Google Test æœªæ‰¾åˆ°ï¼Œè·³è¿‡æµ‹è¯•")
    endif()
else()
    message(STATUS "ğŸ”‡ [ç©ºé—´æœåŠ¡] æµ‹è¯•è¢«ç¦ç”¨")
endif()

# ===================================================================

install(DIRECTORY include/
    DESTINATION include
    FILES_MATCHING PATTERN "*.h" PATTERN "*.hpp"
)

install(EXPORT SpatialOpsServiceTargets
    FILE SpatialOpsServiceTargets.cmake
    NAMESPACE OSCEAN::
    DESTINATION lib/cmake/SpatialOpsService
) 