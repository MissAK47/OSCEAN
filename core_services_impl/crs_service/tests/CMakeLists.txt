cmake_minimum_required(VERSION 3.17)
project(crs_service_tests LANGUAGES CXX)

message(STATUS "[CRS Tests] ğŸ§ª Configuring modern CRS service test suite")

# ğŸ¯ C++17æ ‡å‡†ï¼ˆä¸ä¸»é¡¹ç›®ä¿æŒä¸€è‡´ï¼‰
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# === ğŸ” ä¾èµ–æŸ¥æ‰¾ ===

# GTestæ˜¯å¿…éœ€çš„
find_package(GTest CONFIG REQUIRED)
if(NOT TARGET GTest::gtest_main OR NOT TARGET GTest::gmock)
    message(FATAL_ERROR "GTest targets not found. Ensure GTest is properly installed.")
endif()

# ç¡®ä¿æ ¸å¿ƒä¾èµ–å­˜åœ¨
if(NOT TARGET crs_service)
    message(FATAL_ERROR "crs_service target not found.")
endif()

if(NOT TARGET common_utilities) 
    message(FATAL_ERROR "common_utilities target not found.")
endif()

# === ğŸ“‹ æµ‹è¯•æºæ–‡ä»¶ ===

set(TEST_SOURCES
    # ğŸ”„ ç°ä»£åŒ–æµ‹è¯•å¥—ä»¶ï¼ˆä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œé¿å…å•ä¾‹æ¨¡å¼ï¼‰
    modern_crs_service_tests.cpp          # ä¸»è¦çš„ç°ä»£åŒ–æµ‹è¯•æ–‡ä»¶
    
    # ğŸ¯ å…¨é¢åŠŸèƒ½æµ‹è¯•å¥—ä»¶
    comprehensive_crs_tests.cpp           # å…¨é¢çš„CRSåŠŸèƒ½å’Œæ€§èƒ½æµ‹è¯•
    
    # ğŸ—ºï¸ GDAL/OGRé›†æˆæµ‹è¯•
    crs_gdal_integration_tests.cpp        # CRSä¸GDAL/OGRçš„é›†æˆæµ‹è¯•
    
    # ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
    $<$<BOOL:${ENABLE_BENCHMARKS}>:benchmark_main.cpp>
    $<$<BOOL:${ENABLE_BENCHMARKS}>:crs_benchmarks.cpp>
)

# === ğŸ¯ å¤šä¸ªæµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶ ===

# åŸºç¡€ç°ä»£åŒ–æµ‹è¯•
set(MODERN_TEST_TARGET_NAME crs_service_tests)
add_executable(${MODERN_TEST_TARGET_NAME} 
    modern_crs_service_tests.cpp
)

# å…¨é¢åŠŸèƒ½æµ‹è¯•
set(COMPREHENSIVE_TEST_TARGET_NAME crs_comprehensive_tests)
add_executable(${COMPREHENSIVE_TEST_TARGET_NAME} 
    comprehensive_crs_tests.cpp
)

# GDALé›†æˆæµ‹è¯•
set(GDAL_TEST_TARGET_NAME crs_gdal_integration_tests)
add_executable(${GDAL_TEST_TARGET_NAME} 
    crs_gdal_integration_tests.cpp
)

# PROJåº“è¯Šæ–­æµ‹è¯•
set(PROJ_DIAGNOSTICS_TARGET_NAME crs_proj_diagnostics)
add_executable(${PROJ_DIAGNOSTICS_TARGET_NAME} 
    crs_proj_diagnostics.cpp
)

# å¤§è§„æ¨¡å‹åŠ›æµ‹è¯•
set(STRESS_TEST_TARGET_NAME crs_stress_tests)
add_executable(${STRESS_TEST_TARGET_NAME} 
    crs_stress_tests.cpp
)

# æåœ°æŠ•å½±å¢å¼ºæµ‹è¯•
set(POLAR_ENHANCED_TEST_TARGET_NAME crs_polar_enhanced_tests)
add_executable(${POLAR_ENHANCED_TEST_TARGET_NAME} 
    polar_projection_enhanced_tests.cpp
)

# ç®€åŒ–çš„NetCDFæµ‹è¯•
set(SIMPLE_NETCDF_TEST_TARGET_NAME simple_netcdf_test)
add_executable(${SIMPLE_NETCDF_TEST_TARGET_NAME} 
    simple_netcdf_test.cpp
)

# === ğŸ§ª CTesté›†æˆé…ç½® ===
include(GoogleTest)

# === ğŸ¯ ä¸ºæ‰€æœ‰æµ‹è¯•ç›®æ ‡é…ç½®é€šç”¨å‡½æ•° ===

function(configure_crs_test_target TARGET_NAME)
    # === ğŸ“¦ ä¾èµ–åº“é“¾æ¥ ===
    target_link_libraries(${TARGET_NAME} PRIVATE
        # ğŸ¯ è¢«æµ‹è¯•çš„åº“
        crs_service
        
        # ğŸš€ Commonæ¨¡å—ä¾èµ–
        common_utilities
        
        # ğŸ”— æ ¸å¿ƒæ¥å£
        core_service_interfaces
        
        # ğŸ§ª æµ‹è¯•æ¡†æ¶
        GTest::gtest_main
        GTest::gmock
        
        # ğŸ“ åœ°ç†ç©ºé—´åº“
        PROJ::proj
        GDAL::GDAL
        
        # ğŸš€ æ—¥å¿—ç³»ç»Ÿ
        spdlog::spdlog
        
        # Boostå¼‚æ­¥æ”¯æŒ
        Boost::system
        Boost::thread
        Boost::chrono
    )

    # === ğŸ“‚ åŒ…å«ç›®å½• ===
    target_include_directories(${TARGET_NAME} PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${CMAKE_CURRENT_SOURCE_DIR}/../src         # CRSå†…éƒ¨æºç 
        ${CMAKE_CURRENT_SOURCE_DIR}/../src/impl    # å®ç°ç»†èŠ‚
        ${CMAKE_CURRENT_SOURCE_DIR}/../include     # å…¬å…±æ¥å£
    )

    # === ğŸ—ï¸ ç¼–è¯‘é€‰é¡¹ ===
    target_compile_definitions(${TARGET_NAME} PRIVATE
        # ğŸ§ª æµ‹è¯•ç¯å¢ƒå®šä¹‰
        OSCEAN_CRS_TESTING_MODE=1
        OSCEAN_TESTING_ENABLED=1
        
        # ğŸš€ å¯ç”¨æ‰€æœ‰ç°ä»£åŒ–ç‰¹æ€§
        OSCEAN_CRS_SIMD_ENABLED=1
        OSCEAN_CRS_PERFORMANCE_MONITORING=1
        OSCEAN_CRS_STREAMING_ENABLED=1
        
        # ğŸ”§ æ—¥å¿—çº§åˆ«ï¼ˆæµ‹è¯•æ—¶æ›´è¯¦ç»†ï¼‰
        SPDLOG_ACTIVE_LEVEL=SPDLOG_LEVEL_TRACE
    )

    if(MSVC)
        target_compile_options(${TARGET_NAME} PRIVATE 
            /EHsc /permissive- /FS              # ç§»é™¤/utf-8é¿å…å†²çªï¼Œæ·»åŠ /FSé¿å…PDBå†²çª
            $<$<CONFIG:Debug>:/Od /RTC1>        # Debugä¼˜åŒ–
            $<$<CONFIG:Release>:/O2 /arch:AVX2> # Releaseä¼˜åŒ–
        )
        
        target_compile_definitions(${TARGET_NAME} PRIVATE
            _WIN32_WINNT=0x0A00 NOMINMAX WIN32_LEAN_AND_MEAN
            _CRT_SECURE_NO_WARNINGS
        )
    endif()

    # === ğŸ¯ ç›®æ ‡å±æ€§ ===
    set_target_properties(${TARGET_NAME} PROPERTIES
        CXX_STANDARD 17
        CXX_STANDARD_REQUIRED ON
        CXX_EXTENSIONS OFF
        
        # è¾“å‡ºç›®å½•
        RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
        
        # æµ‹è¯•æ‰§è¡Œå±æ€§
        VS_DEBUGGER_WORKING_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    )

    # === ğŸ§ª CTesté›†æˆ ===
    gtest_discover_tests(${TARGET_NAME}
        WORKING_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
        PROPERTIES VS_DEBUGGER_WORKING_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    )
endfunction()

# é…ç½®æ‰€æœ‰æµ‹è¯•ç›®æ ‡
configure_crs_test_target(${MODERN_TEST_TARGET_NAME})
configure_crs_test_target(${COMPREHENSIVE_TEST_TARGET_NAME})
configure_crs_test_target(${GDAL_TEST_TARGET_NAME})
configure_crs_test_target(${PROJ_DIAGNOSTICS_TARGET_NAME})
configure_crs_test_target(${STRESS_TEST_TARGET_NAME})
configure_crs_test_target(${POLAR_ENHANCED_TEST_TARGET_NAME})
configure_crs_test_target(${SIMPLE_NETCDF_TEST_TARGET_NAME})

# === ä¸ºå…¼å®¹æ€§ä¿ç•™åŸå§‹ç›®æ ‡ ===
set(TEST_TARGET_NAME ${MODERN_TEST_TARGET_NAME})  # å…¼å®¹æ€§åˆ«å

# === ğŸ“„ DLLå¤åˆ¶ï¼ˆWindowsï¼‰- ä¸ºæ‰€æœ‰æµ‹è¯•ç›®æ ‡ ===

if(WIN32)
    set(VCPKG_BIN_DIR "C:/Users/Administrator/vcpkg/installed/x64-windows/bin")
    set(VCPKG_DEBUG_BIN_DIR "C:/Users/Administrator/vcpkg/installed/x64-windows/debug/bin")
    
    set(OUTPUT_DEBUG_DIR "${CMAKE_BINARY_DIR}/bin/Debug")
    set(OUTPUT_RELEASE_DIR "${CMAKE_BINARY_DIR}/bin/Release")
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    file(MAKE_DIRECTORY ${OUTPUT_DEBUG_DIR})
    file(MAKE_DIRECTORY ${OUTPUT_RELEASE_DIR})
    
    # å¤åˆ¶å¿…éœ€çš„DLL - å¯¹æ‰€æœ‰æµ‹è¯•ç›®æ ‡åº”ç”¨
    set(ALL_TEST_TARGETS 
        ${MODERN_TEST_TARGET_NAME}
        ${COMPREHENSIVE_TEST_TARGET_NAME}
        ${GDAL_TEST_TARGET_NAME}
        ${PROJ_DIAGNOSTICS_TARGET_NAME}
        ${STRESS_TEST_TARGET_NAME}
        ${POLAR_ENHANCED_TEST_TARGET_NAME}
    )
    
    foreach(TARGET_NAME ${ALL_TEST_TARGETS})
        foreach(DLL_NAME "proj_9.dll" "gdal.dll")
            if(EXISTS "${VCPKG_BIN_DIR}/${DLL_NAME}")
                add_custom_command(TARGET ${TARGET_NAME} POST_BUILD
                    COMMAND ${CMAKE_COMMAND} -E copy_if_different
                    "${VCPKG_BIN_DIR}/${DLL_NAME}"
                    "${OUTPUT_RELEASE_DIR}/${DLL_NAME}"
                    COMMENT "Copying ${DLL_NAME} to release directory for ${TARGET_NAME}"
                )
                
                # Debugç‰ˆæœ¬
                if(EXISTS "${VCPKG_DEBUG_BIN_DIR}/${DLL_NAME}")
                    add_custom_command(TARGET ${TARGET_NAME} POST_BUILD
                        COMMAND ${CMAKE_COMMAND} -E copy_if_different
                        "${VCPKG_DEBUG_BIN_DIR}/${DLL_NAME}"
                        "${OUTPUT_DEBUG_DIR}/${DLL_NAME}"
                        COMMENT "Copying debug ${DLL_NAME} to debug directory for ${TARGET_NAME}"
                    )
                else()
                    add_custom_command(TARGET ${TARGET_NAME} POST_BUILD
                        COMMAND ${CMAKE_COMMAND} -E copy_if_different
                        "${VCPKG_BIN_DIR}/${DLL_NAME}"
                        "${OUTPUT_DEBUG_DIR}/${DLL_NAME}"
                        COMMENT "Copying release ${DLL_NAME} to debug directory for ${TARGET_NAME}"
                    )
                endif()
            endif()
        endforeach()
    endforeach()
endif()

# === ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯é€‰ï¼‰===

option(ENABLE_BENCHMARKS "Enable performance benchmarks" OFF)

if(ENABLE_BENCHMARKS)
    find_package(benchmark CONFIG)
    if(TARGET benchmark::benchmark)
        message(STATUS "[CRS Tests] ğŸ“Š Performance benchmarks enabled")
        
        # ä¸ºæ‰€æœ‰æµ‹è¯•ç›®æ ‡å¯ç”¨åŸºå‡†æµ‹è¯•
        foreach(TARGET_NAME ${ALL_TEST_TARGETS})
            target_compile_definitions(${TARGET_NAME} PRIVATE ENABLE_BENCHMARKS=1)
            target_link_libraries(${TARGET_NAME} PRIVATE benchmark::benchmark)
        endforeach()
    else()
        message(WARNING "[CRS Tests] âš ï¸ Google Benchmark not found, benchmarks disabled")
    endif()
endif()

message(STATUS "[CRS Tests] âœ… Modern test suite configuration complete!") 
message(STATUS "[CRS Tests] ğŸ¯ Test targets created:")
message(STATUS "  ğŸ“ ${MODERN_TEST_TARGET_NAME} - Basic modern CRS tests")
message(STATUS "  ğŸ¯ ${COMPREHENSIVE_TEST_TARGET_NAME} - Comprehensive CRS test suite")
message(STATUS "  ğŸ—ºï¸ ${GDAL_TEST_TARGET_NAME} - GDAL/OGR integration tests")
message(STATUS "  ğŸ¯ ${PROJ_DIAGNOSTICS_TARGET_NAME} - PROJ library diagnostics")
message(STATUS "  ğŸ¯ ${STRESS_TEST_TARGET_NAME} - Stress tests") 