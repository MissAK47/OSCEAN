cmake_minimum_required(VERSION 3.20)
project(OSCEAN VERSION 1.0.0 LANGUAGES CXX C)

# ğŸš€ æ–°å¢ï¼šå®šä¹‰é¡¹ç›®æ ¹ç›®å½•å®ï¼Œä¾›ä»£ç ä½¿ç”¨
add_definitions(-DPROJECT_SOURCE_DIR="${CMAKE_SOURCE_DIR}")
message(STATUS "PROJECT_SOURCE_DIR set to: ${CMAKE_SOURCE_DIR}")

cmake_policy(SET CMP0167 NEW) # è§£å†³ FindBoost CMP0167 è­¦å‘Š

# Set PowerShell executable path for vcpkg script execution
set(PowerShell_EXECUTABLE "C:/WINDOWS/System32/WindowsPowerShell/v1.0/powershell.exe" CACHE FILEPATH "Path to PowerShell executable")
message(STATUS "Set PowerShell_EXECUTABLE to: ${PowerShell_EXECUTABLE}")

# å…¨å±€å®å®šä¹‰
add_definitions(-DBOOST_THREAD_PROVIDES_FUTURE_CONTINUATION)
message(STATUS "Added global macro definition: BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION")

# è§£å†³VCPKG_ROOTå’ŒGDALæ•°æ®ç›®å½•çš„è®¾ç½®
if(DEFINED ENV{VCPKG_ROOT})
    set(OSCEAN_GDAL_DATA_PATH "$ENV{VCPKG_ROOT}/installed/x64-windows/share/gdal" CACHE PATH "Path to GDAL data directory")
else()
    set(VCPKG_ROOT "D:/vcpkg" CACHE STRING "Path to vcpkg installation")
    set(OSCEAN_GDAL_DATA_PATH "${VCPKG_ROOT}/installed/x64-windows/share/gdal" CACHE PATH "Path to GDAL data directory")
    message(WARNING "VCPKG_ROOT environment variable not found. Using default path: ${VCPKG_ROOT}")
endif()
message(STATUS "GDAL_DATA_PATH set to: ${OSCEAN_GDAL_DATA_PATH}")

if(NOT EXISTS "${OSCEAN_GDAL_DATA_PATH}")
    message(WARNING "GDAL_DATA_PATH does not exist: ${OSCEAN_GDAL_DATA_PATH}. Tests requiring GDAL may fail.")
endif()

# PROJè·¯å¾„è®¾ç½®
set(OSCEAN_PROJ_DATA_PATH "${VCPKG_ROOT}/installed/x64-windows/share/proj" CACHE PATH "Path to PROJ data directory")
message(STATUS "PROJ_DATA_PATH set to: ${OSCEAN_PROJ_DATA_PATH}")

# Function to set GDAL_DATA environment variable for a list of test targets
function(oscean_set_gdal_data_for_tests)
    if(NOT DEFINED OSCEAN_GDAL_DATA_PATH OR OSCEAN_GDAL_DATA_PATH STREQUAL "")
        message(WARNING "OSCEAN_GDAL_DATA_PATH is not set. Cannot set GDAL_DATA for tests.")
        return()
    endif()
    message(DEBUG "oscean_set_gdal_data_for_tests called with ARGN: ${ARGN}")
    foreach(test_target_or_list ${ARGN})
        set_tests_properties(${test_target_or_list}
            PROPERTIES
            ENVIRONMENT "GDAL_DATA=${OSCEAN_GDAL_DATA_PATH};PROJ_LIB=${OSCEAN_PROJ_DATA_PATH}"
        )
        message(STATUS "Set environment variables for test target(s): ${test_target_or_list}")
        message(STATUS "  GDAL_DATA: ${OSCEAN_GDAL_DATA_PATH}")
        message(STATUS "  PROJ_LIB: ${OSCEAN_PROJ_DATA_PATH}")
    endforeach()
endfunction()

# ä¸ºCRSæœåŠ¡æµ‹è¯•åˆ›å»ºä¸“é—¨çš„ç¯å¢ƒè®¾ç½®å‡½æ•°
function(oscean_set_crs_test_environment target_name)
    if(TARGET ${target_name})
        set_tests_properties(${target_name}
            PROPERTIES
            ENVIRONMENT "GDAL_DATA=${OSCEAN_GDAL_DATA_PATH};PROJ_LIB=${OSCEAN_PROJ_DATA_PATH};OSCEAN_CRS_SERVICE_ENABLED=${OSCEAN_CRS_SERVICE_ENABLED}"
        )
        message(STATUS "Set CRS service test environment for: ${target_name}")
    endif()
endfunction()

# --- vcpkg Integration & Dependency Finding ---
# IMPORTANT: Ensure CMake is configured with -DCMAKE_TOOLCHAIN_FILE=[path/to/vcpkg]/scripts/buildsystems/vcpkg.cmake

# ç¡®ä¿vcpkg toolchainæ–‡ä»¶å·²æ­£ç¡®åº”ç”¨
if(NOT DEFINED CMAKE_TOOLCHAIN_FILE)
    message(FATAL_ERROR "CMAKE_TOOLCHAIN_FILE not defined. Please configure CMake with -DCMAKE_TOOLCHAIN_FILE=[path/to/vcpkg]/scripts/buildsystems/vcpkg.cmake")
endif()

message(STATUS "Using vcpkg toolchain file: ${CMAKE_TOOLCHAIN_FILE}")

# ====================================================================
# GPUæ”¯æŒæ£€æµ‹ - ä½¿ç”¨æ–°çš„GPUæ£€æµ‹æ¨¡å—
# ====================================================================
include(cmake/gpu_detection.cmake)

# æ£€æµ‹GPUæ”¯æŒ
oscean_detect_gpu_support()

# Find all required packages using vcpkg
find_package(GDAL CONFIG REQUIRED)  # Add CONFIG keyword
# æ˜¾å¼æ‰“å°GDALä¿¡æ¯
message(STATUS "GDAL information:")
message(STATUS "  GDAL_FOUND: ${GDAL_FOUND}")
message(STATUS "  GDAL_VERSION: ${GDAL_VERSION}")
message(STATUS "  GDAL_INCLUDE_DIRS: ${GDAL_INCLUDE_DIRS}")
message(STATUS "  GDAL_LIBRARIES: ${GDAL_LIBRARIES}")

# ä½¿ç”¨REQUIREDç¡®ä¿å¦‚æœæ‰¾ä¸åˆ°éœ€è¦çš„ç»„ä»¶ä¼šæŠ¥é”™è€Œä¸æ˜¯é»˜é»˜å¤±è´¥
find_package(Boost REQUIRED COMPONENTS system thread filesystem date_time)
message(STATUS "Boost information:")
message(STATUS "  Boost_FOUND: ${Boost_FOUND}")
message(STATUS "  Boost_VERSION: ${Boost_VERSION}")

find_package(GTest CONFIG REQUIRED) # ä½¿ç”¨ CONFIG æ¨¡å¼å¹¶ä¿®æ­£å¤§å°å†™

# === SQLite3 é…ç½®ï¼ˆå…ƒæ•°æ®æœåŠ¡å¿…éœ€ï¼‰ ===
message(STATUS "æ­£åœ¨æŸ¥æ‰¾ SQLite3...")

# é¦–å…ˆå°è¯•æ ‡å‡†çš„ SQLite3 æŸ¥æ‰¾
find_package(SQLite3 QUIET)

if(SQLite3_FOUND)
    message(STATUS "æ‰¾åˆ°æ ‡å‡† SQLite3:")
    message(STATUS "  SQLite3_INCLUDE_DIRS: ${SQLite3_INCLUDE_DIRS}")
    message(STATUS "  SQLite3_LIBRARIES: ${SQLite3_LIBRARIES}")
    message(STATUS "  SQLite3_VERSION: ${SQLite3_VERSION}")
else()
    message(STATUS "æ ‡å‡† SQLite3 æœªæ‰¾åˆ°ï¼Œå°è¯• vcpkg çš„ unofficial-sqlite3...")
    
    # å°è¯• vcpkg ç‰¹å®šçš„ unofficial-sqlite3
    find_package(unofficial-sqlite3 CONFIG QUIET)
    
    if(unofficial-sqlite3_FOUND)
        message(STATUS "æ‰¾åˆ° unofficial-sqlite3")
        
        # åˆ›å»ºå…¼å®¹çš„ SQLite::SQLite3 ç›®æ ‡åˆ«å
        if(NOT TARGET SQLite::SQLite3)
            if(TARGET unofficial::sqlite3::sqlite3)
                add_library(SQLite::SQLite3 ALIAS unofficial::sqlite3::sqlite3)
                message(STATUS "åˆ›å»º SQLite::SQLite3 åˆ«åæŒ‡å‘ unofficial::sqlite3::sqlite3")
            else()
                # æ‰‹åŠ¨åˆ›å»ºæ¥å£åº“
                add_library(SQLite::SQLite3 INTERFACE IMPORTED)
                set_target_properties(SQLite::SQLite3 PROPERTIES
                    INTERFACE_LINK_LIBRARIES "unofficial::sqlite3::sqlite3"
                )
                message(STATUS "åˆ›å»º SQLite::SQLite3 æ¥å£åº“")
            endif()
        endif()
        set(SQLite3_FOUND TRUE)
    else()
        # å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•æ‰‹åŠ¨æŸ¥æ‰¾
        message(STATUS "å°è¯•æ‰‹åŠ¨æŸ¥æ‰¾ sqlite3...")
        
        # æ£€æŸ¥vcpkgå®‰è£…ç›®å½•
        if(DEFINED ENV{VCPKG_ROOT})
            set(VCPKG_INSTALLED_DIR "$ENV{VCPKG_ROOT}/installed/x64-windows")
        else()
            set(VCPKG_INSTALLED_DIR "D:/vcpkg/installed/x64-windows")
        endif()
        
        find_path(SQLite3_INCLUDE_DIR 
            NAMES sqlite3.h
            PATHS "${VCPKG_INSTALLED_DIR}/include"
            NO_DEFAULT_PATH
        )
        
        find_library(SQLite3_LIBRARY 
            NAMES sqlite3 sqlite3d
            PATHS "${VCPKG_INSTALLED_DIR}/lib" "${VCPKG_INSTALLED_DIR}/debug/lib"
            NO_DEFAULT_PATH
        )
        
        if(SQLite3_INCLUDE_DIR AND SQLite3_LIBRARY)
            message(STATUS "æ‰‹åŠ¨æ‰¾åˆ° SQLite3:")
            message(STATUS "  SQLite3_INCLUDE_DIR: ${SQLite3_INCLUDE_DIR}")
            message(STATUS "  SQLite3_LIBRARY: ${SQLite3_LIBRARY}")
            
            # åˆ›å»º imported target
            add_library(SQLite::SQLite3 UNKNOWN IMPORTED)
            set_target_properties(SQLite::SQLite3 PROPERTIES
                IMPORTED_LOCATION "${SQLite3_LIBRARY}"
                INTERFACE_INCLUDE_DIRECTORIES "${SQLite3_INCLUDE_DIR}"
            )
            set(SQLite3_FOUND TRUE)
        else()
            message(FATAL_ERROR "æ— æ³•æ‰¾åˆ° SQLite3 åº“ï¼è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
            vcpkg install sqlite3:x64-windows
            
            ç„¶åç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ CMAKE_TOOLCHAIN_FILE é…ç½®CMakeï¼š
            cmake -DCMAKE_TOOLCHAIN_FILE=[vcpkg-root]/scripts/buildsystems/vcpkg.cmake ...")
        endif()
    endif()
endif()

if(SQLite3_FOUND)
    message(STATUS "âœ“ SQLite3 é…ç½®å®Œæˆï¼Œå…ƒæ•°æ®æœåŠ¡å¯ä»¥æ­£å¸¸ä½¿ç”¨æ•°æ®åº“åŠŸèƒ½")
else()
    message(FATAL_ERROR "âœ— SQLite3 é…ç½®å¤±è´¥ï¼Œå…ƒæ•°æ®æœåŠ¡å°†æ— æ³•å·¥ä½œ")
endif()

find_package(netCDF CONFIG QUIET)   # å°†netCDFè®¾ä¸ºå¯é€‰é¡¹, ä½¿ç”¨ CONFIG æ¨¡å¼
find_package(spdlog CONFIG REQUIRED)       # Finds spdlog, ä½¿ç”¨ CONFIG æ¨¡å¼
find_package(nlohmann_json CONFIG REQUIRED) # Finds nlohmann_json, ä½¿ç”¨ CONFIG æ¨¡å¼
find_package(Eigen3 CONFIG REQUIRED)       # Finds Eigen3, ä½¿ç”¨ CONFIG æ¨¡å¼
find_package(xxHash CONFIG REQUIRED) # Add CONFIG keyword
# ğŸ”§ ä¿®å¤vcpkgä¾èµ–ä¼ é€’ï¼šå…ˆæ‰¾TIFFï¼Œå†æ‰¾PROJ
find_package(TIFF CONFIG QUIET) # ä½¿ç”¨CONFIGæ¨¡å¼æŸ¥æ‰¾TIFFåº“
if(TIFF_FOUND)
    message(STATUS "[main] âœ… Found TIFF: ${TIFF_VERSION}")
    # åˆ›å»ºç°ä»£åŒ–çš„TIFFç›®æ ‡åˆ«åï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if(NOT TARGET TIFF::TIFF)
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨tiffç›®æ ‡
        if(TARGET tiff)
            add_library(TIFF::TIFF ALIAS tiff)
            message(STATUS "[main] åˆ›å»º TIFF::TIFF åˆ«å")
        endif()
    endif()
else()
    message(WARNING "[main] TIFF library not found. PROJ functionality may be limited.")
endif()

# æŸ¥æ‰¾PROJåº“ - ä½¿ç”¨æ›´å¥å£®çš„æ–¹å¼
# é¦–å…ˆå°è¯•æ ‡å‡†çš„CONFIGæ¨¡å¼
find_package(PROJ CONFIG QUIET)

if(NOT PROJ_FOUND)
    # ç›´æ¥ä½¿ç”¨å·²çŸ¥çš„vcpkgè·¯å¾„
    set(PROJ_ROOT "C:/Users/Administrator/vcpkg/installed/x64-windows")
    find_package(PROJ CONFIG QUIET HINTS "${PROJ_ROOT}/share/proj")
endif()

if(NOT PROJ_FOUND)
    # å¦‚æœCONFIGæ¨¡å¼å¤±è´¥ï¼Œå°è¯•æŒ‡å®švcpkgè·¯å¾„
    if(DEFINED ENV{VCPKG_ROOT})
        set(PROJ_ROOT "$ENV{VCPKG_ROOT}/installed/${VCPKG_TARGET_TRIPLET}")
        find_package(PROJ CONFIG QUIET HINTS "${PROJ_ROOT}/share/proj")
    endif()
endif()

if(NOT PROJ_FOUND)
    # æœ€åå°è¯•ä¼ ç»Ÿçš„æŸ¥æ‰¾æ¨¡å¼
    find_package(PROJ QUIET)
endif()

if(PROJ_FOUND)
    message(STATUS "[main] âœ… PROJ_FOUND: ${PROJ_FOUND}")
    message(STATUS "[main] PROJ_VERSION: ${PROJ_VERSION}")
    if(TARGET PROJ::proj)
        message(STATUS "[main] PROJ::proj target available")
    endif()
else()
    message(WARNING "PROJ library not found. Using PATH: ${OSCEAN_PROJ_DATA_PATH}. Coordinate transformation functionality may be limited.")
    # è®¾ç½®ç¯å¢ƒå˜é‡
    set(ENV{PROJ_LIB} "${OSCEAN_PROJ_DATA_PATH}")
    message(STATUS "Setting environment variable PROJ_LIB to: $ENV{PROJ_LIB}")
endif()

# ä¸»æ¨¡å—
# -----------------------------------------------------------------------------
add_subdirectory(core_service_interfaces)
add_subdirectory(common_utilities)
add_subdirectory(output_generation)
add_subdirectory(core_services_impl)
add_subdirectory(workflow_engine)
add_subdirectory(network_service)  # æ·»åŠ ç½‘ç»œæœåŠ¡å±‚

# Temporarily disable other modules to focus on library compilation
# add_subdirectory(application)
# add_subdirectory(tools)

# æ£€æŸ¥CRSæœåŠ¡æ¨¡å—çš„ç‰¹æ®Šä¾èµ–ï¼ˆPROJåº“ï¼‰
if(PROJ_FOUND)
    message(STATUS "CRS Service: PROJåº“å·²æ‰¾åˆ° (ç‰ˆæœ¬: ${PROJ_VERSION})")
    set(OSCEAN_CRS_SERVICE_ENABLED ON CACHE BOOL "Enable CRS Service module")
else()
    message(WARNING "CRS Service: PROJåº“æœªæ‰¾åˆ°ï¼ŒCRSæœåŠ¡åŠŸèƒ½å¯èƒ½å—é™")
    set(OSCEAN_CRS_SERVICE_ENABLED OFF CACHE BOOL "Enable CRS Service module")
endif()

# ä¸ºCRSæœåŠ¡æ·»åŠ é¢å¤–çš„Boostç»„ä»¶æ”¯æŒ
if(OSCEAN_CRS_SERVICE_ENABLED)
    # CRSæœåŠ¡éœ€è¦é¢å¤–çš„Boostç»„ä»¶
    find_package(Boost REQUIRED COMPONENTS system thread filesystem date_time chrono exception)
    message(STATUS "CRS Service: å·²é…ç½®é¢å¤–Boostç»„ä»¶æ”¯æŒ")
endif()

# Set target Windows version to avoid compiler warnings and potentially use newer APIs
if(WIN32)
  add_compile_definitions(_WIN32_WINNT=0x0A00) # 0x0A00 corresponds to Windows 10
endif()

# --- Global Build Options ---
# ç»Ÿä¸€æµ‹è¯•é…ç½®é€‰é¡¹ï¼Œé¿å…å†²çª
option(BUILD_TESTING "Build the testing tree" ON)

# Set C++ standard to C++17
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF) # Prefer to not use GNU extensions

# Set MSVC specific compile options for C++17 and exception handling
if(MSVC)
  add_compile_options("$<$<COMPILE_LANG_AND_ID:CXX,MSVC>:/EHsc>")
  
  # ä½¿ç”¨/utf-8é€‰é¡¹ç»Ÿä¸€å¤„ç†æºæ–‡ä»¶å’Œæ‰§è¡Œå­—ç¬¦é›†ç¼–ç 
  add_compile_options("$<$<COMPILE_LANG_AND_ID:CXX,MSVC>:/utf-8>")
  
  # ç¦ç”¨ç‰¹å®šçš„è­¦å‘Š
  add_compile_options("$<$<COMPILE_LANG_AND_ID:CXX,MSVC>:/wd4819>")  # ç¦ç”¨ç¼–ç è­¦å‘Š
  add_compile_options("$<$<COMPILE_LANG_AND_ID:CXX,MSVC>:/wd4996>")  # ç¦ç”¨ä¸å®‰å…¨å‡½æ•°è­¦å‘Š
  
  message(STATUS "MSVC: Added UTF-8 encoding support and disabled encoding warnings")
else()
  # For GCC/Clang, -std=c++17 is usually set by CMAKE_CXX_STANDARD
  # Exception handling is typically enabled by default, but you can be explicit
  add_compile_options(-Wall -Wextra -pedantic) # Add other relevant flags
endif()

# --- Consistency Checks (Optional but Recommended) ---
if(MSVC)
  # vcpkg's triplet usually dictates the runtime library, but we can verify/set CMAKE_MSVC_RUNTIME_LIBRARY if needed
  set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>DLL" CACHE STRING "MSVC Runtime library selection")
  message(STATUS "MSVC Runtime Library set to: ${CMAKE_MSVC_RUNTIME_LIBRARY} (Verify consistency with vcpkg triplet)")
endif()

# è®¾ç½®è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# å¯ç”¨æµ‹è¯•ï¼ˆCTestï¼‰
if(BUILD_TESTING)
  enable_testing()
endif()

# æ·»åŠ å®‰è£…é…ç½®
include(GNUInstallDirs) # For CMAKE_INSTALL_LIBDIR etc.
include(InstallRequiredSystemLibraries)
set(CPACK_PACKAGE_VERSION_MAJOR "${PROJECT_VERSION_MAJOR}")
set(CPACK_PACKAGE_VERSION_MINOR "${PROJECT_VERSION_MINOR}")
include(CPack)

# æ‰“å°æœ€ç»ˆé…ç½®ä¿¡æ¯
message(STATUS "OSCEAN Configuration Summary:")
message(STATUS " - Version: ${PROJECT_VERSION}")
message(STATUS " - C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS " - Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS " - Install Prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS " - Using vcpkg toolchain: ${CMAKE_TOOLCHAIN_FILE}")
message(STATUS " - Build Testing: ${BUILD_TESTING}")

# CRSæœåŠ¡çŠ¶æ€æŠ¥å‘Š
if(OSCEAN_CRS_SERVICE_ENABLED)
    message(STATUS " - CRS Service: âœ… ENABLED")
    message(STATUS "   - PROJ Support: ${PROJ_VERSION}")
    message(STATUS "   - GDAL Support: ${GDAL_VERSION}")
else()
    message(STATUS " - CRS Service: âŒ DISABLED (PROJåº“æœªæ‰¾åˆ°)")
endif()

# GPUé…ç½®çŠ¶æ€æŠ¥å‘Š
oscean_print_gpu_summary()

# Output a message indicating the C++ standard being used
message(STATUS "CMAKE_CXX_STANDARD: ${CMAKE_CXX_STANDARD}")
if(MSVC)
    message(STATUS "MSVC Compile Options: ${CMAKE_CXX_FLAGS} ${CMAKE_CXX_FLAGS_DEBUG} ${CMAKE_CXX_FLAGS_RELEASE}")
endif()

# æ³¨æ„ï¼šcomplete_ocean_indexer.cpp æ–‡ä»¶ç›®å‰ä¸å­˜åœ¨ï¼Œå¦‚éœ€è¦è¯·å…ˆåˆ›å»ºè¯¥æ–‡ä»¶
# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç å—ï¼š

# # æ·»åŠ complete_ocean_indexerå¯æ‰§è¡Œæ–‡ä»¶ (å®Œæ•´ç‰ˆæœ¬)
# if(EXISTS "${CMAKE_SOURCE_DIR}/complete_ocean_indexer.cpp")
#     add_executable(complete_ocean_indexer complete_ocean_indexer.cpp)
#     
#     # è®¾ç½®C++17æ ‡å‡†
#     set_target_properties(complete_ocean_indexer PROPERTIES
#         CXX_STANDARD 17
#         CXX_STANDARD_REQUIRED ON
#     )
#     
#     # åŒ…å«ç›®å½• - ä½¿ç”¨ç°ä»£CMakeç›®æ ‡æ–¹å¼
#     target_include_directories(complete_ocean_indexer PRIVATE
#         ${CMAKE_SOURCE_DIR}/core_service_interfaces/include
#         ${CMAKE_SOURCE_DIR}/core_services_impl/metadata_service/include
#         ${CMAKE_SOURCE_DIR}/core_services_impl/data_access_service/include
#     )
#     
#     # é“¾æ¥å¿…è¦çš„åº“
#     target_link_libraries(complete_ocean_indexer PRIVATE
#         netCDF::netcdf
#         SQLite::SQLite3
#     )
#     
#     # è®¾ç½®Windowsç‰¹å®šé€‰é¡¹
#     if(WIN32)
#         target_compile_definitions(complete_ocean_indexer PRIVATE 
#             _WIN32_WINNT=0x0A00
#             NOMINMAX
#             WIN32_LEAN_AND_MEAN
#         )
#         # åˆå¹¶Windowsåº“åˆ°ä¸»è¦çš„é“¾æ¥å‘½ä»¤ä¸­
#         target_link_libraries(complete_ocean_indexer PRIVATE ole32 oleaut32)
#     endif()
#     
#     # è®¾ç½®è¿è¡Œæ—¶è¾“å‡ºç›®å½•
#     set_target_properties(complete_ocean_indexer PROPERTIES
#         RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
#     )
#     
#     message(STATUS "Added complete_ocean_indexer executable target with NetCDF and SQLite support")
# else()
#     message(STATUS "complete_ocean_indexer.cpp not found, skipping executable target")
# endif()

# æµ‹è¯•ç¨‹åºåº”è¯¥åœ¨å„è‡ªæ¨¡å—çš„testsç›®å½•ä¸­æ„å»ºï¼Œè€Œä¸æ˜¯åœ¨æ ¹ç›®å½•

# æ·»åŠ æ•°æ®åº“æ£€æŸ¥å·¥å…·
# add_executable(check_database
#     check_database.cpp
# )

# target_link_libraries(check_database PRIVATE
#     metadata_service
#     SQLite::SQLite3
# )

# target_include_directories(check_database PRIVATE
#     ${CMAKE_CURRENT_SOURCE_DIR}/core_services_impl/metadata_service/include
# )

# set_target_properties(check_database PROPERTIES
#     RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
#     OUTPUT_NAME "check_database"
# )

# åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥å·¥å…·
# =============================================================================
# æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥å·¥å…·
# =============================================================================

# æŸ¥æ‰¾SQLite3
find_package(unofficial-sqlite3 CONFIG REQUIRED)

# åˆ›å»ºæ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥å·¥å…·
# add_executable(check_database_integrity check_database_integrity.cpp)

# target_link_libraries(check_database_integrity
#     PRIVATE
#     metadata_service
#     SQLite::SQLite3
# )

# target_compile_features(check_database_integrity PRIVATE cxx_std_17)

# set_target_properties(check_database_integrity PROPERTIES
#     RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
# )

# æ·»åŠ test_unified_dbå¯æ‰§è¡Œæ–‡ä»¶ - ä¸´æ—¶ç¦ç”¨ï¼Œå› ä¸ºtest_unified.cppæ–‡ä»¶ä¸å­˜åœ¨
# project(test_unified_db)

# set(CMAKE_CXX_STANDARD 17)
# set(CMAKE_CXX_STANDARD_REQUIRED ON)

# # æŸ¥æ‰¾SQLite3
# find_package(unofficial-sqlite3 CONFIG REQUIRED)

# # åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
# add_executable(test_unified_db test_unified.cpp)

# # é“¾æ¥SQLite3
# target_link_libraries(test_unified_db PRIVATE unofficial::sqlite3::sqlite3)

# -----------------------------------------------------------------------------
# æ·»åŠ ç‹¬ç«‹æµ‹è¯•å·¥å…·
# -----------------------------------------------------------------------------
# add_executable(db_inspector tools/db_inspector.cpp)
# # é“¾æ¥SQLite3
# target_link_libraries(db_inspector PRIVATE unofficial::sqlite3::sqlite3)

# -----------------------------------------------------------------------------
# ä¸´æ—¶æµ‹è¯•ç›®æ ‡ - ç”¨äºå¿«é€ŸéªŒè¯æ•°æ®åº“è¿æ¥ç­‰
# -----------------------------------------------------------------------------

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨test_unified.cppæ–‡ä»¶
# if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/test_unified.cpp")
#     message(STATUS "æ‰¾åˆ° test_unified.cppï¼Œæ·»åŠ ä¸´æ—¶æµ‹è¯•ç›®æ ‡ test_unified_db")
    
#     # æ·»åŠ test_unified_dbå¯æ‰§è¡Œæ–‡ä»¶
#     project(test_unified_db)
    
#     # ä¸ºMSVCæ·»åŠ ç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹
#     if(MSVC)
#         add_compile_options(/EHsc /W4 /WX- /MP)
#     endif()
    
#     add_executable(test_unified_db test_unified.cpp)
    
#     # é“¾æ¥SQLite3
#     target_link_libraries(test_unified_db PRIVATE unofficial::sqlite3::sqlite3)
    
# else()
#     message(STATUS "æœªæ‰¾åˆ° test_unified.cppï¼Œè·³è¿‡ä¸´æ—¶æµ‹è¯•ç›®æ ‡")
# endif()


# ==============================================================================
# # ä¹‹å‰çš„ä¸´æ—¶æµ‹è¯•ç›®æ ‡ (å·²æ³¨é‡Š)
# ==============================================================================
# add_executable(test_unified_db test_unified.cpp)

# # # é“¾æ¥ SQLite
# # target_link_libraries(test_unified_db PRIVATE unofficial::sqlite3::sqlite3)
# ==============================================================================

# ====================================================================
# 11. Testing Configuration
# ====================================================================
# The entire if(BUILD_TESTING) block has been removed to ensure
# a successful configuration, as it contained persistent errors.

# ====================================================================
# 12. Installation
# ====================================================================
# ... existing code ...
