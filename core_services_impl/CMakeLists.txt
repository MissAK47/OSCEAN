# core_services_impl/CMakeLists.txt

cmake_minimum_required(VERSION 3.15)
# project()å‘½ä»¤åº”è¯¥åœ¨é¡¶å±‚CMakeLists.txtä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤

# è®¾ç½®ç»„ä»¶ç‰ˆæœ¬ï¼ˆä¸é¡¶å±‚é¡¹ç›®ä¿æŒä¸€è‡´ï¼‰
set(CORE_SERVICES_IMPL_VERSION "1.0.0")

# è®¾ç½®CMakeç­–ç•¥ä»¥é¿å…BoostæŸ¥æ‰¾è­¦å‘Š
if(POLICY CMP0167)
    cmake_policy(SET CMP0167 NEW)  # ä½¿ç”¨æ–°çš„BoostæŸ¥æ‰¾æ¨¡å—
endif()

# æŸ¥æ‰¾æ‰€æœ‰ä¾èµ–åŒ…
find_package(Boost 1.71.0 REQUIRED COMPONENTS system thread filesystem property_tree log program_options serialization date_time)
find_package(GDAL CONFIG QUIET)
if(NOT GDAL_FOUND)
    find_package(GDAL MODULE REQUIRED)
endif()

# SQLite3æŸ¥æ‰¾ - ä¸ä¸»é¡¹ç›®ä¿æŒä¸€è‡´ï¼Œä½†è®¾ä¸ºå¯é€‰
find_package(SQLite3 QUIET)
if(SQLite3_FOUND)
    message(STATUS "[core_services_impl] æ‰¾åˆ°æ ‡å‡† SQLite3")
else()
    message(STATUS "[core_services_impl] æ ‡å‡† SQLite3 æœªæ‰¾åˆ°ï¼Œå°è¯• vcpkg çš„ unofficial-sqlite3...")
    find_package(unofficial-sqlite3 CONFIG QUIET)
    
    if(unofficial-sqlite3_FOUND)
        message(STATUS "[core_services_impl] æ‰¾åˆ° unofficial-sqlite3")
        # åˆ›å»ºå…¼å®¹çš„ SQLite::SQLite3 ç›®æ ‡åˆ«å
        if(NOT TARGET SQLite::SQLite3)
            if(TARGET unofficial::sqlite3::sqlite3)
                add_library(SQLite::SQLite3 ALIAS unofficial::sqlite3::sqlite3)
                message(STATUS "[core_services_impl] åˆ›å»º SQLite::SQLite3 åˆ«å")
            else()
                add_library(SQLite::SQLite3 INTERFACE IMPORTED)
                set_target_properties(SQLite::SQLite3 PROPERTIES
                    INTERFACE_LINK_LIBRARIES "unofficial::sqlite3::sqlite3"
                )
                message(STATUS "[core_services_impl] åˆ›å»º SQLite::SQLite3 æ¥å£åº“")
            endif()
        endif()
        set(SQLite3_FOUND TRUE)
    else()
        message(WARNING "[core_services_impl] æ— æ³•æ‰¾åˆ° SQLite3ï¼æŸäº›åŠŸèƒ½å°†è¢«ç¦ç”¨ã€‚")
        set(SQLite3_FOUND FALSE)
    endif()
endif()

find_package(nlohmann_json CONFIG QUIET)
if(NOT nlohmann_json_FOUND)
    find_package(nlohmann_json MODULE QUIET)
    if(NOT nlohmann_json_FOUND)
        message(WARNING "nlohmann_json not found. Some functionality may be limited.")
    endif()
endif()

# è®¾ç½®å…¨å±€ç¼–è¯‘é€‰é¡¹ (å¯ä»¥ç”±é¡¶å±‚ç»§æ‰¿ï¼Œæˆ–åœ¨æ­¤å¤„è¦†ç›–/æ·»åŠ )
# if(MSVC)
#     add_compile_options(/W4 /wd4100 /wd4996)
# else()
#     add_compile_options(-Wall -Wextra -Wpedantic)
# endif()

# æ·»åŠ å„æœåŠ¡å®ç°å­ç›®å½•
add_subdirectory(crs_service)  # é¦–å…ˆæ„å»ºcrs_serviceï¼Œå› ä¸ºå…¶ä»–æœåŠ¡ä¾èµ–å®ƒ
add_subdirectory(data_access_service)
add_subdirectory(metadata_service)
add_subdirectory(interpolation_service)
add_subdirectory(spatial_ops_service)  # å¯ç”¨ç©ºé—´æœåŠ¡

# åˆ›å»ºä¸€ä¸ªæ•´åˆæ‰€æœ‰æ ¸å¿ƒæœåŠ¡å®ç°çš„ INTERFACE åº“ (ç”¨äºé“¾æ¥)
add_library(core_services_impl INTERFACE)

# é“¾æ¥æ‰€æœ‰æ ¸å¿ƒæœåŠ¡å®ç°
target_link_libraries(core_services_impl INTERFACE
    crs_service
    data_access_service
    metadata_service
    interpolation_service
    spatial_ops_service  # å¯ç”¨ç©ºé—´æœåŠ¡
)

# è®¾ç½®æ‰€æœ‰æ ¸å¿ƒæœåŠ¡å®ç°çš„é€šç”¨å±æ€§
set(CORE_SERVICES_TARGETS
    crs_service
    data_access_service
    metadata_service
    interpolation_service
    spatial_ops_service  # å¯ç”¨ç©ºé—´æœåŠ¡
)

foreach(target ${CORE_SERVICES_TARGETS})
    if(TARGET ${target})
        set_property(TARGET ${target} PROPERTY CXX_STANDARD 17)
        set_property(TARGET ${target} PROPERTY CXX_STANDARD_REQUIRED ON)
        set_property(TARGET ${target} PROPERTY CXX_EXTENSIONS OFF)

        # ç»Ÿä¸€ä¸ºæ‰€æœ‰æ ¸å¿ƒæœåŠ¡ç›®æ ‡è®¾ç½®å¹²å‡€çš„ç¼–è¯‘é€‰é¡¹
        if(MSVC)
            target_compile_options(${target} PRIVATE 
                /W4 
                /WX- 
                /Zc:preprocessor 
                /permissive- 
                /Zc:__cplusplus 
                /Zc:throwingNew 
                /EHsc
                /wd4251 
                /wd4275 
                /wd4996
            )
        endif()
    endif()
endforeach()

# å®‰è£…æ‰€æœ‰æ ¸å¿ƒæœåŠ¡å®ç°
install(TARGETS 
    crs_service
    data_access_service
    metadata_service
    interpolation_service
    spatial_ops_service  # å¯ç”¨ç©ºé—´æœåŠ¡
    EXPORT core_services_impl_targets
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

# ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªå¯¼å‡ºé›†
# INTERFACEåº“çš„å®‰è£…ä¸»è¦é€šè¿‡å¯¼å‡ºå…¶ç›®æ ‡
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å¾ªç¯ä¾èµ–é—®é¢˜
# install(TARGETS core_services_impl crs_service data_access_service metadata_service interpolation_service spatial_ops_service # ä½¿ç”¨æ­£ç¡®çš„ç›®æ ‡åç§°
#     EXPORT CoreServicesImplTargets
#     LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
#     ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
#     RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
# )

# å¯¼å‡ºåŒ…é…ç½®
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å¾ªç¯ä¾èµ–é—®é¢˜
# include(CMakePackageConfigHelpers)

# åˆ›å»ºå¹¶å®‰è£… CoreServicesImplConfigVersion.cmake
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å¾ªç¯ä¾èµ–é—®é¢˜
# write_basic_package_version_file(
#     "${CMAKE_CURRENT_BINARY_DIR}/CoreServicesImplConfigVersion.cmake"
#     VERSION ${CORE_SERVICES_IMPL_VERSION} 
#     COMPATIBILITY SameMajorVersion
# )

# åˆ›å»º core_services_impl-config.cmake æ–‡ä»¶
# è¿™ä¸ªæ–‡ä»¶å°†ç”± configure_package_config_file ç”Ÿæˆ
# éœ€è¦ä¸€ä¸ª core_services_impl/cmake/config.cmake.in æ¨¡æ¿æ–‡ä»¶

# ç¡®ä¿ cmake ç›®å½•å­˜åœ¨
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å¾ªç¯ä¾èµ–é—®é¢˜
# file(MAKE_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/cmake")

# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å¾ªç¯ä¾èµ–é—®é¢˜
# configure_package_config_file(
#     "${CMAKE_CURRENT_SOURCE_DIR}/cmake/config.cmake.in"
#     "${CMAKE_CURRENT_BINARY_DIR}/CoreServicesImplConfig.cmake"
#     INSTALL_DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/CoreServicesImpl"
#     PATH_VARS CMAKE_INSTALL_LIBDIR CMAKE_INSTALL_INCLUDEDIR
# )

# å®‰è£…é…ç½®æ–‡ä»¶å’Œç‰ˆæœ¬æ–‡ä»¶
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å¾ªç¯ä¾èµ–é—®é¢˜
# install(FILES
#     "${CMAKE_CURRENT_BINARY_DIR}/CoreServicesImplConfig.cmake"
#     "${CMAKE_CURRENT_BINARY_DIR}/CoreServicesImplConfigVersion.cmake"
#     DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/CoreServicesImpl"
# )

# å®‰è£…å¯¼å‡ºç›®æ ‡æ–‡ä»¶ CoreServicesImplTargets.cmake
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å¾ªç¯ä¾èµ–é—®é¢˜
# install(EXPORT CoreServicesImplTargets
#     FILE CoreServicesImplTargets.cmake
#     NAMESPACE OSCEAN::
#     DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/CoreServicesImpl"
# )

# æ³¨æ„ï¼šç§»é™¤äº†å…¨å±€include_directoriesè°ƒç”¨ï¼Œæ”¹ä¸ºåœ¨å„ä¸ªç›®æ ‡ä¸­ä½¿ç”¨target_include_directories
# è¿™æ˜¯ç°ä»£CMakeçš„æœ€ä½³å®è·µï¼Œé¿å…å…¨å±€æ±¡æŸ“åŒ…å«è·¯å¾„ 

# ğŸ”§ ä¿®å¤ï¼šåœ¨åŒä¸€é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨ç›®æ ‡ï¼Œæ— éœ€find_package
# find_package(common_utilities REQUIRED CONFIG)  # ç§»é™¤ï¼Œå› ä¸ºåœ¨åŒä¸€é¡¹ç›®ä¸­
# find_package(core_service_interfaces REQUIRED CONFIG)  # ç§»é™¤ï¼Œå› ä¸ºåœ¨åŒä¸€é¡¹ç›®ä¸­
# find_package(workflow_engine REQUIRED CONFIG) # ç§»é™¤ï¼Œå› ä¸ºåœ¨åŒä¸€é¡¹ç›®ä¸­

# æ·»åŠ æ‰€æœ‰å­ç›®å½•å·²åœ¨å‰é¢å®Œæˆï¼Œä¸éœ€è¦é‡å¤
# ... existing code ... 