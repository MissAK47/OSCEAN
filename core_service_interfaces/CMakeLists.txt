cmake_minimum_required(VERSION 3.15)

project(core_service_interfaces VERSION 0.1.0 LANGUAGES CXX)

# è®¾ç½®C++17æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# æ·»åŠ ç¼–è¯‘é€‰é¡¹
if(MSVC)
    add_compile_options(/W4 /wd4100 /wd4996)
else()
    add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# è®¾ç½®å®‰è£…ç›®å½•
include(GNUInstallDirs)

# åˆ›å»ºæ¥å£åº“ï¼ˆçº¯å¤´æ–‡ä»¶åº“ï¼‰
add_library(core_service_interfaces INTERFACE)

# æŸ¥æ‰¾æ ¸å¿ƒä¾èµ–
find_package(Boost CONFIG REQUIRED COMPONENTS thread asio)

# ğŸ†• å¯é€‰é«˜æ€§èƒ½ä¼˜åŒ–æ”¯æŒ
option(OSCEAN_ENABLE_HIGH_PERFORMANCE_INTERFACES "Enable high-performance optimizations in interfaces" ON)

if(OSCEAN_ENABLE_HIGH_PERFORMANCE_INTERFACES)
    message(STATUS "[core_service_interfaces] High-performance optimizations enabled")
    target_compile_definitions(core_service_interfaces
        INTERFACE
            OSCEAN_HAS_HIGH_PERFORMANCE_INTERFACES
    )
    # ä»…åœ¨éœ€è¦æ—¶é“¾æ¥common_utilities
    target_link_libraries(core_service_interfaces
        INTERFACE
            common_utilities
    )
else()
    message(STATUS "[core_service_interfaces] High-performance optimizations explicitly disabled")
endif()

# è®¾ç½®åŒ…å«ç›®å½•
target_include_directories(core_service_interfaces
    INTERFACE
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include>
)

# é“¾æ¥æ¥å£ä¾èµ–
target_link_libraries(core_service_interfaces
    INTERFACE
        Boost::thread # for boost::future
        Boost::asio   # for potential transitive dependencies or definitions needed by asio users
        common_utilities # æ ¸å¿ƒæ•°æ®ç»“æ„ä¾èµ–
)

# è®¾ç½®å¿…è¦çš„ç¼–è¯‘å®šä¹‰
target_compile_definitions(core_service_interfaces
    INTERFACE
        $<$<CXX_COMPILER_ID:MSVC>:_CRT_SECURE_NO_WARNINGS>
        $<$<CXX_COMPILER_ID:MSVC>:NOMINMAX>
)

# å®‰è£…æ¥å£å¤´æ–‡ä»¶
install(DIRECTORY 
    ${CMAKE_CURRENT_SOURCE_DIR}/include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/core_service_interfaces
    FILES_MATCHING PATTERN "*.h" PATTERN "*.hpp"
)

# å®‰è£…ç›®æ ‡
install(TARGETS core_service_interfaces
    EXPORT core_service_interfaces_targets
)

# å¯¼å‡ºç›®æ ‡
install(EXPORT core_service_interfaces_targets
    FILE core_service_interfaces-targets.cmake
    NAMESPACE OSCEAN::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/core_service_interfaces
)

# åˆ›å»ºé…ç½®æ–‡ä»¶
include(CMakePackageConfigHelpers)
configure_package_config_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/cmake/config.cmake.in
    ${CMAKE_CURRENT_BINARY_DIR}/core_service_interfaces-config.cmake
    INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/core_service_interfaces
)

# ç”Ÿæˆç‰ˆæœ¬æ–‡ä»¶
write_basic_package_version_file(
    ${CMAKE_CURRENT_BINARY_DIR}/core_service_interfaces-config-version.cmake
    VERSION ${PROJECT_VERSION}
    COMPATIBILITY SameMajorVersion
)

# å®‰è£…é…ç½®æ–‡ä»¶
install(FILES
    ${CMAKE_CURRENT_BINARY_DIR}/core_service_interfaces-config.cmake
    ${CMAKE_CURRENT_BINARY_DIR}/core_service_interfaces-config-version.cmake
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/core_service_interfaces
)

# æ·»åŠ ç®€å•æµ‹è¯•é¡¹ç›®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/simple_test" AND BUILD_TESTING AND BUILD_TESTS)
    add_subdirectory(simple_test)
endif()