cmake_minimum_required(VERSION 3.20)

# è®¾ç½®CMakeç­–ç•¥ä»¥é¿å…è­¦å‘Š
if(POLICY CMP0167)
    cmake_policy(SET CMP0167 NEW)  # ä½¿ç”¨æ–°çš„BoostæŸ¥æ‰¾æ¨¡å—
endif()

project(data_access_service VERSION 1.0.0 LANGUAGES CXX)
# No project() command in sub-module

message(STATUS "[data_access_service] Configuring data_access service module.")

# è®¾ç½®ç»„ä»¶ç‰ˆæœ¬
set(DATA_ACCESS_SERVICE_VERSION "1.0.0")

SET(VAPKG_DIR "C:/Users/Administrator/vcpkg")

# ä» DATA_ACCESS_SERVICE_VERSION æå–ä¸»ç‰ˆæœ¬å·
string(REGEX MATCH "^([0-9]+)\." _dummy ${DATA_ACCESS_SERVICE_VERSION})
if(CMAKE_MATCH_COUNT GREATER 0)
    set(DATA_ACCESS_SERVICE_VERSION_MAJOR ${CMAKE_MATCH_1})
else()
    set(DATA_ACCESS_SERVICE_VERSION_MAJOR "0") # æä¾›ä¸€ä¸ªé»˜è®¤å€¼ä»¥é˜²ä¸‡ä¸€
    message(WARNING "[data_access_service] Could not parse MAJOR version from DATA_ACCESS_SERVICE_VERSION: ${DATA_ACCESS_SERVICE_VERSION}. Using default SOVERSION ${DATA_ACCESS_SERVICE_VERSION_MAJOR}.")
endif()
message(STATUS "[data_access_service] DATA_ACCESS_SERVICE_VERSION_MAJOR set to: ${DATA_ACCESS_SERVICE_VERSION_MAJOR}")




# --- æŸ¥æ‰¾å¿…éœ€çš„ä¾èµ–åŒ… ---
# P1å¼‚æ­¥æ¡†æ¶é›†æˆï¼šæ·»åŠ common_utilitiesä¾èµ–
find_package(common_utilities CONFIG QUIET)
if(NOT common_utilities_FOUND)
    # æ£€æŸ¥æ˜¯å¦å·²ç»ä½œä¸ºå­ç›®å½•æ·»åŠ 
    if(NOT TARGET common_utilities)
        # å¦‚æœæ²¡æœ‰å®‰è£…ï¼Œå°è¯•ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„common_utilities
        set(COMMON_UTILITIES_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/../../common_utilities")
        if(EXISTS "${COMMON_UTILITIES_ROOT}/CMakeLists.txt")
            message(STATUS "[data_access_service] Using common_utilities from: ${COMMON_UTILITIES_ROOT}")
            add_subdirectory("${COMMON_UTILITIES_ROOT}" common_utilities_build)
            set(common_utilities_FOUND TRUE)
            # æ·»åŠ åŒ…å«ç›®å½•
            list(APPEND DATA_ACCESS_INCLUDE_DIRS "${COMMON_UTILITIES_ROOT}/include")
            include_directories("${COMMON_UTILITIES_ROOT}/include")
        else()
            message(FATAL_ERROR "[data_access_service] common_utilities not found at ${COMMON_UTILITIES_ROOT}. This is required for P1 async framework integration.")
        endif()
    else()
        message(STATUS "[data_access_service] common_utilities target already exists, skipping add_subdirectory")
        # ä»ç„¶æ·»åŠ åŒ…å«ç›®å½•
        set(COMMON_UTILITIES_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/../../common_utilities")
        list(APPEND DATA_ACCESS_INCLUDE_DIRS "${COMMON_UTILITIES_ROOT}/include")
        include_directories("${COMMON_UTILITIES_ROOT}/include")
        set(common_utilities_FOUND TRUE)
    endif()
else()
    message(STATUS "[data_access_service] Found common_utilities package")
endif()

# æŸ¥æ‰¾core_service_interfacesæ¨¡å—
if(NOT TARGET core_service_interfaces)
    set(CORE_SERVICE_INTERFACES_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/../../core_service_interfaces")
    if(EXISTS "${CORE_SERVICE_INTERFACES_ROOT}/CMakeLists.txt")
        message(STATUS "[data_access_service] Using core_service_interfaces from: ${CORE_SERVICE_INTERFACES_ROOT}")
        add_subdirectory("${CORE_SERVICE_INTERFACES_ROOT}" core_service_interfaces_build)
        # æ·»åŠ åŒ…å«ç›®å½•
        list(APPEND DATA_ACCESS_INCLUDE_DIRS "${CORE_SERVICE_INTERFACES_ROOT}/include")
        include_directories("${CORE_SERVICE_INTERFACES_ROOT}/include")
    else()
        message(FATAL_ERROR "[data_access_service] core_service_interfaces not found at ${CORE_SERVICE_INTERFACES_ROOT}.")
    endif()
else()
    message(STATUS "[data_access_service] core_service_interfaces target already exists, skipping add_subdirectory")
    # ä»ç„¶æ·»åŠ åŒ…å«ç›®å½•
    set(CORE_SERVICE_INTERFACES_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/../../core_service_interfaces")
    list(APPEND DATA_ACCESS_INCLUDE_DIRS "${CORE_SERVICE_INTERFACES_ROOT}/include")
    include_directories("${CORE_SERVICE_INTERFACES_ROOT}/include")
endif()

# é¦–å…ˆå°è¯•ä»ç¯å¢ƒå˜é‡æˆ–ç¼“å­˜ä¸­è·å–GDALè·¯å¾„
if(NOT DEFINED GDAL_ROOT)
    if(DEFINED ENV{GDAL_ROOT})
        set(GDAL_ROOT $ENV{GDAL_ROOT} CACHE PATH "Path to GDAL installation")
    endif()
endif()

# æ‰“å°GDAL_ROOTä¿¡æ¯
if(DEFINED GDAL_ROOT)
    message(STATUS "[data_access_service] Using GDAL_ROOT: ${GDAL_ROOT}")
endif()

# æ‰¾åˆ°GDALåº“
find_package(GDAL CONFIG REQUIRED)

if(GDAL_FOUND)
    message(STATUS "[data_access_service] GDAL include directories: ${GDAL_INCLUDE_DIRS}")
    message(STATUS "[data_access_service] GDAL libraries: ${GDAL_LIBRARIES}")
    
    # æ·»åŠ GDAL_DATA_DIRå®
    if(DEFINED ENV{GDAL_DATA})
        message(STATUS "[data_access_service] GDAL_DATA environment variable: $ENV{GDAL_DATA}")
        add_compile_definitions(GDAL_DATA_DIR="$ENV{GDAL_DATA}")
    elseif(DEFINED GDAL_DATA_PATH)
        message(STATUS "[data_access_service] Using GDAL_DATA_PATH: ${GDAL_DATA_PATH}")
        add_compile_definitions(GDAL_DATA_DIR="${GDAL_DATA_PATH}")
    endif()
    
    # å®šä¹‰GDALç‰ˆæœ¬å®
    if(DEFINED GDAL_VERSION)
        # å°†ç‰ˆæœ¬å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºç»„ä»¶
        string(REPLACE "." ";" GDAL_VERSION_LIST ${GDAL_VERSION})
        list(GET GDAL_VERSION_LIST 0 GDAL_VERSION_MAJOR)
        list(GET GDAL_VERSION_LIST 1 GDAL_VERSION_MINOR)
        
        # å®šä¹‰ç‰ˆæœ¬å®ä¾›ä»£ç ä½¿ç”¨
        add_compile_definitions(
            GDAL_VERSION_MAJOR=${GDAL_VERSION_MAJOR}
            GDAL_VERSION_MINOR=${GDAL_VERSION_MINOR}
            GDAL_VERSION_NUM=${GDAL_VERSION_MAJOR}${GDAL_VERSION_MINOR}00
        )
        
        message(STATUS "[data_access_service] Defined GDAL version macros: GDAL_VERSION_MAJOR=${GDAL_VERSION_MAJOR}, GDAL_VERSION_MINOR=${GDAL_VERSION_MINOR}")
    endif()
    
    # å®šä¹‰ç¼–è¯‘å®å¯ç”¨GDALè¯»å–å™¨
    add_compile_definitions(OSCEAN_HAS_GDAL_READER)
else()
    message(WARNING "[data_access_service] GDAL libraries not found. GDAL support will be disabled.")
endif()

# æŸ¥æ‰¾PROJåº“ï¼ˆå¯é€‰ï¼‰
find_package(PROJ CONFIG QUIET)
if(NOT PROJ_FOUND)
    message(WARNING "[data_access_service] PROJ library not found. Using stub implementation for coordinate transformation.")
    set(OSCEAN_HAS_PROJ FALSE)
    add_compile_definitions(OSCEAN_HAS_PROJ=0)
else()
    message(STATUS "[data_access_service] Found PROJ: ${PROJ_LIBRARIES}")
    set(OSCEAN_HAS_PROJ TRUE)
    add_compile_definitions(OSCEAN_HAS_PROJ=1)
endif()

# æŸ¥æ‰¾NetCDFåº“
find_package(netCDF CONFIG QUIET)
if(NOT netCDF_FOUND)
    find_package(netCDF MODULE QUIET)
endif()

if(netCDF_FOUND)
    message(STATUS "[data_access_service] Found NetCDF: ${netCDF_VERSION}")
    set(OSCEAN_HAS_NETCDF TRUE)
    add_definitions(-DOSCEAN_HAS_NETCDF)
    
    # æ·»åŠ NetCDFçš„åŒ…å«ç›®å½•
    if(DEFINED netCDF_INCLUDE_DIRS)
        message(STATUS "[data_access_service] Using NetCDF include dirs: ${netCDF_INCLUDE_DIRS}")
        list(APPEND DATA_ACCESS_INCLUDE_DIRS ${netCDF_INCLUDE_DIRS})
        include_directories(${netCDF_INCLUDE_DIRS})
    elseif(TARGET netCDF::netcdf)
        get_target_property(NETCDF_INTERFACE_INCLUDES netCDF::netcdf INTERFACE_INCLUDE_DIRECTORIES)
        if(NETCDF_INTERFACE_INCLUDES)
            message(STATUS "[data_access_service] Using NetCDF include dirs from target: ${NETCDF_INTERFACE_INCLUDES}")
            list(APPEND DATA_ACCESS_INCLUDE_DIRS ${NETCDF_INTERFACE_INCLUDES})
            include_directories(${NETCDF_INTERFACE_INCLUDES})
        endif()
    endif()
else()
    message(STATUS "[data_access_service] NetCDF not found, disabling NetCDF support")
    set(OSCEAN_HAS_NETCDF FALSE)
endif()

# æŸ¥æ‰¾spdlogåº“
find_package(spdlog CONFIG REQUIRED)
if(spdlog_FOUND)
    message(STATUS "[data_access_service] Found spdlog: ${spdlog_INCLUDE_DIRS}")
else()
    message(FATAL_ERROR "[data_access_service] spdlog library not found. This is a required dependency.")
endif()

# æŸ¥æ‰¾fmtåº“ (spdlog çš„ä¾èµ–)
find_package(fmt CONFIG REQUIRED)
if(fmt_FOUND)
    message(STATUS "[data_access_service] Found fmt: ${fmt_INCLUDE_DIRS}")
else()
    message(FATAL_ERROR "[data_access_service] fmt library not found. This is a required dependency for spdlog.")
endif()

# è®¾ç½®CMakeç­–ç•¥ä»¥é¿å…BoostæŸ¥æ‰¾è­¦å‘Š
if(POLICY CMP0167)
    cmake_policy(SET CMP0167 NEW)  # ä½¿ç”¨æ–°çš„BoostæŸ¥æ‰¾æ¨¡å—
endif()

# æŸ¥æ‰¾Booståº“ (asio å’Œ thread ç»„ä»¶)
find_package(Boost REQUIRED COMPONENTS thread system filesystem)
if(Boost_FOUND)
    message(STATUS "[data_access_service] Found Boost: ${Boost_VERSION}")
    list(APPEND DATA_ACCESS_INCLUDE_DIRS ${Boost_INCLUDE_DIRS})
    include_directories(${Boost_INCLUDE_DIRS})
else()
    message(FATAL_ERROR "[data_access_service] Boost (thread, system, filesystem) libraries not found. These are required dependencies.")
endif()

# æŸ¥æ‰¾nlohmann_jsonåº“
find_package(nlohmann_json CONFIG QUIET) # ä½¿ç”¨QUIETå› ä¸ºä¸€äº›é¡¹ç›®å¯èƒ½é€šè¿‡å­æ¨¡å—æˆ–ç›´æ¥åŒ…å«å¤´æ–‡ä»¶
if(nlohmann_json_FOUND)
    message(STATUS "[data_access_service] Found nlohmann_json: ${nlohmann_json_INCLUDE_DIRS}")
    # é€šå¸¸ nlohmann_json æ˜¯ä¸€ä¸ªå¤´æ–‡ä»¶åº“ï¼Œä½† vcpkg å¯èƒ½ä¼šæä¾›ä¸€ä¸ª target
    if(TARGET nlohmann_json::nlohmann_json)
        message(STATUS "[data_access_service] nlohmann_json target found: nlohmann_json::nlohmann_json")
    endif()
else()
    message(WARNING "[data_access_service] nlohmann_json library/target not found. Assuming header-only or included elsewhere.")
    # å¦‚æœæ‚¨çš„é¡¹ç›®ä¾èµ–äºé€šè¿‡find_packageæ‰¾åˆ°nlohmann_jsonï¼Œè¿™é‡Œå¯èƒ½éœ€è¦æ”¹ä¸ºFATAL_ERROR
endif()

# æŸ¥æ‰¾GTeståº“ï¼ˆä»…åœ¨éœ€è¦æ„å»ºæµ‹è¯•æ—¶ï¼‰
if(BUILD_TESTING)
    find_package(GTest CONFIG QUIET)
    if(NOT GTest_FOUND)
        message(STATUS "[data_access_service] GTest not found via CONFIG, trying MODULE mode")
        find_package(GTest MODULE QUIET)
    endif()
    
    if(GTest_FOUND)
        message(STATUS "[data_access_service] Found GTest: ${GTEST_VERSION}")
        if(TARGET GTest::gtest AND TARGET GTest::gtest_main)
            message(STATUS "[data_access_service] GTest targets available: GTest::gtest, GTest::gtest_main")
        endif()
    else()
        message(WARNING "[data_access_service] GTest not found. Tests will be disabled.")
    endif()
endif()

# è®¾ç½®ç¼–è¯‘æ ‡å¿—ä»¥å¯ç”¨GDALè¯»å–å™¨
add_compile_definitions(OSCEAN_HAS_GDAL_READER=1)

# æ·»åŠ  netcdf_reader å­æ¨¡å—
# æš‚æ—¶ç¦ç”¨NetCDFæ¨¡å—ä»¥ä¸“æ³¨äºPhase 3å¼‚æ­¥æ‰§è¡Œå™¨ç¼–è¯‘
# if(OSCEAN_HAS_NETCDF)
#     add_subdirectory(src/impl/readers/netcdf)
# endif()

# å†…å­˜å¯¹é½ä¼˜åŒ–é…ç½®
# option(ENABLE_MEMORY_ALIGNMENT "Enable SIMD memory alignment optimization" ON)

# if(ENABLE_MEMORY_ALIGNMENT)
#     message(STATUS "[data_access_service] Memory alignment optimization enabled")
#     add_compile_definitions(OSCEAN_HAS_HIGH_PERFORMANCE_INTERFACES)
#     # å¯ç”¨é¢å¤–çš„SIMDä¼˜åŒ–æ ‡å¿—
#     if(MSVC)
#         add_compile_options(/arch:AVX2)
#     else()
#         add_compile_options(-mavx2 -mfma)
#     endif()
# else()
#     message(STATUS "[data_access_service] Memory alignment optimization disabled")
# endif()

# ç›®æ ‡åç§°å®šä¹‰
set(TARGET_NAME "data_access_service")

# æ·»åŠ MSVCç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹
if(MSVC)
    add_compile_options(/utf-8)
endif()

# è®¾ç½®æºæ–‡ä»¶åˆ—è¡¨ - æ¸…ç†åçš„ç‰ˆæœ¬ï¼ˆåªåŒ…å«å®é™…å­˜åœ¨çš„æ–‡ä»¶ï¼‰
set(DATA_ACCESS_SOURCES
    # æ ¸å¿ƒæœåŠ¡å®ç° - å®é™…å­˜åœ¨çš„æ–‡ä»¶
    src/unified_data_access_service_impl.cpp
    src/data_access_service_factory_impl.cpp
    
    # ğŸ”§ ä¿®å¤ï¼šæ·»åŠ å¹¶å‘ä¼˜åŒ–ç»„ä»¶å®ç°
    src/concurrent_optimization_components.cpp
    
    # è¯»å–å™¨æ¶æ„ - å®é™…å­˜åœ¨çš„æ–‡ä»¶
    src/readers/core/reader_registry.cpp
    src/readers/core/unified_data_reader.cpp               # æ·»åŠ ç»Ÿä¸€æ•°æ®è¯»å–å™¨åŸºç±»å®ç°
    src/readers/core/impl/unified_advanced_reader.cpp
    
    # GDALè¯»å–å™¨å®ç° - æ¸…ç†åçš„æ–‡ä»¶åˆ—è¡¨
    src/readers/core/impl/gdal/gdal_raster_reader.cpp
    src/readers/core/impl/gdal/gdal_raster_processor.cpp
    src/readers/core/impl/gdal/gdal_vector_reader.cpp      # çŸ¢é‡è¯»å–å™¨
    src/readers/core/impl/gdal/gdal_vector_processor.cpp   # çŸ¢é‡å¤„ç†å™¨
    src/readers/core/impl/gdal/gdal_format_handler.cpp
    # âœ… å·²åˆ é™¤å†—ä½™æ–‡ä»¶:
    # - gdal_advanced_reader.h/.cpp (åŠŸèƒ½å·²æ•´åˆåˆ°ä¸“ç”¨è¯»å–å™¨)
    # - gdal_base_reader.h/.cpp (åŠŸèƒ½å·²åˆ†æ•£åˆ°ä¸“ç”¨è¯»å–å™¨)
    
    # NetCDFè¯»å–å™¨å®ç° - æ¸…ç†åçš„æ–‡ä»¶ï¼ˆåˆ é™¤äº†é‡å¤çš„æ–‡ä»¶ï¼‰
    src/readers/core/impl/netcdf/netcdf_advanced_reader.cpp
    src/readers/core/impl/netcdf/netcdf_coordinate_system.cpp
    src/readers/core/impl/netcdf/netcdf_variable_processor.cpp
    src/readers/core/impl/netcdf/netcdf_utils.cpp
    src/readers/core/impl/netcdf/memory_layout_analyzer.cpp  # æ–°å¢ï¼šå†…å­˜å¸ƒå±€åˆ†æå™¨
    
    # ç¼“å­˜ç³»ç»Ÿ - å·²ç§»é™¤ï¼Œä½¿ç”¨ common_utilities æä¾›çš„ç¼“å­˜åŠŸèƒ½
    # src/cache/unified_data_access_cache.cpp - å·²åˆ é™¤ï¼ŒåŠŸèƒ½é‡å¤
    
    # æµå¼å¤„ç†ï¼ˆå·²å®Œæ•´å®ç°ï¼‰
    src/streaming/streaming_processor.cpp
    src/streaming/data_streaming_coordinator.cpp
    src/streaming/performance_manager.cpp
    
    # æ—¶é—´å¤„ç†ï¼ˆå·²å®Œæ•´å®ç°ï¼‰
    # src/time/cf_time_extractor.cpp - å·²åˆ é™¤ï¼ŒåŠŸèƒ½åˆå¹¶åˆ° netcdf_time_processor
)

# Phase 1: æ€§èƒ½åŸºçº¿æµ‹è¯•æ–‡ä»¶
set(PERFORMANCE_BASELINE_TESTS
    tests/performance_baseline_tests.cpp
)

# åŒ…å«ç›®å½•
set(DATA_ACCESS_INCLUDE_DIRS
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${GDAL_INCLUDE_DIRS}
    ${CMAKE_SOURCE_DIR}
    ${CMAKE_SOURCE_DIR}/core_service_interfaces/include
    ${CMAKE_SOURCE_DIR}/common_utilities/include
)

# å¦‚æœæ‰¾åˆ°NetCDFåº“ï¼Œæ·»åŠ å…¶åŒ…å«ç›®å½•
if(OSCEAN_HAS_NETCDF)
    list(APPEND DATA_ACCESS_INCLUDE_DIRS ${netCDF_INCLUDE_DIRS})
endif()

# é“¾æ¥åº“
set(DATA_ACCESS_LIBS
    ${GDAL_LIBRARIES}
)

# å¦‚æœcore_service_interfacesä½œä¸ºå­ç›®å½•å­˜åœ¨ï¼Œæ·»åŠ ä¾èµ–
if(TARGET core_service_interfaces)
    list(APPEND DATA_ACCESS_LIBS core_service_interfaces)
endif()

# å¦‚æœcommon_utilitiesä½œä¸ºå­ç›®å½•å­˜åœ¨ï¼Œæ·»åŠ ä¾èµ–
if(TARGET common_utilities)
    list(APPEND DATA_ACCESS_LIBS common_utilities)
endif()

# å¦‚æœæ‰¾åˆ°NetCDFåº“ï¼Œæ·»åŠ ç›¸åº”çš„é“¾æ¥
if(OSCEAN_HAS_NETCDF)
    list(APPEND DATA_ACCESS_LIBS netCDF::netcdf)
endif()

# æ·»åŠ spdlogå’ŒBooståº“
# list(APPEND DATA_ACCESS_LIBS spdlog::spdlog Boost::asio Boost::thread)

# æ·»åŠ  nlohmann_json ç›®æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# if(TARGET nlohmann_json::nlohmann_json)
# list(APPEND DATA_ACCESS_LIBS nlohmann_json::nlohmann_json)
# endif()

# åˆ›å»ºåº“
add_library(${TARGET_NAME} STATIC ${DATA_ACCESS_SOURCES})

# è®¾ç½®ç›®æ ‡å±æ€§
set_target_properties(${TARGET_NAME} PROPERTIES
    VERSION ${DATA_ACCESS_SERVICE_VERSION}
    SOVERSION ${DATA_ACCESS_SERVICE_VERSION_MAJOR}
    ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
)


# ä¸ºç›®æ ‡æ·»åŠ åŒ…å«ç›®å½•
target_include_directories(${TARGET_NAME}
    PUBLIC
        # æ¥å£ç›¸å…³çš„å¤´æ–‡ä»¶ç›®å½•ï¼Œä½¿å…¶å¯¹é“¾æ¥åˆ°æ­¤åº“çš„å…¶ä»–ç›®æ ‡å¯è§
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../../core_service_interfaces/include> # ä¿®æ­£ç›¸å¯¹è·¯å¾„
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../../common_utilities/include>      # ä¿®æ­£ç›¸å¯¹è·¯å¾„
        "${VAPKG_DIR}/installed/x64-windows/include"
    PRIVATE
        # å®ç°ç›¸å…³çš„å¤´æ–‡ä»¶ç›®å½•
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${GDAL_INCLUDE_DIRS} # GDALçš„å¤´æ–‡ä»¶
        ${Boost_INCLUDE_DIRS} # Boostçš„å¤´æ–‡ä»¶
        # spdlog å’Œ fmt çš„åŒ…å«ç›®å½•é€šå¸¸ç”±å…¶ CMake target è‡ªåŠ¨å¤„ç†
        # ${spdlog_INCLUDE_DIRS} # é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ 
        # ${fmt_INCLUDE_DIRS}    # é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ 
)

# å¦‚æœæ‰¾åˆ°NetCDFåº“ï¼Œæ·»åŠ å…¶åŒ…å«ç›®å½•åˆ°ç›®æ ‡
if(OSCEAN_HAS_NETCDF AND TARGET netCDF::netcdf)
    target_include_directories(${TARGET_NAME} PRIVATE $<TARGET_PROPERTY:netCDF::netcdf,INTERFACE_INCLUDE_DIRECTORIES>)
endif()

# å¦‚æœå¯ç”¨äº†NetCDFè¯»å–å™¨å¹¶ä¸”netcdf_readerç›®æ ‡å­˜åœ¨ï¼Œåˆ™é“¾æ¥å®ƒ
if(OSCEAN_HAS_NETCDF AND TARGET netcdf_reader)
    list(APPEND DATA_ACCESS_LIBS netcdf_reader)
    # ç¡®ä¿åœ¨ç›®æ ‡é“¾æ¥ä¸­ä¹Ÿæ·»åŠ netcdf_reader
    target_link_libraries(${TARGET_NAME} PUBLIC netcdf_reader)
    message(STATUS "[data_access_service] Linked against netcdf_reader.")
endif()

# é“¾æ¥åº“åˆ°ç›®æ ‡
target_link_libraries(${TARGET_NAME}
    PUBLIC
        core_service_interfaces # ç§»è‡³ PUBLIC
        common_utilities      # ç§»è‡³ PUBLIC
        spdlog::spdlog
        # netCDF::netcdf # ä¿æŒ PUBLICï¼Œå¦‚æœæ¥å£ä½¿ç”¨äº† NetCDF ç±»å‹
    PRIVATE
        ${GDAL_LIBRARIES} # GDAL_LIBRARIES å·²åŒ…å«åœ¨ DATA_ACCESS_LIBS ä¸­ï¼Œä½†è¿™é‡Œç›´æ¥ä½¿ç”¨ç›®æ ‡æ›´æ¸…æ™°
        # ${DATA_ACCESS_LIBS} # ä¸å†éœ€è¦ï¼Œå› ä¸ºä¸»è¦ä¾èµ–å·²ç§»è‡³PUBLICæˆ–ç›´æ¥åœ¨æ­¤å¤„åˆ—å‡º
        Boost::thread
        Boost::system
        Boost::filesystem
        nlohmann_json::nlohmann_json
)

# æ£€æŸ¥Boost::asioæ˜¯å¦å¯ç”¨ï¼Œå¦‚æœå¯ç”¨åˆ™é“¾æ¥
if(TARGET Boost::asio)
    target_link_libraries(${TARGET_NAME} PRIVATE Boost::asio)
endif()

if(OSCEAN_HAS_NETCDF AND TARGET netCDF::netcdf)
    target_link_libraries(${TARGET_NAME} PUBLIC netCDF::netcdf) # ç¡®ä¿netCDFæ˜¯PUBLICå¦‚æœéœ€è¦
endif()

# å¦‚æœ PROJ æ‰¾åˆ°å¹¶ä¸”æ˜¯ä¸€ä¸ª target, é“¾æ¥å®ƒ
if(PROJ_FOUND AND TARGET PROJ::proj)
    target_link_libraries(${TARGET_NAME} PRIVATE PROJ::proj)
endif()

# è®¾ç½®C++æ ‡å‡†
target_compile_features(${TARGET_NAME} PUBLIC cxx_std_17)

# æ·»åŠ boost::futureæ‰€éœ€çš„å®å®šä¹‰
add_definitions(-DBOOST_THREAD_PROVIDES_FUTURE)
add_definitions(-DBOOST_THREAD_PROVIDES_FUTURE_CONTINUATION)
add_definitions(-DBOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY)
add_definitions(-DBOOST_THREAD_PROVIDES_FUTURE_ASYNC)

# æ·»åŠ MSVCç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹
if(MSVC)
    target_compile_options(${TARGET_NAME} PRIVATE
        /wd4996  # ç¦ç”¨å·²å¼ƒç”¨å‡½æ•°è­¦å‘Š
        /wd4251  # ç¦ç”¨DLLæ¥å£è­¦å‘Š
        /FS      # å¼ºåˆ¶åŒæ­¥PDBå†™å…¥
        /utf-8   # ä½¿ç”¨UTF-8ç¼–ç 
        /EHsc    # å¯ç”¨C++å¼‚å¸¸å¤„ç†
        /wd4834  # ç¦ç”¨[[nodiscard]]è­¦å‘Š
    )
    target_compile_definitions(${TARGET_NAME} PRIVATE
        _WIN32_WINNT=0x0A00     # Windows 10æ”¯æŒ
        NOMINMAX                # ç¦ç”¨min/maxå®
        WIN32_LEAN_AND_MEAN     # å‡å°‘Windowså¤´æ–‡ä»¶åŒ…å«
    )
endif()

# æ•°æ®è®¿é—®æœåŠ¡æµ‹è¯•é€‰é¡¹
option(BUILD_DATA_ACCESS_TESTS "Build data access service tests" ON)

# æ·»åŠ æµ‹è¯• - ç®€åŒ–æ¡ä»¶åˆ¤æ–­
if(BUILD_TESTING)
    message(STATUS "[data_access_service] Adding tests subdirectory.")
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/tests/CMakeLists.txt")
        add_subdirectory(tests)
    else()
        message(WARNING "[data_access_service] Tests directory not found in ${CMAKE_CURRENT_SOURCE_DIR}/tests")
    endif()
else()
    message(STATUS "[data_access_service] Skipping tests (BUILD_TESTING=${BUILD_TESTING})")
endif()

# --- å®‰è£…é…ç½® ---
include(GNUInstallDirs)

# å®‰è£…å¤´æ–‡ä»¶
install(DIRECTORY include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/data_access_service
    FILES_MATCHING PATTERN "*.h" PATTERN "*.hpp"
)

# æŸ¥æ‰¾spdlogï¼ˆæ—¥å¿—åº“ï¼Œå¯èƒ½è¢«common_utils/logging.hä½¿ç”¨ï¼‰
find_package(spdlog CONFIG QUIET)
if(NOT spdlog_FOUND)
    # å°è¯•ä½¿ç”¨æ¨¡å—æ¨¡å¼
    find_package(spdlog MODULE QUIET)
endif()

if(spdlog_FOUND)
    message(STATUS "[data_access_service] Found spdlog: ${spdlog_VERSION}")
    if(TARGET spdlog::spdlog)
        get_target_property(SPDLOG_INTERFACE_INCLUDES spdlog::spdlog INTERFACE_INCLUDE_DIRECTORIES)
        if(SPDLOG_INTERFACE_INCLUDES)
            list(APPEND DATA_ACCESS_INCLUDE_DIRS ${SPDLOG_INTERFACE_INCLUDES})
            include_directories(${SPDLOG_INTERFACE_INCLUDES})
        endif()
    endif()
else()
    message(WARNING "[data_access_service] spdlog not found. Logging functionality may be limited.")
endif()

# è®¾ç½®ç›®æ ‡å±æ€§
set_target_properties(${TARGET_NAME} PROPERTIES
    VERSION ${DATA_ACCESS_SERVICE_VERSION}
    SOVERSION ${DATA_ACCESS_SERVICE_VERSION_MAJOR}
)

message(STATUS "[data_access_service] æ•°æ®è®¿é—®æœåŠ¡åº“é…ç½®å®Œæˆ")
message(STATUS "[data_access_service] å·²æ¸…ç†è¿‡æ—¶çš„æºæ–‡ä»¶å’Œæµ‹è¯•é…ç½®") 