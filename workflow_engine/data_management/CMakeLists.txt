cmake_minimum_required(VERSION 3.20)
project(workflow_engine_data_management)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ğŸ”§ ä¿®å¤å­—ç¬¦ç¼–ç é—®é¢˜ - æ·»åŠ UTF-8ç¼–ç æ”¯æŒ
if(MSVC)
    # æ·»åŠ UTF-8ç¼–ç æ”¯æŒï¼Œè§£å†³ä¸­æ–‡å­—ç¬¦ç¼–è¯‘é—®é¢˜
    add_compile_options(/utf-8)
    # ç¦ç”¨ç‰¹å®šè­¦å‘Š
    add_compile_options(/wd4819)  # ç¦ç”¨å­—ç¬¦ç¼–ç è­¦å‘Š
    add_compile_options(/wd4996)  # ç¦ç”¨å·²å¼ƒç”¨å‡½æ•°è­¦å‘Š
    # æ·»åŠ Unicodeæ”¯æŒ
    add_compile_definitions(UNICODE _UNICODE)
endif()

# ğŸš€ å¼ºåˆ¶ç¦ç”¨boost::asio - é˜²æ­¢å‘½åç©ºé—´å†²çª
add_compile_definitions(
    OSCEAN_NO_BOOST_ASIO_MODULE=1
    BOOST_ASIO_DISABLE_BOOST_ARRAY=1
    BOOST_ASIO_DISABLE_BOOST_ASSERT=1
    BOOST_ASIO_DISABLE_BOOST_BIND=1
    BOOST_ASIO_DISABLE_BOOST_CHRONO=1
    BOOST_ASIO_DISABLE_BOOST_DATE_TIME=1
    BOOST_ASIO_DISABLE_BOOST_REGEX=1
)

# æŸ¥æ‰¾ä¾èµ–
find_package(Boost REQUIRED COMPONENTS thread system chrono)
find_package(Threads REQUIRED)

# ğŸ†• æ·»åŠ SQLite3æ”¯æŒï¼ˆç”¨äºæ•°æ®åº“æ“ä½œï¼‰
find_package(SQLite3 QUIET)
if(NOT SQLite3_FOUND)
    find_package(unofficial-sqlite3 CONFIG QUIET)
    if(unofficial-sqlite3_FOUND AND NOT TARGET SQLite::SQLite3)
        if(TARGET unofficial::sqlite3::sqlite3)
            add_library(SQLite::SQLite3 ALIAS unofficial::sqlite3::sqlite3)
            message(STATUS "[data_management] åˆ›å»º SQLite::SQLite3 åˆ«å")
        endif()
    endif()
endif()

if(TARGET SQLite::SQLite3)
    message(STATUS "[data_management] SQLite3 æ”¯æŒå·²å¯ç”¨")
    set(HAS_SQLITE3 TRUE)
else()
    message(WARNING "[data_management] SQLite3 æœªæ‰¾åˆ°ï¼Œæ•°æ®åº“åŠŸèƒ½å°†å—é™")
    set(HAS_SQLITE3 FALSE)
endif()

# ğŸ”§ æŸ¥æ‰¾å’Œé…ç½®æ ¸å¿ƒæœåŠ¡ä¾èµ–
find_package(common_utilities CONFIG QUIET)
find_package(core_service_interfaces CONFIG QUIET)

# ğŸ¯ åœ¨ä¸»buildç¯å¢ƒä¸­ï¼Œç›´æ¥ä½¿ç”¨å·²æ„å»ºçš„ç›®æ ‡è€Œä¸æ˜¯æŸ¥æ‰¾åŒ…
# æ£€æŸ¥æ˜¯å¦åœ¨ä¸»buildç¯å¢ƒä¸­ï¼ˆé€šè¿‡æ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨ï¼‰
if(TARGET metadata_service)
    message(STATUS "æ‰¾åˆ°metadata_serviceç›®æ ‡ï¼ˆä¸»buildç¯å¢ƒï¼‰")
    set(HAS_METADATA_SERVICE TRUE)
else()
    message(STATUS "æœªæ‰¾åˆ°metadata_serviceç›®æ ‡ï¼Œå°è¯•æŸ¥æ‰¾åŒ…")
    find_package(metadata_service CONFIG QUIET)
    set(HAS_METADATA_SERVICE ${metadata_service_FOUND})
endif()

if(TARGET data_access_service)
    message(STATUS "æ‰¾åˆ°data_access_serviceç›®æ ‡ï¼ˆä¸»buildç¯å¢ƒï¼‰")
    set(HAS_DATA_ACCESS_SERVICE TRUE)
else()
    message(STATUS "æœªæ‰¾åˆ°data_access_serviceç›®æ ‡ï¼Œå°è¯•æŸ¥æ‰¾åŒ…")
    find_package(data_access_service CONFIG QUIET)
    set(HAS_DATA_ACCESS_SERVICE ${data_access_service_FOUND})
endif()

if(TARGET crs_service)
    message(STATUS "æ‰¾åˆ°crs_serviceç›®æ ‡ï¼ˆä¸»buildç¯å¢ƒï¼‰")
    set(HAS_CRS_SERVICE TRUE)
else()
    message(STATUS "æœªæ‰¾åˆ°crs_serviceç›®æ ‡ï¼Œå°è¯•æŸ¥æ‰¾åŒ…")
    find_package(crs_service CONFIG QUIET)
    set(HAS_CRS_SERVICE ${crs_service_FOUND})
endif()

# ğŸ†• æ–°å¢ï¼šæ£€æŸ¥æ’å€¼æœåŠ¡
if(TARGET interpolation_service)
    message(STATUS "æ‰¾åˆ°interpolation_serviceç›®æ ‡ï¼ˆä¸»buildç¯å¢ƒï¼‰")
    set(HAS_INTERPOLATION_SERVICE TRUE)
else()
    message(STATUS "æœªæ‰¾åˆ°interpolation_serviceç›®æ ‡ï¼Œå°è¯•æŸ¥æ‰¾åŒ…")
    find_package(interpolation_service CONFIG QUIET)
    set(HAS_INTERPOLATION_SERVICE ${interpolation_service_FOUND})
endif()

# ğŸ†• æ–°å¢ï¼šæ£€æŸ¥ç©ºé—´è®¡ç®—æœåŠ¡
if(TARGET spatial_ops_service)
    message(STATUS "æ‰¾åˆ°spatial_ops_serviceç›®æ ‡ï¼ˆä¸»buildç¯å¢ƒï¼‰")
    set(HAS_SPATIAL_OPS_SERVICE TRUE)
else()
    message(STATUS "æœªæ‰¾åˆ°spatial_ops_serviceç›®æ ‡ï¼Œå°è¯•æŸ¥æ‰¾åŒ…")
    find_package(spatial_ops_service CONFIG QUIET)
    set(HAS_SPATIAL_OPS_SERVICE ${spatial_ops_service_FOUND})
endif()

# ğŸ†• æ–°å¢ï¼šæ£€æŸ¥è¾“å‡ºæœåŠ¡
if(TARGET output_generation)
    message(STATUS "æ‰¾åˆ°output_generationç›®æ ‡ï¼ˆä¸»buildç¯å¢ƒï¼‰")
    set(HAS_OUTPUT_SERVICE TRUE)
else()
    message(STATUS "æœªæ‰¾åˆ°output_generationç›®æ ‡ï¼Œå°è¯•æŸ¥æ‰¾åŒ…")
    find_package(output_generation CONFIG QUIET)
    set(HAS_OUTPUT_SERVICE ${output_generation_FOUND})
endif()

# ğŸ¯ ç¡®å®šæ˜¯å¦æœ‰å®Œæ•´æœåŠ¡æ”¯æŒ
if(HAS_METADATA_SERVICE AND HAS_DATA_ACCESS_SERVICE)
    message(STATUS "æ‰¾åˆ°å¿…éœ€çš„æ ¸å¿ƒæœåŠ¡ï¼Œå¯ç”¨å®Œæ•´åŠŸèƒ½")
    set(HAS_FULL_SERVICES TRUE)
else()
    message(STATUS "ç¼ºå°‘æ ¸å¿ƒæœåŠ¡å®ç°ï¼Œå°†ä»…ç¼–è¯‘åŸºç¡€åŠŸèƒ½")
    message(STATUS "  - metadata_service: ${HAS_METADATA_SERVICE}")
    message(STATUS "  - data_access_service: ${HAS_DATA_ACCESS_SERVICE}")
    set(HAS_FULL_SERVICES FALSE)
endif()

# ğŸ†• æ‰©å±•æœåŠ¡æ”¯æŒæ£€æŸ¥
message(STATUS "æ‰©å±•æœåŠ¡æ”¯æŒçŠ¶æ€:")
message(STATUS "  - crs_service: ${HAS_CRS_SERVICE}")
message(STATUS "  - interpolation_service: ${HAS_INTERPOLATION_SERVICE}")
message(STATUS "  - spatial_ops_service: ${HAS_SPATIAL_OPS_SERVICE}")
message(STATUS "  - output_service: ${HAS_OUTPUT_SERVICE}")

if(HAS_INTERPOLATION_SERVICE AND HAS_SPATIAL_OPS_SERVICE AND HAS_OUTPUT_SERVICE)
    message(STATUS "âœ… æ‰€æœ‰æ‰©å±•æœåŠ¡å¯ç”¨ï¼Œå¯ç”¨å¢å¼ºæ•°æ®å¤„ç†åŠŸèƒ½")
    set(HAS_ENHANCED_SERVICES TRUE)
else()
    message(STATUS "âš ï¸ éƒ¨åˆ†æ‰©å±•æœåŠ¡ä¸å¯ç”¨ï¼ŒæŸäº›å¢å¼ºåŠŸèƒ½å°†è¢«ç¦ç”¨")
    set(HAS_ENHANCED_SERVICES FALSE)
endif()

# è®¾ç½®åŒ…å«è·¯å¾„ - ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼
set(INCLUDE_PATHS
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)

# æ·»åŠ common_utilitiesåŒ…å«è·¯å¾„
if(common_utilities_FOUND)
    get_target_property(COMMON_INCLUDE_DIRS common_utilities INTERFACE_INCLUDE_DIRECTORIES)
    if(COMMON_INCLUDE_DIRS)
        list(APPEND INCLUDE_PATHS ${COMMON_INCLUDE_DIRS})
    endif()
else()
    # å›é€€åˆ°æœ¬åœ°è·¯å¾„
    list(APPEND INCLUDE_PATHS "${CMAKE_CURRENT_SOURCE_DIR}/../../common_utilities/include")
endif()

# æ·»åŠ core_service_interfacesåŒ…å«è·¯å¾„
if(core_service_interfaces_FOUND)
    get_target_property(CORE_INTERFACES_INCLUDE_DIRS core_service_interfaces INTERFACE_INCLUDE_DIRECTORIES)
    if(CORE_INTERFACES_INCLUDE_DIRS)
        list(APPEND INCLUDE_PATHS ${CORE_INTERFACES_INCLUDE_DIRS})
    endif()
else()
    # å›é€€åˆ°æœ¬åœ°è·¯å¾„
    list(APPEND INCLUDE_PATHS "${CMAKE_CURRENT_SOURCE_DIR}/../../core_service_interfaces/include")
endif()

# æ·»åŠ æœåŠ¡å®ç°çš„åŒ…å«è·¯å¾„
if(HAS_FULL_SERVICES)
    if(core_services_impl_FOUND)
        get_target_property(CORE_IMPL_INCLUDE_DIRS core_services_impl INTERFACE_INCLUDE_DIRECTORIES)
        if(CORE_IMPL_INCLUDE_DIRS)
            list(APPEND INCLUDE_PATHS ${CORE_IMPL_INCLUDE_DIRS})
        endif()
    else()
        # æ·»åŠ ç‹¬ç«‹æœåŠ¡çš„åŒ…å«è·¯å¾„
        list(APPEND INCLUDE_PATHS 
            "${CMAKE_CURRENT_SOURCE_DIR}/../../core_services_impl/data_access_service/include"
            "${CMAKE_CURRENT_SOURCE_DIR}/../../core_services_impl/data_access_service/src"
            "${CMAKE_CURRENT_SOURCE_DIR}/../../core_services_impl/metadata_service/include"
            "${CMAKE_CURRENT_SOURCE_DIR}/../../core_services_impl/metadata_service/src"
            "${CMAKE_CURRENT_SOURCE_DIR}/../../core_services_impl/crs_service/include"
            "${CMAKE_CURRENT_SOURCE_DIR}/../../core_services_impl/crs_service/src"
            "${CMAKE_CURRENT_SOURCE_DIR}/../../core_services_impl/crs_service/src/impl"
        )
    endif()
endif()

# ğŸ”§ æŸ¥æ‰¾spdlogåŒ… - è§£å†³é“¾æ¥å†²çªï¼ˆå¯é€‰ï¼‰
# åœ¨ä¸»buildç¯å¢ƒä¸­ï¼Œspdlogå·²é€šè¿‡common_utilitiesé“¾æ¥ï¼Œæ— éœ€ç‹¬ç«‹é“¾æ¥
set(USE_SPDLOG_UNIFIED FALSE)  # åœ¨ä¸»buildç¯å¢ƒä¸­ç¦ç”¨ç‹¬ç«‹spdlogé“¾æ¥

# é“¾æ¥ç›®å½• - ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨
if(NOT common_utilities_FOUND OR NOT core_service_interfaces_FOUND)
    link_directories(
        ${CMAKE_CURRENT_SOURCE_DIR}/../../../common_utilities/Debug
        ${CMAKE_CURRENT_SOURCE_DIR}/../../core_service_interfaces/Debug
    )
endif()

# æºæ–‡ä»¶
set(SOURCES
    src/data_management_service.cpp
    src/data_management_workflow.cpp    # ğŸ†• ç¬¦åˆå·¥ä½œæµå¼•æ“æ ‡å‡†çš„å·¥ä½œæµç±»
    # src/data_management_workflow_registry.cpp    # ğŸ†• å·¥ä½œæµè‡ªåŠ¨æ³¨å†Œ - æš‚æ—¶ç§»é™¤ï¼Œé¿å…å‘½åç©ºé—´å†²çª
)

# å¤´æ–‡ä»¶
set(HEADERS
    include/workflow_engine/data_management/data_management_service.h
    include/workflow_engine/data_management/data_management_workflow.h    # ğŸ†• ç¬¦åˆå·¥ä½œæµå¼•æ“æ ‡å‡†çš„å·¥ä½œæµç±»
)

# åˆ›å»ºåº“
add_library(workflow_engine_data_management STATIC ${SOURCES} ${HEADERS})

# è®¾ç½®åŒ…å«ç›®å½•
target_include_directories(workflow_engine_data_management PRIVATE ${INCLUDE_PATHS})

# è®¾ç½®ç¼–è¯‘å®šä¹‰
target_compile_definitions(workflow_engine_data_management PRIVATE
    OSCEAN_DATA_MANAGEMENT_EXPORTS
    OSCEAN_NO_BOOST_ASIO_MODULE=1
    # ğŸ”§ å¯ç”¨Boost.Threadçš„futureæ‰©å±•åŠŸèƒ½
    BOOST_THREAD_PROVIDES_FUTURE=1
    BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION=1
    BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY=1
)

# æ ¹æ®æ˜¯å¦æœ‰å®Œæ•´æœåŠ¡è®¾ç½®ç¼–è¯‘å®šä¹‰
if(HAS_FULL_SERVICES)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        OSCEAN_HAS_FULL_SERVICES=1  # å¯ç”¨å®Œæ•´æœåŠ¡å®ç°
    )
    message(STATUS "å¯ç”¨å®Œæ•´æœåŠ¡åŠŸèƒ½")
else()
    message(STATUS "ä»…å¯ç”¨åŸºç¡€åŠŸèƒ½")
endif()

# ğŸ”§ è§£å†³spdlogé“¾æ¥å†²çª - ç»Ÿä¸€ä½¿ç”¨å…±äº«åº“ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if(USE_SPDLOG_UNIFIED)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        SPDLOG_SHARED_LIB  # ä½¿ç”¨å…±äº«åº“ç‰ˆæœ¬
        SPDLOG_COMPILED_LIB  # ä½¿ç”¨ç¼–è¯‘ç‰ˆæœ¬è€Œéheader-only
    )
endif()

# ğŸ†• æ·»åŠ SQLiteæ”¯æŒå®šä¹‰
if(HAS_SQLITE3)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        OSCEAN_HAS_SQLITE3=1  # å¯ç”¨SQLiteæ•°æ®åº“æ”¯æŒ
    )
    message(STATUS "å¯ç”¨SQLiteæ•°æ®åº“åŠŸèƒ½")
endif()

# ğŸ†• æ ¹æ®æ‰©å±•æœåŠ¡å¯ç”¨æ€§è®¾ç½®ç¼–è¯‘å®šä¹‰
if(HAS_ENHANCED_SERVICES)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        OSCEAN_HAS_ENHANCED_SERVICES=1  # å¯ç”¨å¢å¼ºæœåŠ¡å®ç°
    )
    message(STATUS "å¯ç”¨å¢å¼ºæœåŠ¡åŠŸèƒ½ï¼ˆæ’å€¼ã€ç©ºé—´è®¡ç®—ã€è¾“å‡ºï¼‰")
endif()

# ğŸ†• å•ç‹¬è®¾ç½®å„æ‰©å±•æœåŠ¡çš„ç¼–è¯‘å®šä¹‰
if(HAS_INTERPOLATION_SERVICE)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        OSCEAN_HAS_INTERPOLATION_SERVICE=1
    )
    message(STATUS "å¯ç”¨æ’å€¼æœåŠ¡æ”¯æŒ")
endif()

if(HAS_SPATIAL_OPS_SERVICE)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        OSCEAN_HAS_SPATIAL_OPS_SERVICE=1
    )
    message(STATUS "å¯ç”¨ç©ºé—´è®¡ç®—æœåŠ¡æ”¯æŒ")
endif()

if(HAS_OUTPUT_SERVICE)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        OSCEAN_HAS_OUTPUT_SERVICE=1
    )
    message(STATUS "å¯ç”¨è¾“å‡ºæœåŠ¡æ”¯æŒ")
endif()

if(HAS_CRS_SERVICE)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        OSCEAN_HAS_CRS_SERVICE=1
    )
    message(STATUS "å¯ç”¨CRSæœåŠ¡æ”¯æŒ")
endif()

# åŸºç¡€åº“é“¾æ¥
set(BASE_LIBRARIES
    ${Boost_LIBRARIES}
    Threads::Threads
    Boost::thread
    Boost::chrono
    Boost::system
)

# ğŸ†• æ·»åŠ SQLite3åº“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if(HAS_SQLITE3)
    list(APPEND BASE_LIBRARIES SQLite::SQLite3)
    message(STATUS "[data_management] æ·»åŠ SQLite3åº“åˆ°é“¾æ¥")
endif()

# æ ¸å¿ƒä¾èµ–åº“é“¾æ¥
set(CORE_LIBRARIES)

if(common_utilities_FOUND)
    list(APPEND CORE_LIBRARIES common_utilities)
else()
    message(STATUS "ä½¿ç”¨æœ¬åœ°common_utilitiesé“¾æ¥")
    list(APPEND CORE_LIBRARIES common_utilities)  # å‡è®¾é€šè¿‡link_directorieså¯ä»¥æ‰¾åˆ°
endif()

if(core_service_interfaces_FOUND)
    list(APPEND CORE_LIBRARIES core_service_interfaces)
else()
    message(STATUS "ä½¿ç”¨æœ¬åœ°core_service_interfacesé“¾æ¥")
    list(APPEND CORE_LIBRARIES core_service_interfaces)  # å‡è®¾é€šè¿‡link_directorieså¯ä»¥æ‰¾åˆ°
endif()

# å®Œæ•´æœåŠ¡åº“é“¾æ¥
set(SERVICE_LIBRARIES)
if(HAS_FULL_SERVICES)
    # ğŸ¯ åœ¨ä¸»buildç¯å¢ƒä¸­ï¼Œç›´æ¥é“¾æ¥åˆ°ç›®æ ‡è€Œä¸æ˜¯é€šè¿‡åŒ…
    if(TARGET metadata_service)
        list(APPEND SERVICE_LIBRARIES metadata_service)
        message(STATUS "æ·»åŠ metadata_serviceç›®æ ‡åˆ°é“¾æ¥åº“")
    endif()
    
    if(TARGET data_access_service)
        list(APPEND SERVICE_LIBRARIES data_access_service)
        message(STATUS "æ·»åŠ data_access_serviceç›®æ ‡åˆ°é“¾æ¥åº“")
    endif()
    
    if(TARGET crs_service)
        list(APPEND SERVICE_LIBRARIES crs_service)
        message(STATUS "æ·»åŠ crs_serviceç›®æ ‡åˆ°é“¾æ¥åº“")
    endif()
    
    # ğŸ†• æ¢å¤spatial_ops_serviceé“¾æ¥ - workflow_engine_coreç°å·²æ­£ç¡®é“¾æ¥
    if(TARGET spatial_ops_service)
        list(APPEND SERVICE_LIBRARIES spatial_ops_service)
        message(STATUS "æ·»åŠ spatial_ops_serviceç›®æ ‡åˆ°é“¾æ¥åº“")
    endif()
    
    if(TARGET interpolation_service)
        list(APPEND SERVICE_LIBRARIES interpolation_service)
        message(STATUS "æ·»åŠ interpolation_serviceç›®æ ‡åˆ°é“¾æ¥åº“")
    endif()
    
    if(TARGET output_generation)
        list(APPEND SERVICE_LIBRARIES output_generation)
        message(STATUS "æ·»åŠ output_generationç›®æ ‡åˆ°é“¾æ¥åº“")
    else()
        # å¦‚æœoutput_generationç›®æ ‡è¿˜ä¸å­˜åœ¨ï¼Œæ·»åŠ åº“è·¯å¾„
        if(EXISTS "${CMAKE_BINARY_DIR}/output_generation/Debug/output_generation.lib")
            list(APPEND SERVICE_LIBRARIES "${CMAKE_BINARY_DIR}/output_generation/Debug/output_generation.lib")
            message(STATUS "æ·»åŠ output_generationåº“æ–‡ä»¶åˆ°é“¾æ¥åº“")
        endif()
    endif()
    
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ï¼Œå°è¯•é€šè¿‡åŒ…é“¾æ¥
    if(NOT SERVICE_LIBRARIES)
        if(data_access_service_FOUND)
            list(APPEND SERVICE_LIBRARIES data_access_service)
        endif()
        if(metadata_service_FOUND)
            list(APPEND SERVICE_LIBRARIES metadata_service)
        endif()
        if(crs_service_FOUND)
            list(APPEND SERVICE_LIBRARIES crs_service)
        endif()
    endif()
endif()

# æ‰§è¡Œé“¾æ¥
target_link_libraries(workflow_engine_data_management
    ${BASE_LIBRARIES}
    ${CORE_LIBRARIES}
    ${SERVICE_LIBRARIES}
)

# åˆ›å»ºæµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
add_executable(test_data_management test_data_management.cpp)

# ğŸ¯ è®¾ç½®æµ‹è¯•ç¨‹åºè¾“å‡ºåˆ°ä¸»buildç›®å½•çš„binç›®å½•ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†
set_target_properties(test_data_management PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    RUNTIME_OUTPUT_DIRECTORY_DEBUG "${CMAKE_BINARY_DIR}/bin/Debug"
    RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_BINARY_DIR}/bin/Release"
    RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO "${CMAKE_BINARY_DIR}/bin/RelWithDebInfo"
    RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL "${CMAKE_BINARY_DIR}/bin/MinSizeRel"
)

# è®¾ç½®æµ‹è¯•ç¨‹åºçš„åŒ…å«ç›®å½•
target_include_directories(test_data_management PRIVATE ${INCLUDE_PATHS})

# ğŸ”§ æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶ - ä½¿ç”¨ç›¸åŒçš„spdlogé“¾æ¥æ–¹å¼ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if(USE_SPDLOG_UNIFIED)
    target_compile_definitions(test_data_management PRIVATE
        SPDLOG_SHARED_LIB  # ä½¿ç”¨å…±äº«åº“ç‰ˆæœ¬
        SPDLOG_COMPILED_LIB  # ä½¿ç”¨ç¼–è¯‘ç‰ˆæœ¬è€Œéheader-only
    )
endif()

# è®¾ç½®æµ‹è¯•ç¨‹åºçš„ç¼–è¯‘å®šä¹‰
target_compile_definitions(test_data_management PRIVATE
    OSCEAN_NO_BOOST_ASIO_MODULE=1
    # ğŸ”§ å¯ç”¨Boost.Threadçš„futureæ‰©å±•åŠŸèƒ½
    BOOST_THREAD_PROVIDES_FUTURE=1
    BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION=1
    BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY=1
)

# æ ¹æ®æ˜¯å¦æœ‰å®Œæ•´æœåŠ¡è®¾ç½®æµ‹è¯•ç¨‹åºçš„ç¼–è¯‘å®šä¹‰
if(HAS_FULL_SERVICES)
    target_compile_definitions(test_data_management PRIVATE
        OSCEAN_HAS_FULL_SERVICES=1  # å¯ç”¨å®Œæ•´æœåŠ¡å®ç°
    )
endif()

# é“¾æ¥æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶ - ä¿®å¤é“¾æ¥é¡ºåº
target_link_libraries(test_data_management
    workflow_engine_data_management
    workflow_engine_core  # ğŸ†• æ·»åŠ workflow_engine_coreåº“ä»¥ä½¿ç”¨ServiceManagerImpl
    ${SERVICE_LIBRARIES}  # æ·»åŠ æœåŠ¡åº“ï¼Œç¡®ä¿ç¬¦å·å¯ç”¨
    ${CORE_LIBRARIES}     # æ·»åŠ æ ¸å¿ƒåº“
    ${BASE_LIBRARIES}     # æ·»åŠ åŸºç¡€åº“
    # æ³¨æ„ï¼šä¾èµ–ä¼šè‡ªåŠ¨ä¼ é€’ï¼Œä½†æ˜¾å¼æ·»åŠ ç¡®ä¿é“¾æ¥é¡ºåºæ­£ç¡®
)

# è®¾ç½®ç›®æ ‡å±æ€§
set_target_properties(workflow_engine_data_management PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

set_target_properties(test_data_management PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

# ğŸ”§ Windowsç‰¹å®šè®¾ç½®
if(WIN32)
    target_compile_definitions(workflow_engine_data_management PRIVATE
        WIN32_LEAN_AND_MEAN
        NOMINMAX
        _WIN32_WINNT=0x0601
    )
    
    target_compile_definitions(test_data_management PRIVATE
        WIN32_LEAN_AND_MEAN
        NOMINMAX
        _WIN32_WINNT=0x0601
    )
endif()

# è®¾ç½®å…¬å…±åŒ…å«ç›®å½•ï¼ˆç”¨äºå…¶ä»–æ¨¡å—é“¾æ¥æ­¤åº“æ—¶ï¼‰
target_include_directories(workflow_engine_data_management PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)

# è¾“å‡ºé…ç½®ä¿¡æ¯
message(STATUS "=== æ•°æ®ç®¡ç†æ¨¡å—é…ç½®æ€»ç»“ ===")
message(STATUS "å®Œæ•´æœåŠ¡æ”¯æŒ: ${HAS_FULL_SERVICES}")
message(STATUS "Commonå·¥å…·åŒ…: ${common_utilities_FOUND}")
message(STATUS "æ ¸å¿ƒæœåŠ¡æ¥å£: ${core_service_interfaces_FOUND}")
if(HAS_FULL_SERVICES)
    message(STATUS "æ ¸å¿ƒæœåŠ¡å®ç°: ${core_services_impl_FOUND}")
    message(STATUS "æ•°æ®è®¿é—®æœåŠ¡: ${data_access_service_FOUND}")
    message(STATUS "å…ƒæ•°æ®æœåŠ¡: ${metadata_service_FOUND}")
    message(STATUS "CRSæœåŠ¡: ${crs_service_FOUND}")
endif()
message(STATUS "================================")

# === æ•°æ®ç®¡ç†æ¨¡å—é…ç½®æ€»ç»“ ===
# å®Œæ•´æœåŠ¡æ”¯æŒ: TRUE
# Commonå·¥å…·åŒ…: 0
# æ ¸å¿ƒæœåŠ¡æ¥å£: 0
# æ ¸å¿ƒæœåŠ¡å®ç°:
# æ•°æ®è®¿é—®æœåŠ¡:
# å…ƒæ•°æ®æœåŠ¡:
# CRSæœåŠ¡:
# ================================

# ğŸ”§ æ·»åŠ æœåŠ¡ç®¡ç†å™¨è¯Šæ–­ç¨‹åº
add_executable(service_manager_diagnostics service_manager_diagnostics.cpp)

# ğŸ”¬ æ·»åŠ å®Œæ•´å…ƒæ•°æ®å¤„ç†æµ‹è¯•ç¨‹åº
# add_executable(test_complete_metadata_processing ${CMAKE_CURRENT_SOURCE_DIR}/../../test_complete_metadata_processing.cpp)
# target_link_libraries(test_complete_metadata_processing PRIVATE
#     data_management_core
#     GTest::gtest GTest::gtest_main
# )
# gtest_discover_tests(test_complete_metadata_processing)

# ğŸ” æ·»åŠ CRSæœåŠ¡æ·±åº¦è¯Šæ–­æµ‹è¯•ç¨‹åº
add_executable(crs_diagnostic_test crs_diagnostic_test.cpp)

# ğŸ¯ è®¾ç½®è¯Šæ–­ç¨‹åºè¾“å‡ºåˆ°ä¸»buildç›®å½•çš„binç›®å½•
set_target_properties(service_manager_diagnostics PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    RUNTIME_OUTPUT_DIRECTORY_DEBUG "${CMAKE_BINARY_DIR}/bin/Debug"
    RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_BINARY_DIR}/bin/Release"
    RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO "${CMAKE_BINARY_DIR}/bin/RelWithDebInfo"
    RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL "${CMAKE_BINARY_DIR}/bin/MinSizeRel"
)

# ğŸ¯ è®¾ç½®å®Œæ•´å…ƒæ•°æ®å¤„ç†æµ‹è¯•ç¨‹åºè¾“å‡ºç›®å½•
# set_target_properties(test_complete_metadata_processing PROPERTIES
#     RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
#     RUNTIME_OUTPUT_DIRECTORY_DEBUG "${CMAKE_BINARY_DIR}/bin/Debug"
#     RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_BINARY_DIR}/bin/Release"
#     RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO "${CMAKE_BINARY_DIR}/bin/RelWithDebInfo"
#     RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL "${CMAKE_BINARY_DIR}/bin/MinSizeRel"
# )

# ğŸ¯ è®¾ç½®CRSè¯Šæ–­æµ‹è¯•ç¨‹åºè¾“å‡ºç›®å½•
set_target_properties(crs_diagnostic_test PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    RUNTIME_OUTPUT_DIRECTORY_DEBUG "${CMAKE_BINARY_DIR}/bin/Debug"
    RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_BINARY_DIR}/bin/Release"
    RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO "${CMAKE_BINARY_DIR}/bin/RelWithDebInfo"
    RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL "${CMAKE_BINARY_DIR}/bin/MinSizeRel"
)

# è®¾ç½®è¯Šæ–­ç¨‹åºçš„åŒ…å«ç›®å½•
target_include_directories(service_manager_diagnostics PRIVATE ${INCLUDE_PATHS})

# è®¾ç½®å®Œæ•´å…ƒæ•°æ®å¤„ç†æµ‹è¯•ç¨‹åºçš„åŒ…å«ç›®å½•
# target_include_directories(test_complete_metadata_processing PRIVATE ${INCLUDE_PATHS})

# è®¾ç½®CRSè¯Šæ–­æµ‹è¯•ç¨‹åºçš„åŒ…å«ç›®å½•
target_include_directories(crs_diagnostic_test PRIVATE ${INCLUDE_PATHS})

# è®¾ç½®è¯Šæ–­ç¨‹åºçš„ç¼–è¯‘å®šä¹‰
target_compile_definitions(service_manager_diagnostics PRIVATE
    OSCEAN_NO_BOOST_ASIO_MODULE=1
    BOOST_THREAD_PROVIDES_FUTURE=1
    BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION=1
    BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY=1
)

# è®¾ç½®å®Œæ•´å…ƒæ•°æ®å¤„ç†æµ‹è¯•ç¨‹åºçš„ç¼–è¯‘å®šä¹‰
# target_compile_definitions(test_complete_metadata_processing PRIVATE
#     OSCEAN_NO_BOOST_ASIO_MODULE=1
#     BOOST_THREAD_PROVIDES_FUTURE=1
#     BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION=1
#     BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY=1
# )

# è®¾ç½®CRSè¯Šæ–­æµ‹è¯•ç¨‹åºçš„ç¼–è¯‘å®šä¹‰
target_compile_definitions(crs_diagnostic_test PRIVATE
    OSCEAN_NO_BOOST_ASIO_MODULE=1
    BOOST_THREAD_PROVIDES_FUTURE=1
    BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION=1
    BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY=1
)

if(HAS_FULL_SERVICES)
    target_compile_definitions(service_manager_diagnostics PRIVATE
        OSCEAN_HAS_FULL_SERVICES=1
    )
    # target_compile_definitions(test_complete_metadata_processing PRIVATE
    #     OSCEAN_HAS_FULL_SERVICES=1
    # )
    target_compile_definitions(crs_diagnostic_test PRIVATE
        OSCEAN_HAS_FULL_SERVICES=1
    )
endif()

# é“¾æ¥è¯Šæ–­ç¨‹åº
target_link_libraries(service_manager_diagnostics
    workflow_engine_core
    ${SERVICE_LIBRARIES}
    ${CORE_LIBRARIES}
    ${BASE_LIBRARIES}
)

# é“¾æ¥å®Œæ•´å…ƒæ•°æ®å¤„ç†æµ‹è¯•ç¨‹åº
# target_link_libraries(test_complete_metadata_processing
#     workflow_engine_core
#     ${SERVICE_LIBRARIES}
#     ${CORE_LIBRARIES}
#     ${BASE_LIBRARIES}
# )

# é“¾æ¥CRSè¯Šæ–­æµ‹è¯•ç¨‹åº
target_link_libraries(crs_diagnostic_test
    workflow_engine_core
    ${SERVICE_LIBRARIES}
    ${CORE_LIBRARIES}
    ${BASE_LIBRARIES}
)

set_target_properties(service_manager_diagnostics PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

# set_target_properties(test_complete_metadata_processing PROPERTIES
#     CXX_STANDARD 17
#     CXX_STANDARD_REQUIRED ON
# )

set_target_properties(crs_diagnostic_test PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

if(WIN32)
    target_compile_definitions(service_manager_diagnostics PRIVATE
        WIN32_LEAN_AND_MEAN
        NOMINMAX
        _WIN32_WINNT=0x0601
    )
endif()

# ===============================================================================
# ğŸ†• å¢å¼ºæ•°æ®ç®¡ç†å·¥ä½œæµæµ‹è¯•
# ===============================================================================

# åˆ›å»ºå¢å¼ºæ•°æ®ç®¡ç†å·¥ä½œæµæµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
add_executable(test_enhanced_data_management test_enhanced_data_management.cpp)

# è®¾ç½®æµ‹è¯•ç¨‹åºè¾“å‡ºåˆ°ä¸»buildç›®å½•çš„binç›®å½•
set_target_properties(test_enhanced_data_management PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    RUNTIME_OUTPUT_DIRECTORY_DEBUG "${CMAKE_BINARY_DIR}/bin/Debug"
    RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_BINARY_DIR}/bin/Release"
    RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO "${CMAKE_BINARY_DIR}/bin/RelWithDebInfo"
    RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL "${CMAKE_BINARY_DIR}/bin/MinSizeRel"
)

# è®¾ç½®æµ‹è¯•ç¨‹åºçš„åŒ…å«ç›®å½•
target_include_directories(test_enhanced_data_management PRIVATE ${INCLUDE_PATHS})

# è®¾ç½®æµ‹è¯•ç¨‹åºçš„ç¼–è¯‘å®šä¹‰
target_compile_definitions(test_enhanced_data_management PRIVATE
    OSCEAN_NO_BOOST_ASIO_MODULE=1
    # å¯ç”¨Boost.Threadçš„futureæ‰©å±•åŠŸèƒ½
    BOOST_THREAD_PROVIDES_FUTURE=1
    BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION=1
    BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY=1
)

# æ ¹æ®æœåŠ¡å¯ç”¨æ€§è®¾ç½®ç¼–è¯‘å®šä¹‰
if(HAS_FULL_SERVICES)
    target_compile_definitions(test_enhanced_data_management PRIVATE
        OSCEAN_HAS_FULL_SERVICES=1
    )
endif()

if(HAS_ENHANCED_SERVICES)
    target_compile_definitions(test_enhanced_data_management PRIVATE
        OSCEAN_HAS_ENHANCED_SERVICES=1
    )
endif()

if(HAS_INTERPOLATION_SERVICE)
    target_compile_definitions(test_enhanced_data_management PRIVATE
        OSCEAN_HAS_INTERPOLATION_SERVICE=1
    )
endif()

if(HAS_SPATIAL_OPS_SERVICE)
    target_compile_definitions(test_enhanced_data_management PRIVATE
        OSCEAN_HAS_SPATIAL_OPS_SERVICE=1
    )
endif()

if(HAS_OUTPUT_SERVICE)
    target_compile_definitions(test_enhanced_data_management PRIVATE
        OSCEAN_HAS_OUTPUT_SERVICE=1
    )
endif()

if(HAS_CRS_SERVICE)
    target_compile_definitions(test_enhanced_data_management PRIVATE
        OSCEAN_HAS_CRS_SERVICE=1
    )
endif()

# é“¾æ¥å¢å¼ºæµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
target_link_libraries(test_enhanced_data_management
    workflow_engine_data_management
    workflow_engine_core  # æ·»åŠ workflow_engine_coreåº“ä»¥ä½¿ç”¨ServiceManagerImpl
    ${SERVICE_LIBRARIES}  # æ·»åŠ æœåŠ¡åº“ï¼Œç¡®ä¿ç¬¦å·å¯ç”¨
    ${CORE_LIBRARIES}     # æ·»åŠ æ ¸å¿ƒåº“
    ${BASE_LIBRARIES}     # æ·»åŠ åŸºç¡€åº“
)

# æ˜¾å¼é“¾æ¥output_generationï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if(TARGET output_generation)
    target_link_libraries(test_enhanced_data_management output_generation)
    message(STATUS "æ˜¾å¼é“¾æ¥output_generationåˆ°test_enhanced_data_management")
endif()

# æ·»åŠ Boost::logæ”¯æŒï¼ˆoutput_generationéœ€è¦ï¼‰
find_package(Boost REQUIRED COMPONENTS log)
if(Boost_LOG_FOUND)
    target_link_libraries(test_enhanced_data_management Boost::log)
    message(STATUS "æ·»åŠ Boost::logåˆ°test_enhanced_data_management")
endif()

# æ·»åŠ æœ€å°çº¿ç¨‹æ± æµ‹è¯•
add_executable(test_minimal_threadpool test_minimal_threadpool.cpp)
target_link_libraries(test_minimal_threadpool
    common_utilities
    ${Boost_LIBRARIES}
)
target_compile_definitions(test_minimal_threadpool PRIVATE
    OSCEAN_ENABLE_BOOST_ASIO
)

# è®¾ç½®ç›®æ ‡å±æ€§
set_target_properties(test_enhanced_data_management PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

# ===============================================================================
# ğŸ“Š æ„å»ºæ€»ç»“
# ===============================================================================

message(STATUS "=== æ•°æ®ç®¡ç†å·¥ä½œæµæ„å»ºé…ç½®æ€»ç»“ ===")
message(STATUS "âœ… ä¸»åº“: workflow_engine_data_management")
message(STATUS "âœ… åŸºç¡€æµ‹è¯•: test_data_management")
message(STATUS "âœ… å¢å¼ºæµ‹è¯•: test_enhanced_data_management")
message(STATUS "")
message(STATUS "ğŸ“‹ æœåŠ¡æ”¯æŒçŠ¶æ€:")
message(STATUS "  - æ ¸å¿ƒæœåŠ¡: ${HAS_FULL_SERVICES}")
message(STATUS "  - æ‰©å±•æœåŠ¡: ${HAS_ENHANCED_SERVICES}")
message(STATUS "  - æ’å€¼æœåŠ¡: ${HAS_INTERPOLATION_SERVICE}")
message(STATUS "  - ç©ºé—´è®¡ç®—: ${HAS_SPATIAL_OPS_SERVICE}")
message(STATUS "  - è¾“å‡ºæœåŠ¡: ${HAS_OUTPUT_SERVICE}")
message(STATUS "  - CRSæœåŠ¡: ${HAS_CRS_SERVICE}")
message(STATUS "")
message(STATUS "ğŸ¯ è¾“å‡ºç›®å½•: ${CMAKE_BINARY_DIR}/bin")
message(STATUS "============================================")

# ç»Ÿä¸€æœåŠ¡ç®¡ç†æµ‹è¯•
# ==============================================================================

# åˆ é™¤æ—§çš„ã€åˆ†æ•£çš„æµ‹è¯•ç›®æ ‡
# remove_executable(test_enhanced_data_management)

# åˆ›å»ºç»Ÿä¸€æœåŠ¡ç®¡ç†æµ‹è¯•
add_executable(test_unified_service_management test_unified_service_management.cpp)

target_link_libraries(test_unified_service_management
    workflow_engine_data_management
    workflow_engine_core
    ${SERVICE_LIBRARIES}
    ${CORE_LIBRARIES}
    ${BASE_LIBRARIES}
)

target_compile_definitions(test_unified_service_management PRIVATE
    ${BASE_DEFINITIONS}
)

# æ˜¾å¼é“¾æ¥output_generationï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if(TARGET output_generation)
    target_link_libraries(test_unified_service_management output_generation)
    message(STATUS "æ˜¾å¼é“¾æ¥output_generationåˆ°test_unified_service_management")
endif()

# æ·»åŠ Boost::logæ”¯æŒ
if(Boost_LOG_FOUND)
    target_link_libraries(test_unified_service_management Boost::log)
    message(STATUS "æ·»åŠ Boost::logåˆ°test_unified_service_management")
endif()

# å…³é”®ä¿®å¤ï¼šå°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ° build/config ç›®å½•
add_custom_command(
    TARGET test_unified_service_management POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_directory
        "${CMAKE_SOURCE_DIR}/config" # æºç›®å½•
        "${CMAKE_BINARY_DIR}/config" # ç›®æ ‡ç›®å½•
    COMMENT "å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ä¸»æ„å»ºè¾“å‡ºç›®å½•"
)

