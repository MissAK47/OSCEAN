cmake_minimum_required(VERSION 3.16)
project(WorkflowEngine VERSION 3.0.0 LANGUAGES CXX)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# è®¾ç½®åŒ…å«ç›®å½•
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../core_service_interfaces/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../common_utilities/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../core_services_impl/metadata_service/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../core_services_impl/data_access_service/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../core_services_impl/crs_service/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../core_services_impl/spatial_ops_service/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../core_services_impl/interpolation_service/include
)

# æŸ¥æ‰¾æ‰€éœ€çš„åº“
find_package(Threads REQUIRED)
find_package(Boost REQUIRED COMPONENTS thread system container)

# æŸ¥æ‰¾SQLite3ä»¥æ”¯æŒå…ƒæ•°æ®æœåŠ¡
find_package(SQLite3 QUIET)
if(NOT SQLite3_FOUND)
    find_package(unofficial-sqlite3 CONFIG QUIET)
    if(unofficial-sqlite3_FOUND AND NOT TARGET SQLite::SQLite3)
        if(TARGET unofficial::sqlite3::sqlite3)
            add_library(SQLite::SQLite3 ALIAS unofficial::sqlite3::sqlite3)
        endif()
    endif()
endif()

# é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨common_utilitiesç›®æ ‡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ 
if(NOT TARGET common_utilities)
    # æ·»åŠ common_utilitieså­ç›®å½•
    add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/../common_utilities common_utilities_build)
endif()

# æºæ–‡ä»¶ - æ ¸å¿ƒæ¡†æ¶æºæ–‡ä»¶
set(WORKFLOW_ENGINE_SOURCES
    src/workflow_engine.cpp
    # src/workflow_registry.cpp        # ğŸ†• å·¥ä½œæµæ³¨å†Œè¡¨ - æš‚æ—¶ç§»é™¤ï¼Œè§£å†³å‘½åç©ºé—´å†²çª
    proxies/src/core_service_proxy.cpp
    # src/workflow_types.cpp # æš‚æ—¶ç§»é™¤ï¼Œç±»å‹å®šä¹‰åº”åœ¨å¤´æ–‡ä»¶ä¸­
    # src/workflow_base.cpp    # æš‚æ—¶ç§»é™¤ï¼Œå¾…ç¡®è®¤å®ç°

    # ğŸ†• æ·»åŠ æœåŠ¡ç®¡ç†å™¨å®ç°
    src/service_management/service_manager_impl.cpp
)

# åˆ›å»ºé™æ€åº“
add_library(workflow_engine_core STATIC "") # Initially empty, sources added below

# é“¾æ¥åº“
target_link_libraries(workflow_engine_core PUBLIC
    # External dependencies
    Boost::headers
    Boost::thread
    Boost::system
    Boost::container

    # Internal project dependencies
    common_utilities
    core_service_interfaces
)

# ğŸ†• æ·»åŠ æ ¸å¿ƒæœåŠ¡å®ç°çš„æ¡ä»¶é“¾æ¥ - ä¿®å¤SpatialOpsServiceFactoryé“¾æ¥é”™è¯¯
# æ£€æŸ¥å„æœåŠ¡ç›®æ ‡æ˜¯å¦å­˜åœ¨å¹¶è¿›è¡Œé“¾æ¥
if(TARGET data_access_service)
    target_link_libraries(workflow_engine_core PRIVATE data_access_service)
    message(STATUS "workflow_engine_core: å·²é“¾æ¥ data_access_service")
endif()

if(TARGET metadata_service)
    target_link_libraries(workflow_engine_core PRIVATE metadata_service)
    message(STATUS "workflow_engine_core: å·²é“¾æ¥ metadata_service")
endif()

if(TARGET crs_service)
    target_link_libraries(workflow_engine_core PRIVATE crs_service)
    message(STATUS "workflow_engine_core: å·²é“¾æ¥ crs_service")
endif()

if(TARGET spatial_ops_service)
    target_link_libraries(workflow_engine_core PRIVATE spatial_ops_service)
    message(STATUS "workflow_engine_core: å·²é“¾æ¥ spatial_ops_service")
endif()

if(TARGET interpolation_service)
    target_link_libraries(workflow_engine_core PRIVATE interpolation_service)
    message(STATUS "workflow_engine_core: å·²é“¾æ¥ interpolation_service")
endif()

if(TARGET output_generation)
    target_link_libraries(workflow_engine_core PRIVATE output_generation)
    message(STATUS "workflow_engine_core: å·²é“¾æ¥ output_generation")
endif()

# å¦‚æœæ‰¾ä¸åˆ°æœåŠ¡ç›®æ ‡ï¼Œå°è¯•ç›´æ¥æ·»åŠ ä¾èµ–é¡¹ç›®
if(NOT TARGET spatial_ops_service)
    message(STATUS "workflow_engine_core: æœªæ‰¾åˆ° spatial_ops_service ç›®æ ‡ï¼Œå°è¯•æ·»åŠ ä¾èµ–é¡¹ç›®")
    # é¦–å…ˆç¡®ä¿æ„å»ºäº†spatial_ops_service
    if(NOT TARGET spatial_ops_service)
        add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/../core_services_impl/spatial_ops_service core_services_impl/spatial_ops_service)
    endif()
    if(TARGET spatial_ops_service)
        target_link_libraries(workflow_engine_core PRIVATE spatial_ops_service)
        message(STATUS "workflow_engine_core: æˆåŠŸé“¾æ¥ spatial_ops_service")
    endif()
endif()

# Add compile definitions for the library
if(WIN32)
    target_compile_definitions(workflow_engine_core PRIVATE BOOST_USE_WINDOWS_H)
endif()

# åŒ…å«ç›®å½•
target_include_directories(workflow_engine_core PUBLIC
    # Current public interface - ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
    
    # Add proxies include directory - ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/proxies/include>

    # Inherit include directories from dependencies
    $<TARGET_PROPERTY:common_utilities,INTERFACE_INCLUDE_DIRECTORIES>
    $<TARGET_PROPERTY:core_service_interfaces,INTERFACE_INCLUDE_DIRECTORIES>
)

# --- æš‚æ—¶æ³¨é‡Šæ‰æ‰€æœ‰æµ‹è¯•ç›®æ ‡ï¼Œç›´åˆ°æ ¸å¿ƒåº“å¯ä»¥ç¼–è¯‘ ---
# add_executable(workflow_test_existing tests/test_workflow_functionality.cpp)
# target_link_libraries(workflow_test_existing 
#     workflow_engine_core
#     Threads::Threads
#     Boost::thread
# )
# 
# add_executable(workflow_integration_test tests/test_integration_full.cpp)
# target_link_libraries(workflow_integration_test 
#     workflow_engine_core
#     Threads::Threads
#     Boost::thread
# )
# 
# add_executable(workflow_integration_with_services tests/test_integration_with_services.cpp)
# target_link_libraries(workflow_integration_with_services 
#     workflow_engine_core
#     data_access_service
#     crs_service
#     Threads::Threads
#     Boost::thread
# )
# 
# add_executable(workflow_complete_integration tests/test_complete_integration.cpp)
# target_link_libraries(workflow_complete_integration 
#     workflow_engine_core
#     data_access_service
#     crs_service
#     metadata_service
#     Threads::Threads
#     Boost::thread
# )
# ---------------------------------------------

# --- ğŸ†• å·¥ä½œæµæ¨¡å—åŒ–æ¶æ„ ---
# å„å·¥ä½œæµä½œä¸ºç‹¬ç«‹çš„å¯é€‰ç»„ä»¶ï¼Œä¸å¼ºåˆ¶é“¾æ¥åˆ°core

# 1. æ•°æ®ç®¡ç†å·¥ä½œæµï¼ˆç‹¬ç«‹ï¼‰
add_subdirectory(data_management)

# 2. æ•°æ®å¤„ç†å·¥ä½œæµï¼ˆç‹¬ç«‹ï¼‰
add_subdirectory(data_workflow)

# 3. æœªæ¥çš„å…¶ä»–å·¥ä½œæµå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
# add_subdirectory(spatial_analysis)   # ç©ºé—´åˆ†æå·¥ä½œæµ
# add_subdirectory(time_series)        # æ—¶é—´åºåˆ—å·¥ä½œæµ  
# add_subdirectory(multi_fusion)       # å¤šæºèåˆå·¥ä½œæµ

# ğŸ”§ æ ¸å¿ƒæ¡†æ¶ä¸å†è‡ªåŠ¨é“¾æ¥å…·ä½“å·¥ä½œæµ
# è®©ç”¨æˆ·å’ŒæœåŠ¡å±‚æŒ‰éœ€é€‰æ‹©å’Œé“¾æ¥å·¥ä½œæµ
# target_link_libraries(workflow_engine_core PUBLIC workflow_engine_data_management)  # ç§»é™¤è‡ªåŠ¨é“¾æ¥

# Add the main workflow engine sources to the core library
target_sources(workflow_engine_core PRIVATE
    ${WORKFLOW_ENGINE_SOURCES}
)
# ------------------------------------

# è®¾ç½®è¾“å‡ºç›®å½•
set_target_properties(workflow_engine_core PROPERTIES
    ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib
)

# --- æš‚æ—¶æ³¨é‡Šæ‰æ‰€æœ‰æµ‹è¯•ç›®æ ‡çš„è¾“å‡ºç›®å½•è®¾ç½® ---
# set_target_properties(workflow_test_existing PROPERTIES
#     RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
# )
# 
# set_target_properties(workflow_integration_test PROPERTIES
#     RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
# )
# 
# set_target_properties(workflow_integration_with_services PROPERTIES
#     RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
# )
# 
# set_target_properties(workflow_complete_integration PROPERTIES
#     RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
# )

# === æ·»åŠ æµ‹è¯•ç›®å½• ===
# ç¡®ä¿æµ‹è¯•ç›®å½•æ€»æ˜¯è¢«æ·»åŠ ï¼Œä¾¿äºç‹¬ç«‹æµ‹è¯•
if(BUILD_TESTING)
    enable_testing()
    add_subdirectory(tests)
endif()

# ğŸ”§ æ ¸å¿ƒä¿®å¤ï¼šå°† workflow_engine_core æ·»åŠ åˆ°å¯¼å‡ºé›†
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å†²çªé—®é¢˜
# install(TARGETS workflow_engine_core
#     EXPORT WorkflowEngineTargets
#     LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
#     ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
#     RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
#     INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
# )

# --- å®‰è£…å’Œå¯¼å‡º ---
# ç¡®ä¿æ‰€æœ‰å…¬å…±å¤´æ–‡ä»¶éƒ½åŒ…å«åœ¨å†…
install(DIRECTORY include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

# åˆ›å»ºå¹¶å®‰è£…CMakeé…ç½®æ–‡ä»¶ï¼Œä»¥ä¾¿å…¶ä»–é¡¹ç›®å¯ä»¥ä½¿ç”¨find_package(workflow_engine)
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å†²çªé—®é¢˜
# install(EXPORT WorkflowEngineTargets
#     FILE WorkflowEngineTargets.cmake
#     NAMESPACE oscean::
#     DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/workflow_engine
# )

# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å†²çªé—®é¢˜
# include(CMakePackageConfigHelpers)
# configure_package_config_file(
#     ${CMAKE_CURRENT_SOURCE_DIR}/cmake/WorkflowEngineConfig.cmake.in
#     ${CMAKE_CURRENT_BINARY_DIR}/WorkflowEngineConfig.cmake
#     INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/workflow_engine
#     PATH_VARS CMAKE_INSTALL_LIBDIR CMAKE_INSTALL_INCLUDEDIR
# )

# åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å†²çªé—®é¢˜
# write_basic_package_version_file(
#     "${CMAKE_CURRENT_BINARY_DIR}/WorkflowEngineConfigVersion.cmake"
#     VERSION "1.0.0"
#     COMPATIBILITY SameMajorVersion
# )

# å®‰è£…é…ç½®æ–‡ä»¶å’Œç‰ˆæœ¬æ–‡ä»¶
# æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè§£å†³å¯¼å‡ºç›®æ ‡å†²çªé—®é¢˜
# install(FILES
#     "${CMAKE_CURRENT_BINARY_DIR}/WorkflowEngineConfig.cmake"
#     "${CMAKE_CURRENT_BINARY_DIR}/WorkflowEngineConfigVersion.cmake"
#     DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/workflow_engine"
# )