# å…ƒæ•°æ®æœåŠ¡çœŸå®åŠŸèƒ½æµ‹è¯•
cmake_minimum_required(VERSION 3.20)

# å¦‚æœä¸æ˜¯å­é¡¹ç›®ï¼Œè®¾ç½®é¡¹ç›®åç§°
if(CMAKE_SOURCE_DIR STREQUAL CMAKE_CURRENT_SOURCE_DIR)
    project(metadata_service_tests LANGUAGES CXX)
endif()

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# === ğŸ” æŸ¥æ‰¾ä¾èµ–åŒ… ===

# Google Test
find_package(GTest REQUIRED)

# Boostï¼ˆç”¨äºå¼‚æ­¥æ“ä½œï¼‰
find_package(Boost REQUIRED COMPONENTS 
    system 
    thread 
    filesystem
    chrono
)

# æ·»åŠ ç¼ºå°‘çš„ä¾èµ–åŒ…
find_package(spdlog CONFIG REQUIRED)
find_package(yaml-cpp CONFIG REQUIRED)

# ä½¿ç”¨ä¸é¡¶å±‚ä¸€è‡´çš„SQLite3æŸ¥æ‰¾é€»è¾‘
if(NOT TARGET SQLite::SQLite3)
    message(STATUS "[metadata_service/tests] æ­£åœ¨æŸ¥æ‰¾ SQLite3...")
    find_package(SQLite3 QUIET)
    if(NOT SQLite3_FOUND)
        message(STATUS "[metadata_service/tests] æ ‡å‡† SQLite3 æœªæ‰¾åˆ°ï¼Œå°è¯• vcpkg çš„ unofficial-sqlite3...")
        find_package(unofficial-sqlite3 CONFIG REQUIRED)
        message(STATUS "[metadata_service/tests] æ‰¾åˆ° unofficial-sqlite3")
        # åˆ›å»º SQLite::SQLite3 åˆ«åæŒ‡å‘ unofficial::sqlite3::sqlite3
        add_library(SQLite::SQLite3 ALIAS unofficial::sqlite3::sqlite3)
    endif()
else()
    message(STATUS "[metadata_service/tests] SQLite::SQLite3 target already available")
endif()

# === ğŸ“ åŒ…å«ç›®å½• ===

# å…ƒæ•°æ®æœåŠ¡ç›¸å…³å¤´æ–‡ä»¶
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/../include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../core_service_interfaces/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../common_utilities/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../core_services_impl/data_access_service/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../src
)

# === ğŸ§ª å®šä¹‰çœŸå®åŠŸèƒ½æµ‹è¯• ===

# ğŸ”§ æ·»åŠ é…ç½®æ–‡ä»¶åŠ è½½çœŸå®åŠŸèƒ½æµ‹è¯•
add_executable(config_loading_test
    unit/config_loading_test.cpp
)

# æ·»åŠ MSVCç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹
if(MSVC)
    target_compile_options(config_loading_test PRIVATE
        /EHsc           # å¼‚å¸¸å¤„ç†
        /W3             # è­¦å‘Šçº§åˆ«
        /utf-8          # UTF-8ç¼–ç æ”¯æŒ
        /wd4819         # å¿½ç•¥ç¼–ç è­¦å‘Š
        /wd4996         # å¿½ç•¥å¼ƒç”¨è­¦å‘Š
        /bigobj         # å¤§å¯¹è±¡æ–‡ä»¶æ”¯æŒ
    )
    
    # æ·»åŠ é¢„å¤„ç†å™¨å®šä¹‰
    target_compile_definitions(config_loading_test PRIVATE
        _CRT_SECURE_NO_WARNINGS
        UNICODE
        _UNICODE
        NOMINMAX
        BOOST_ALL_NO_LIB
        BOOST_THREAD_USE_LIB
    )
else()
    # éMSVCç¼–è¯‘å™¨çš„å®šä¹‰
    target_compile_definitions(config_loading_test PRIVATE
        BOOST_ALL_NO_LIB
        BOOST_THREAD_USE_LIB
    )
endif()

# é“¾æ¥åº“
target_link_libraries(config_loading_test
    GTest::gtest
    GTest::gtest_main
    spdlog::spdlog
    yaml-cpp::yaml-cpp
    metadata_service
    common_utilities
    core_service_interfaces
)

# ğŸ”§ æ·»åŠ çœŸå®é…ç½®æ–‡ä»¶éªŒè¯æµ‹è¯•
add_executable(real_config_verification_test
    unit/real_config_verification_test.cpp
)

# æ·»åŠ MSVCç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹
if(MSVC)
    target_compile_options(real_config_verification_test PRIVATE
        /EHsc           # å¼‚å¸¸å¤„ç†
        /W3             # è­¦å‘Šçº§åˆ«
        /utf-8          # UTF-8ç¼–ç æ”¯æŒ
        /wd4819         # å¿½ç•¥ç¼–ç è­¦å‘Š
        /wd4996         # å¿½ç•¥å¼ƒç”¨è­¦å‘Š
        /bigobj         # å¤§å¯¹è±¡æ–‡ä»¶æ”¯æŒ
    )
    
    # æ·»åŠ é¢„å¤„ç†å™¨å®šä¹‰
    target_compile_definitions(real_config_verification_test PRIVATE
        _CRT_SECURE_NO_WARNINGS
        UNICODE
        _UNICODE
        NOMINMAX
        BOOST_ALL_NO_LIB
        BOOST_THREAD_USE_LIB
    )
else()
    # éMSVCç¼–è¯‘å™¨çš„å®šä¹‰
    target_compile_definitions(real_config_verification_test PRIVATE
        BOOST_ALL_NO_LIB
        BOOST_THREAD_USE_LIB
    )
endif()

# é“¾æ¥åº“
target_link_libraries(real_config_verification_test
    GTest::gtest
    GTest::gtest_main
    spdlog::spdlog
    yaml-cpp::yaml-cpp
    metadata_service
    common_utilities
    core_service_interfaces
)

# ğŸ”§ æ·»åŠ çœŸå®NetCDFå…ƒæ•°æ®æµ‹è¯•
add_executable(real_netcdf_metadata_test
    unit/real_netcdf_metadata_test.cpp
)

# æ·»åŠ MSVCç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹
if(MSVC)
    target_compile_options(real_netcdf_metadata_test PRIVATE
        /EHsc           # å¼‚å¸¸å¤„ç†
        /W3             # è­¦å‘Šçº§åˆ«
        /utf-8          # UTF-8ç¼–ç æ”¯æŒ
        /wd4819         # å¿½ç•¥ç¼–ç è­¦å‘Š
        /wd4996         # å¿½ç•¥å¼ƒç”¨è­¦å‘Š
        /bigobj         # å¤§å¯¹è±¡æ–‡ä»¶æ”¯æŒ
    )
    
    # æ·»åŠ é¢„å¤„ç†å™¨å®šä¹‰
    target_compile_definitions(real_netcdf_metadata_test PRIVATE
        _CRT_SECURE_NO_WARNINGS
        UNICODE
        _UNICODE
        NOMINMAX
        BOOST_ALL_NO_LIB
        BOOST_THREAD_USE_LIB
    )
else()
    # éMSVCç¼–è¯‘å™¨çš„å®šä¹‰
    target_compile_definitions(real_netcdf_metadata_test PRIVATE
        BOOST_ALL_NO_LIB
        BOOST_THREAD_USE_LIB
    )
endif()

# é“¾æ¥åº“
target_link_libraries(real_netcdf_metadata_test
    metadata_service
    core_service_interfaces
    common_utilities
    GTest::gtest
    GTest::gtest_main
    Boost::system
    Boost::thread
    Boost::filesystem
    Boost::chrono
    spdlog::spdlog
)

# === ğŸ”§ æµ‹è¯•é…ç½® ===

# å¯ç”¨æµ‹è¯•
enable_testing()

# æ·»åŠ é…ç½®æ–‡ä»¶åŠ è½½æµ‹è¯•
add_test(
    NAME ConfigLoadingTests
    COMMAND config_loading_test
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
)

# æ·»åŠ çœŸå®é…ç½®éªŒè¯æµ‹è¯•
add_test(
    NAME RealConfigVerificationTests
    COMMAND real_config_verification_test
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
)

# æ·»åŠ çœŸå®æ•°æ®å¤„ç†æµ‹è¯•
add_test(
    NAME RealDataProcessingTests
    COMMAND real_netcdf_metadata_test
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
)

# è®¾ç½®æµ‹è¯•è¶…æ—¶å’Œæ ‡ç­¾
set_tests_properties(ConfigLoadingTests PROPERTIES 
    TIMEOUT 300
    LABELS "config;functional"
)

set_tests_properties(RealConfigVerificationTests PROPERTIES 
    TIMEOUT 300
    LABELS "config;real_files;verification"
)

set_tests_properties(RealDataProcessingTests PROPERTIES 
    TIMEOUT 600
    LABELS "data_processing;real_files;functional"
)

# === ğŸ“ æµ‹è¯•æŠ¥å‘Š ===

# åˆ›å»ºæµ‹è¯•è¾“å‡ºç›®å½•
file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/test_reports)

# è®¾ç½®æµ‹è¯•è¾“å‡ºæ–‡ä»¶
set_tests_properties(ConfigLoadingTests PROPERTIES
    ENVIRONMENT "GTEST_OUTPUT=xml:${CMAKE_CURRENT_BINARY_DIR}/test_reports/config_loading_test.xml"
)

set_tests_properties(RealConfigVerificationTests PROPERTIES
    ENVIRONMENT "GTEST_OUTPUT=xml:${CMAKE_CURRENT_BINARY_DIR}/test_reports/real_config_verification_test.xml"
)

set_tests_properties(RealDataProcessingTests PROPERTIES
    ENVIRONMENT "GTEST_OUTPUT=xml:${CMAKE_CURRENT_BINARY_DIR}/test_reports/real_netcdf_metadata_test.xml"
)

# === ğŸ¨ è‡ªå®šä¹‰æµ‹è¯•ç›®æ ‡ ===

# å¿«é€Ÿæµ‹è¯•ï¼ˆé…ç½®æ–‡ä»¶æµ‹è¯•ï¼‰
add_custom_target(metadata_quick_test
    COMMAND ${CMAKE_CTEST_COMMAND} -L "config" --output-on-failure
    DEPENDS config_loading_test real_config_verification_test
    COMMENT "è¿è¡Œé…ç½®æ–‡ä»¶ç›¸å…³æµ‹è¯•"
)

# å®Œæ•´æµ‹è¯•ï¼ˆæ‰€æœ‰çœŸå®åŠŸèƒ½æµ‹è¯•ï¼‰
add_custom_target(metadata_full_test
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure
    DEPENDS config_loading_test real_config_verification_test real_netcdf_metadata_test
    COMMENT "è¿è¡Œæ‰€æœ‰çœŸå®åŠŸèƒ½æµ‹è¯•"
)

# æ¸…ç†æµ‹è¯•æ•°æ®
add_custom_target(clean_test_data
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_CURRENT_BINARY_DIR}/test_data
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_CURRENT_BINARY_DIR}/test_reports
    COMMENT "æ¸…ç†æµ‹è¯•æ•°æ®å’ŒæŠ¥å‘Š"
)

# æ·»åŠ å·¥å…·ç›®å½•
add_subdirectory(utils)

# æµ‹è¯•ç¨‹åºé…ç½®
if(BUILD_TESTING)
    message(STATUS "ğŸ“‹ å…ƒæ•°æ®æœåŠ¡çœŸå®åŠŸèƒ½æµ‹è¯•é…ç½®å®Œæˆ")
    message(STATUS "   - é…ç½®åŠ è½½æµ‹è¯•: config_loading_test")
    message(STATUS "   - é…ç½®éªŒè¯æµ‹è¯•: real_config_verification_test")
    message(STATUS "   - æ•°æ®å¤„ç†æµ‹è¯•: real_netcdf_metadata_test")
endif()

# é…ç½®éªŒè¯æµ‹è¯•
add_executable(configuration_validation_test
    configuration_validation_test.cpp
)

target_link_libraries(configuration_validation_test
    PRIVATE
        metadata_service
        common_utilities
        core_service_interfaces
        GTest::gtest
        GTest::gtest_main
        SQLite::SQLite3
        Boost::thread
        Boost::system
        Boost::filesystem
        spdlog::spdlog
)

target_include_directories(configuration_validation_test
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/../include
        ${CMAKE_CURRENT_SOURCE_DIR}/../src
        ${CMAKE_SOURCE_DIR}/core_service_interfaces/include
        ${CMAKE_SOURCE_DIR}/common_utilities/include
)

# è®¾ç½®C++æ ‡å‡†
target_compile_features(configuration_validation_test PRIVATE cxx_std_17)

# æ·»åŠ boost::futureæ‰€éœ€çš„å®å®šä¹‰
target_compile_definitions(configuration_validation_test PRIVATE
    BOOST_THREAD_PROVIDES_FUTURE
    BOOST_THREAD_PROVIDES_FUTURE_CONTINUATION
    BOOST_THREAD_PROVIDES_FUTURE_WHEN_ALL_WHEN_ANY
    BOOST_THREAD_PROVIDES_FUTURE_ASYNC
)

# æ·»åŠ MSVCç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹
if(MSVC)
    target_compile_options(configuration_validation_test PRIVATE
        /utf-8
        /wd4996
        /wd4251
        /FS
        /EHsc
    )
    
    target_compile_definitions(configuration_validation_test PRIVATE
        _CRT_SECURE_NO_WARNINGS
        _WIN32_WINNT=0x0A00
        NOMINMAX
        WIN32_LEAN_AND_MEAN
    )
endif()

# è®¾ç½®è¾“å‡ºç›®å½•
set_target_properties(configuration_validation_test PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin/tests"
)

# æ·»åŠ åˆ°æµ‹è¯•
add_test(NAME ConfigurationValidationTest COMMAND configuration_validation_test)

message(STATUS "[metadata_service] é…ç½®éªŒè¯æµ‹è¯•å·²æ·»åŠ ") 